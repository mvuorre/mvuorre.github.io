<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Matti&#39;s homepage</title>
<link>https://vuorre.netlify.app/blog.html</link>
<atom:link href="https://vuorre.netlify.app/blog.xml" rel="self" type="application/rss+xml"/>
<description>Notes on psychology, statistics, and R, sometimes</description>
<image>
<url>https://vuorre.netlify.app/favicon.png</url>
<title>Matti&#39;s homepage</title>
<link>https://vuorre.netlify.app/blog.html</link>
<height>167</height>
<width>144</width>
</image>
<generator>quarto-1.2.269</generator>
<lastBuildDate>Wed, 30 Nov 2022 00:00:00 GMT</lastBuildDate>
<item>
  <title>Tidymultiverse</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/parallel-multiverse/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Work in progress
</div>
</div>
<div class="callout-body-container callout-body">
<p>This entry is an unfinished draft.</p>
</div>
</div>
<p>The results of statistical analyses often depend on analysts‚Äô (sometimes arbitrary) decisions, such as which covariates to model or what subsets of data to analyse. Multiverse (sometimes called specification curve) analysis is a method whereby the analysts don‚Äôt only conduct and report the results from one model, but instead conduct all the relevant and plausible analyses and report all the results <span class="citation" data-cites="simonsohnSpecificationCurveAnalysis2020 steegenIncreasingTransparencyMultiverse2016">(Simonsohn, Simmons, and Nelson 2020; Steegen et al. 2016)</span>.</p>
<p>For example, <span class="citation" data-cites="orbenAssociationAdolescentWellbeing2019">Orben and Przybylski (2019)</span> showed, through analyzing the same datasets in thousands of different ways, that conclusions regarding the association between the psychological well-being of adolescents and their digital technology use critically depend on (mostly) arbitrary decisions in how and which data are analysed (Figure&nbsp;1).</p>
<p>This blog entry is about the technical aspects of conducting multiverse analyses in R. I have briefly examined the landscape of R packages that facilitate multiverse analyses, and found that none suited my needs. In this entry, I outline a general and flexible <a href="https://www.tidyverse.org/">tidyverse</a>-centric multiverse analysis pipeline. I eschew using external packages to maximize flexibility and speed (parallel processing).</p>
<div class="cell" data-hash="index_cache/html/fig-op3_8c7e2c07d79e14f6ec7bc1622363ce63">
<div class="cell-output-display">
<div id="fig-op3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/parallel-multiverse/images/orben-przybylski-2019-fig3.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Figure 3 from <span class="citation" data-cites="orbenAssociationAdolescentWellbeing2019">Orben and Przybylski (2019)</span>. Reproduced 100% without permission, but I don‚Äôt think Amy or Andy would mind.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Currently, I am aware of three R packages for conducting multiverse analyses. The <a href="https://github.com/MUCollective/multiverse/">multiverse</a> package provides extensive functionality for conducting and reporting multiverse analyses, including a ‚Äúdomain specific language‚Äù for analyses and reporting. However, while powerful, the package seems somewhat complicated (for the use cases that I have in mind). Frankly, after briefly reviewing the documentation, I don‚Äôt know how to use it (but it seems cool!) <a href="https://github.com/mverseanalysis/mverse/">mverse</a> aims to make the multiverse package easier to use. I haven‚Äôt explored it much but it only seems to offer <code>lm()</code> and <code>glm()</code> models. <a href="https://github.com/masurp/specr">specr</a> (maybe most relevant for my use cases in psychology) provides a much simpler set of functions (with less flexibility, however).</p>
<p>Another downside of these packages is that they don‚Äôt provide options for parallel computations. Parallelization is quite important because multiverse analyses can include (tens, hundreds) of thousands of analyses and can therefore take a long time to complete. I started a pull request that aimed to add that functionality to specr, but along the way found that it wasn‚Äôt so easy to implement with the current specr syntax and codebase, and my limited R skills.</p>
<p>While thinking about how best to contribute to specr, I realized that multiverse analyses don‚Äôt necessarily need extra functions, but can be easily implemented in familiar data analysis pipelines (<a href="https://dplyr.tidyverse.org/">dplyr</a> and <code>%&gt;%</code>; depending on how familiar you are with the tidyverse). This entry is part of my journey of trying to figure out how to flexibly conduct multiverse analyses in parallel in R, and demonstrates a flexible syntax for parallelizing multiverse analyses with <code>%&gt;%</code>lines.</p>
<p>I am not an expert in parallel processing by any means, so would love to know if you have any feedback on how I‚Äôve implemented it below! Let me know in the comments <span class="emoji" data-emoji="smile">üòÑ</span></p>
</section>
<section id="example-multiverse-analysis" class="level1 page-columns page-full">
<h1>Example multiverse analysis</h1>
<p>Let‚Äôs start with a simple toy example with two outcomes, two predictors, and two covariates, and no prior reason to choose between specifications. That is, we think that <code>y1</code> and <code>y2</code> are equally likely to represent our outcome construct of interest, <code>x1</code> and <code>x2</code> are equally likely to represent the predictor construct, and we can‚Äôt choose if or how to include the covariates <code>c1</code> and <code>c2</code> in the model. Let‚Äôs load the required libraries and show the example data (Table&nbsp;1):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(kableExtra)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(ggthemes)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(tictoc)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">theme_set</span>(</span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;">theme_few</span>(</span>
<span id="cb1-9">    <span class="at" style="color: #657422;">base_family =</span> <span class="st" style="color: #20794D;">"Comic Sans MS"</span>, </span>
<span id="cb1-10">    <span class="at" style="color: #657422;">base_size =</span> <span class="dv" style="color: #AD0000;">12</span></span>
<span id="cb1-11">  )</span>
<span id="cb1-12">)</span>
<span id="cb1-13"></span>
<span id="cb1-14">k2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(x) {</span>
<span id="cb1-15">  x <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-16">    <span class="fu" style="color: #4758AB;">kbl</span>(<span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-17">    <span class="fu" style="color: #4758AB;">kable_classic_2</span>(<span class="at" style="color: #657422;">html_font =</span> <span class="st" style="color: #20794D;">"Arial"</span>, <span class="at" style="color: #657422;">lightable_options =</span> <span class="st" style="color: #20794D;">"striped"</span>, <span class="at" style="color: #657422;">full_width =</span> <span class="cn" style="color: #8f5902;">FALSE</span>)</span>
<span id="cb1-18">}</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;"># Data generation</span></span>
<span id="cb1-21">generate_data <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(<span class="at" style="color: #657422;">seed =</span> <span class="cn" style="color: #8f5902;">NA</span>, <span class="at" style="color: #657422;">n =</span> <span class="fl" style="color: #AD0000;">1e5</span>) {</span>
<span id="cb1-22">  <span class="cf" style="color: #003B4F;">if</span> (<span class="sc" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;">is.na</span>(seed)) <span class="fu" style="color: #4758AB;">set.seed</span>(seed)</span>
<span id="cb1-23">  dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb1-24">    <span class="at" style="color: #657422;">x1 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n),</span>
<span id="cb1-25">    <span class="at" style="color: #657422;">x2 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n),</span>
<span id="cb1-26">    <span class="at" style="color: #657422;">y1 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n) <span class="sc" style="color: #5E5E5E;">+</span> x1<span class="sc" style="color: #5E5E5E;">*</span>.<span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb1-27">    <span class="at" style="color: #657422;">y2 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n) <span class="sc" style="color: #5E5E5E;">+</span> x1<span class="sc" style="color: #5E5E5E;">*</span>.<span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb1-28">    <span class="at" style="color: #657422;">c1 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n) <span class="sc" style="color: #5E5E5E;">+</span> x1<span class="sc" style="color: #5E5E5E;">*</span>.<span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb1-29">    <span class="at" style="color: #657422;">c2 =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(n),</span>
<span id="cb1-30">    <span class="at" style="color: #657422;">group =</span> <span class="fu" style="color: #4758AB;">sample</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"a"</span>, <span class="st" style="color: #20794D;">"b"</span>, <span class="st" style="color: #20794D;">"c"</span>, <span class="st" style="color: #20794D;">"d"</span>), n, <span class="at" style="color: #657422;">replace =</span> <span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb1-31">  )</span>
<span id="cb1-32">}</span>
<span id="cb1-33">dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">generate_data</span>(<span class="dv" style="color: #AD0000;">9</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/tbl-data_81ef40ee3969285b1a2f2aa6103198c2">
<div class="cell-output-display">
<div id="tbl-data" class="anchored">

<table class=" lightable-classic-2 lightable-striped" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;1:  Example data (n = 100,000; 5.3 Mb on disk) </caption>
 <thead>
  <tr>
   <th style="text-align:right;"> x1 </th>
   <th style="text-align:right;"> x2 </th>
   <th style="text-align:right;"> y1 </th>
   <th style="text-align:right;"> y2 </th>
   <th style="text-align:right;"> c1 </th>
   <th style="text-align:right;"> c2 </th>
   <th style="text-align:left;"> group </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> -0.77 </td>
   <td style="text-align:right;"> 1.10 </td>
   <td style="text-align:right;"> -0.36 </td>
   <td style="text-align:right;"> -1.23 </td>
   <td style="text-align:right;"> 0.78 </td>
   <td style="text-align:right;"> -0.77 </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.82 </td>
   <td style="text-align:right;"> -1.68 </td>
   <td style="text-align:right;"> -0.50 </td>
   <td style="text-align:right;"> -0.79 </td>
   <td style="text-align:right;"> -1.08 </td>
   <td style="text-align:right;"> -0.81 </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.14 </td>
   <td style="text-align:right;"> -1.89 </td>
   <td style="text-align:right;"> -0.67 </td>
   <td style="text-align:right;"> 0.71 </td>
   <td style="text-align:right;"> -0.89 </td>
   <td style="text-align:right;"> -0.66 </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.28 </td>
   <td style="text-align:right;"> -0.98 </td>
   <td style="text-align:right;"> 0.68 </td>
   <td style="text-align:right;"> -1.40 </td>
   <td style="text-align:right;"> 1.24 </td>
   <td style="text-align:right;"> -0.25 </td>
   <td style="text-align:left;"> c </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.44 </td>
   <td style="text-align:right;"> -0.10 </td>
   <td style="text-align:right;"> 0.83 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> -0.78 </td>
   <td style="text-align:right;"> -0.45 </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -1.19 </td>
   <td style="text-align:right;"> -0.54 </td>
   <td style="text-align:right;"> -0.38 </td>
   <td style="text-align:right;"> 2.10 </td>
   <td style="text-align:right;"> 1.42 </td>
   <td style="text-align:right;"> 1.11 </td>
   <td style="text-align:left;"> b </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can specify a fully crossed multiverse analysis over outcomes, predictors, and covariates, easily with specr. Also, to make the example a bit more interesting for later examples, I‚Äôll estimate the model using two functions (<code>lm()</code> and <code>glm()</code> which in this case give the same results), and will time the function call using tictoc. Table&nbsp;2 shows the first few rows of the results.</p>
<div class="cell" data-hash="index_cache/html/specr_b0f58f39187fbb67b7dcbb5e8e31587f">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">library</span>(specr)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;">tic</span>()</span>
<span id="cb2-3">results_specr <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">run_specs</span>(</span>
<span id="cb2-4">  <span class="at" style="color: #657422;">df =</span> dat, </span>
<span id="cb2-5">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1"</span>, <span class="st" style="color: #20794D;">"y2"</span>), </span>
<span id="cb2-6">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>), </span>
<span id="cb2-7">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>), </span>
<span id="cb2-8">  <span class="at" style="color: #657422;">controls =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"c1"</span>, <span class="st" style="color: #20794D;">"c2"</span>), </span>
<span id="cb2-9">  <span class="at" style="color: #657422;">subsets =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">group =</span> <span class="fu" style="color: #4758AB;">unique</span>(dat<span class="sc" style="color: #5E5E5E;">$</span>group))</span>
<span id="cb2-10">)</span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;">toc</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>28.683 sec elapsed</code></pre>
</div>
</div>
<div class="cell" data-hash="index_cache/html/tbl-specr_44b0265afaa1b420f782ec9a52605473">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">results_specr <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">head</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb4-3">  .[,<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">10</span>] <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;">kbl</span>(</span>
<span id="cb4-5">    <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb4-6">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;">kable_classic_2</span>(<span class="at" style="color: #657422;">html_font =</span> <span class="st" style="color: #20794D;">"Arial"</span>, <span class="at" style="color: #657422;">full_width =</span> <span class="cn" style="color: #8f5902;">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-specr" class="anchored">

<table class=" lightable-classic-2" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;2:  First six rows of multiverse numerical results from specr </caption>
 <thead>
  <tr>
   <th style="text-align:left;"> x </th>
   <th style="text-align:left;"> y </th>
   <th style="text-align:left;"> model </th>
   <th style="text-align:left;"> controls </th>
   <th style="text-align:right;"> estimate </th>
   <th style="text-align:right;"> std.error </th>
   <th style="text-align:right;"> statistic </th>
   <th style="text-align:right;"> p.value </th>
   <th style="text-align:right;"> conf.low </th>
   <th style="text-align:right;"> conf.high </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 13.96 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x2 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.48 </td>
   <td style="text-align:right;"> 0.63 </td>
   <td style="text-align:right;"> -0.01 </td>
   <td style="text-align:right;"> 0.02 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y2 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.20 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 29.79 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.18 </td>
   <td style="text-align:right;"> 0.21 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x2 </td>
   <td style="text-align:left;"> y2 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.79 </td>
   <td style="text-align:right;"> 0.43 </td>
   <td style="text-align:right;"> -0.01 </td>
   <td style="text-align:right;"> 0.02 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 13.96 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x2 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> c1 + c2 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.48 </td>
   <td style="text-align:right;"> 0.63 </td>
   <td style="text-align:right;"> -0.01 </td>
   <td style="text-align:right;"> 0.02 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Another great thing about this package is that you can easily draw specification curve figures (Figure&nbsp;2)</p>
<div class="cell" data-hash="index_cache/html/fig-specr_617539ff4398e57bcb4bff2078677e43">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">plot_specs</span>(</span>
<span id="cb5-2">  results_specr, </span>
<span id="cb5-3">  <span class="at" style="color: #657422;">choices =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x"</span>, <span class="st" style="color: #20794D;">"y"</span>, <span class="st" style="color: #20794D;">"model"</span>, <span class="st" style="color: #20794D;">"controls"</span>, <span class="st" style="color: #20794D;">"subsets"</span>)</span>
<span id="cb5-4">)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-specr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/parallel-multiverse/index_files/figure-html/fig-specr-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Specification curve figure drawn from specr results</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>However, even with this modest data set and 160 specifications, this took a while.</p>
<div class="page-columns page-full"><p>I first decided to take a stab at parallelizing <code>run_specs()</code>. This turned out to be a bit of a dead end because I couldn‚Äôt make the parallelization fit in with how <a href="https://github.com/masurp/specr/blob/master/R/run_specs.r"><code>run_specs()</code></a> works in the back-end.<sup>1</sup> So instead of shoehorning a parallel back-end to specr, I decided to implement the parallelization in a tidy pipeline. This pipeline, with no additional dependencies (apart from the tidyverse!), works pretty well. It of course does not provide specr‚Äôs one-liners, but I believe the flexibility of this approach pays back for it.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;It first creates a data frame with the specs, then the requested subsets, and then either applies <code>run_spec()</code> to all the datasets and specs using <code>map()</code>, or if no subsets were requested, runs the <code>run_spec()</code> on the specs only. So it wasn‚Äôt straightforward to parallelize over both data subsets and specs. Parallelizing over specs <a href="https://github.com/masurp/specr/pull/31/commits/142bdf879b96966b3f4bd1fdf04e886711d827f1">was simple</a>.</p></li></div></div>
</section>
<section id="tidymultiverse" class="level1">
<h1>Tidymultiverse</h1>
<section id="specification-table" class="level2">
<h2 class="anchored" data-anchor-id="specification-table">Specification table</h2>
<p>The first step in a multiverse analysis is defining the grid of specifications.</p>
<p>The one difficulty here is that the dataset can also be part of the specifications (e.g.&nbsp;different outlier removal thresholds), but you can‚Äôt include the dataset in the table of specifications, because it would easily get too large and your computer would run out of memory (I learned this the hard way). So we will still iterate over the specs table, and pull relevant subsets of the data from the source data table in the function that iterates over the specs.</p>
<p>A flexible and easy way to declare the specifications is <code>expand_grid()</code>. This allows us to create tables that cross all the variables declared therein. I‚Äôve chosen here to create a grid of variables.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_36964913f4bba4a690d472f716503c50">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">specs <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb6-2">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb6-3">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1"</span>, <span class="st" style="color: #20794D;">"y2"</span>),</span>
<span id="cb6-4">  <span class="at" style="color: #657422;">covariate =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb6-5">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>)</span>
<span id="cb6-6">)</span></code></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/tbl-specs-1_46ac03da110c57ab2b1fc643b55ba679">
<div class="cell-output-display">
<div id="tbl-specs-1" class="anchored">

<table class=" lightable-classic-2 lightable-striped" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;3:  First six rows of example specifications table. </caption>
 <thead>
  <tr>
   <th style="text-align:left;"> x </th>
   <th style="text-align:left;"> y </th>
   <th style="text-align:left;"> covariate </th>
   <th style="text-align:left;"> model </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> glm </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x2 </td>
   <td style="text-align:left;"> lm </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x2 </td>
   <td style="text-align:left;"> glm </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y2 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y2 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> glm </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>But we could also just as well create a grid of formulas. Depending on your analysis, this might be a viable option</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_3897713cd6b8874a6d5aa3076331c794">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;">formula =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1 ~ x1"</span>, <span class="st" style="color: #20794D;">"y1 ~ x2"</span>, <span class="st" style="color: #20794D;">"y1 ~ x1 + c1"</span>), <span class="co" style="color: #5E5E5E;"># And so on</span></span>
<span id="cb7-3">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>)</span>
<span id="cb7-4">)</span></code></pre></div>
</details>
</div>
<p>We will stick with specifying variables instead, for this example. We can include subgroups as well:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_f100595467f826154248c233050c6023">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">specs <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb8-2">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb8-3">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1"</span>, <span class="st" style="color: #20794D;">"y2"</span>),</span>
<span id="cb8-4">  <span class="at" style="color: #657422;">covariate =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb8-5">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>),</span>
<span id="cb8-6">  <span class="co" style="color: #5E5E5E;"># Include all distinct values of g</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;">distinct</span>(dat, group)</span>
<span id="cb8-8">)</span></code></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/tbl-specs-2_951a5517d0714adbd6a7fcb059893d14">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">head</span>(specs) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">k2</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-specs-2" class="anchored">

<table class=" lightable-classic-2 lightable-striped" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;4:  First six rows of example specifications table with subgroups. </caption>
 <thead>
  <tr>
   <th style="text-align:left;"> x </th>
   <th style="text-align:left;"> y </th>
   <th style="text-align:left;"> covariate </th>
   <th style="text-align:left;"> model </th>
   <th style="text-align:left;"> group </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> a </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> b </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now each row in the table specifies 1. the modelling function (e.g.&nbsp;<code>lm()</code>), the subgroup, and the left-hand and right-hand side variables of the formula to put in the modelling function. Next, we need a function to also expand the covariates to all their combinations (I lifted much of this from the <a href="https://github.com/masurp/specr/blob/7d5a0c3664dd5d281ecaebb783ce75b638447205/R/setup_specs.r#L41">specr source</a>, I found it surprisingly hard to write):</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-12_c2a355d5d6798bf491ec3de29f930469">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;">#' Expand a vector of covariate names to all their combinations</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;">#'</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;">#' For example expand_covariate(c("age", "sex")) returns</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;">#' c("1", "age", "sex", "age + sex")</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;">#'</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;">#' @param covariate vector of covariate(s) e.g. c("age", "sex")</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;">#'</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;">#' @return a character vector of all predictor combinations (incl. Intercept)</span></span>
<span id="cb10-9">expand_covariate <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(covariate) {</span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;">list</span>(</span>
<span id="cb10-11">    <span class="st" style="color: #20794D;">"1"</span>,</span>
<span id="cb10-12">    <span class="fu" style="color: #4758AB;">do.call</span>(</span>
<span id="cb10-13">      <span class="st" style="color: #20794D;">"c"</span>,</span>
<span id="cb10-14">      <span class="fu" style="color: #4758AB;">map</span>(<span class="fu" style="color: #4758AB;">seq_along</span>(covariate), <span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">combn</span>(covariate, .x, <span class="at" style="color: #657422;">FUN =</span> list))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb10-15">      <span class="fu" style="color: #4758AB;">map</span>(<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">paste</span>(.x, <span class="at" style="color: #657422;">collapse =</span> <span class="st" style="color: #20794D;">" + "</span>))</span>
<span id="cb10-16">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb10-17">    unlist</span>
<span id="cb10-18">}</span></code></pre></div>
</details>
</div>
<section id="the-specification-table" class="level3">
<h3 class="anchored" data-anchor-id="the-specification-table">The specification table</h3>
<p>Putting all this together, and also creating the formulas from <code>y</code>, <code>x</code>, and <code>c</code>, we have completed the first part of our pipeline, creating the specifications:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-13_31bc7224b7c21af83c74d4b7e94b1484">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">specs <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb11-2">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb11-3">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1"</span>, <span class="st" style="color: #20794D;">"y2"</span>),</span>
<span id="cb11-4">  <span class="at" style="color: #657422;">covariate =</span> <span class="fu" style="color: #4758AB;">expand_covariate</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"c1"</span>, <span class="st" style="color: #20794D;">"c2"</span>)),</span>
<span id="cb11-5">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>),</span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;">distinct</span>(dat, group)</span>
<span id="cb11-7">) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">formula =</span> <span class="fu" style="color: #4758AB;">paste0</span>(y, <span class="st" style="color: #20794D;">" ~ "</span>, x, <span class="st" style="color: #20794D;">" + "</span>, covariate))</span></code></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/tbl-specs-3_17968333a512f3b2750a2687b85be941">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">head</span>(specs) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">k2</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-specs-3" class="anchored">

<table class=" lightable-classic-2 lightable-striped" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;5:  First six rows of example specifications table with subgroups and formulas. </caption>
 <thead>
  <tr>
   <th style="text-align:left;"> x </th>
   <th style="text-align:left;"> y </th>
   <th style="text-align:left;"> covariate </th>
   <th style="text-align:left;"> model </th>
   <th style="text-align:left;"> group </th>
   <th style="text-align:left;"> formula </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> d </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> b </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> c </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> lm </td>
   <td style="text-align:left;"> a </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> d </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> x1 </td>
   <td style="text-align:left;"> y1 </td>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> glm </td>
   <td style="text-align:left;"> b </td>
   <td style="text-align:left;"> y1 ~ x1 + 1 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="estimating-the-specifications" class="level2">
<h2 class="anchored" data-anchor-id="estimating-the-specifications">Estimating the specifications</h2>
<p>Having set up the specifications, all that is left to do is to iterate over its rows, while at the same time use the correct subsets of data. While iterating, we will get the slope parameter from each row using <code>tidy()</code>. Here‚Äôs how it could look like. The arguments to <code>pmap()</code> require some explaining. We are creating a cell on each row of <code>specs</code> using <code>pmap()</code>. This will apply a function to all the named elements in <code>list()</code>. The function, then, is <code>do.call()</code>, which takes the name of the function (here, <code>lm()</code> or <code>glm()</code>) as the first argument, passed using the shorthand <code>..1</code>. Then, we provide a list of arguments to the function. <code>formula = ..2</code> takes the second element from the above list. <code>data</code> takes our main data frame <code>dat</code>, but filters it based on the groups, passed in with <code>..3</code> (<code>group</code> in the above list). We then pipe the results to <code>tidy()</code> to give a tibble of the estimated parameters, and <code>slice()</code> to just take the second row of the parameters (the slope parameter). The <code>unnest()</code> command at the end unnests the resulting tibble of results into the specs table.</p>
<div class="cell" data-hash="index_cache/html/tidy-multiverse_160fbed96e3afce30deabac3373935d6">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;">library</span>(broom)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;">tic</span>()</span>
<span id="cb13-3">results_1 <span class="ot" style="color: #003B4F;">&lt;-</span> specs <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb13-5">    <span class="at" style="color: #657422;">out =</span> <span class="fu" style="color: #4758AB;">pmap</span>(</span>
<span id="cb13-6">      <span class="fu" style="color: #4758AB;">list</span>(model, formula, group), </span>
<span id="cb13-7">      <span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">do.call</span>(</span>
<span id="cb13-8">        ..<span class="dv" style="color: #AD0000;">1</span>, </span>
<span id="cb13-9">        <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">formula =</span> ..<span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(dat, group <span class="sc" style="color: #5E5E5E;">==</span> ..<span class="dv" style="color: #AD0000;">3</span>))</span>
<span id="cb13-10">      ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb13-11">        <span class="fu" style="color: #4758AB;">tidy</span>(<span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb13-12">        <span class="fu" style="color: #4758AB;">slice</span>(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb13-13">    )</span>
<span id="cb13-14">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb13-15">  <span class="fu" style="color: #4758AB;">unnest</span>(out)</span>
<span id="cb13-16"><span class="fu" style="color: #4758AB;">toc</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>13.419 sec elapsed</code></pre>
</div>
</div>
<p>We already see an improvement in the run-time of this pipeline over <code>run_specs()</code>, but note that my implementation does not estimate models for the complete data (<code>subsets</code> = <code>all</code> in specr), so it is not an entirely fair comparison.</p>
</section>
<section id="parallel-estimation" class="level2">
<h2 class="anchored" data-anchor-id="parallel-estimation">Parallel estimation</h2>
<p>Now that we have our pipeline set up, we can use multidplyr to easily (and safely!) parallelize our computations.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Parallelization is hard and rarely works out of the box. Multidplyr works best when the individual computations are slow, because there is always some overhead in sending stuff back and forth between the nodes of the cluster. So the benefits will be even greater with larger data or slower models. The benefit of using multidplyr vs other parallel backends is that the user retains control over how to split up the computations. Your feedback is more than welcome (comments are open at the end of this post)!</p>
</div>
</div>
<p>To start, we load multidplyr, create a new cluster, and send the required libraries and variables to it.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;">library</span>(multidplyr)</span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;"># Create a new cluster</span></span>
<span id="cb15-3">cluster <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">new_cluster</span>(<span class="dv" style="color: #AD0000;">8</span>)</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;"># Load libraries in and send data to nodes in the cluster</span></span>
<span id="cb15-6"><span class="fu" style="color: #4758AB;">cluster_library</span>(cluster, <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"purrr"</span>, <span class="st" style="color: #20794D;">"broom"</span>, <span class="st" style="color: #20794D;">"tidyr"</span>, <span class="st" style="color: #20794D;">"dplyr"</span>))</span>
<span id="cb15-7"><span class="fu" style="color: #4758AB;">cluster_copy</span>(cluster, <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"dat"</span>))</span></code></pre></div>
</details>
</div>
<p>Multidplyr integrates seamlessly into <code>%&gt;%</code>lines by sending groups in the passed data to nodes in the cluster. It is therefore important to think a bit about how to group your data. For us, we want to equally divide the <code>lm()</code> and <code>glm()</code> calls across nodes, because <code>glm()</code> is considerably slower. If one node got all the <code>glm()</code> calls, we would have to wait for that one node even after the others had completed.</p>
<p>Here, it makes sense for us to group the data by <code>formula</code> and <code>group</code>. After grouping the data, we <code>partition()</code> it across the nodes in the cluster, run our computations, and then <code>collect()</code> the results back to our main R process. I also pass the <code>tidy()</code> results to <code>slice(2)</code> to just get the slope parameters.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;">tic</span>()</span>
<span id="cb16-2">results_2 <span class="ot" style="color: #003B4F;">&lt;-</span> specs <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;">group_by</span>(formula, group) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-4">  <span class="fu" style="color: #4758AB;">partition</span>(cluster) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb16-5">  <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb16-6">    <span class="at" style="color: #657422;">out =</span> <span class="fu" style="color: #4758AB;">pmap</span>(</span>
<span id="cb16-7">      <span class="fu" style="color: #4758AB;">list</span>(model, formula, group), </span>
<span id="cb16-8">      <span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">do.call</span>(..<span class="dv" style="color: #AD0000;">1</span>, <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">formula =</span> ..<span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(dat, .data[[<span class="st" style="color: #20794D;">"group"</span>]] <span class="sc" style="color: #5E5E5E;">==</span> ..<span class="dv" style="color: #AD0000;">3</span>))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-9">        <span class="fu" style="color: #4758AB;">tidy</span>(<span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-10">        <span class="fu" style="color: #4758AB;">slice</span>(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb16-11">    )</span>
<span id="cb16-12">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-13">  <span class="fu" style="color: #4758AB;">collect</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-14">  <span class="fu" style="color: #4758AB;">ungroup</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-15">  <span class="fu" style="color: #4758AB;">unnest</span>(out)</span>
<span id="cb16-16"><span class="fu" style="color: #4758AB;">toc</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>4.089 sec elapsed</code></pre>
</div>
</div>
<p>This particular parallelization scheme (8 cores working on subsets defined by <code>formula</code> and <code>group</code> in <code>dat</code>) sped up our computations about 8 times compared to the original implementation, and about 4 times compared to the non-parallelized equivalent. Good stuff.</p>
<p>I also spot check that the results are consistent across the methods. I am a bit paranoid with what comes to parallel computation.</p>
<div class="cell" data-hash="index_cache/html/tbl-results-check_e60317c685f391f1f922ca746efbd363">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;">bind_rows</span>(</span>
<span id="cb18-2">  <span class="st" style="color: #20794D;">"specr"</span> <span class="ot" style="color: #003B4F;">=</span> results_specr <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-3">    <span class="fu" style="color: #4758AB;">filter</span>(subsets <span class="sc" style="color: #5E5E5E;">!=</span> <span class="st" style="color: #20794D;">"all"</span>, x <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"x1"</span>, y <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"y1"</span>, model <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"lm"</span>, controls <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"c1"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-4">    <span class="fu" style="color: #4758AB;">rename</span>(<span class="at" style="color: #657422;">covariate =</span> controls, <span class="at" style="color: #657422;">group =</span> subsets) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-5">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">group =</span> <span class="fu" style="color: #4758AB;">str_remove</span>(group, <span class="st" style="color: #20794D;">"group = "</span>)),</span>
<span id="cb18-6">  <span class="st" style="color: #20794D;">"tidymultiverse"</span> <span class="ot" style="color: #003B4F;">=</span> results_1 <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-7">    <span class="fu" style="color: #4758AB;">filter</span>(term <span class="sc" style="color: #5E5E5E;">==</span> x, x <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"x1"</span>, y <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"y1"</span>, model <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"lm"</span>, covariate <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"c1"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-8">    <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>formula, <span class="sc" style="color: #5E5E5E;">-</span>term),</span>
<span id="cb18-9">  <span class="st" style="color: #20794D;">"TM (parallel)"</span> <span class="ot" style="color: #003B4F;">=</span> results_2 <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-10">    <span class="fu" style="color: #4758AB;">filter</span>(term <span class="sc" style="color: #5E5E5E;">==</span> x, x <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"x1"</span>, y <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"y1"</span>, model <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"lm"</span>, covariate <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"c1"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-11">    <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>formula, <span class="sc" style="color: #5E5E5E;">-</span>term),</span>
<span id="cb18-12">  <span class="at" style="color: #657422;">.id =</span> <span class="st" style="color: #20794D;">"Method"</span></span>
<span id="cb18-13">) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-14">  <span class="fu" style="color: #4758AB;">select</span>(Method, estimate, std.error, conf.low, conf.high, group) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-15">  <span class="fu" style="color: #4758AB;">arrange</span>(group) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb18-16">  <span class="fu" style="color: #4758AB;">k2</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-results-check" class="anchored">

<table class=" lightable-classic-2 lightable-striped" style="font-family: Arial; width: auto !important; margin-left: auto; margin-right: auto;"><caption>Table&nbsp;6:  Example results from the three estimation methods. </caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Method </th>
   <th style="text-align:right;"> estimate </th>
   <th style="text-align:right;"> std.error </th>
   <th style="text-align:right;"> conf.low </th>
   <th style="text-align:right;"> conf.high </th>
   <th style="text-align:left;"> group </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> specr </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> a </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tidymultiverse </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> a </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TM (parallel) </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> a </td>
  </tr>
  <tr>
   <td style="text-align:left;"> specr </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.12 </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tidymultiverse </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.12 </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TM (parallel) </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.12 </td>
   <td style="text-align:left;"> b </td>
  </tr>
  <tr>
   <td style="text-align:left;"> specr </td>
   <td style="text-align:right;"> 0.10 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> c </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tidymultiverse </td>
   <td style="text-align:right;"> 0.10 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> c </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TM (parallel) </td>
   <td style="text-align:right;"> 0.10 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> c </td>
  </tr>
  <tr>
   <td style="text-align:left;"> specr </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tidymultiverse </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> d </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TM (parallel) </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> d </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="complete-tidymultiverse-example" class="level1">
<h1>Complete tidymultiverse example</h1>
<p>Let‚Äôs take this one step further and show an example of a complete pipeline. We still analyse the same dataset, but with an additional complexity: We are worried about outliers in the data, and would like to explore a multiverse over different data filtering thresholds (reject <code>y1</code> values that are more than 1, 2, or 3 standard deviations from the mean). We can implement this in many ways. For example, we could create indicator variables that could be used as subgroups just as we have done with <code>group</code> so far. Another interesting alternative is to dynamically filter the source data in the function that iterates over the specs table. We take the latter route here.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-19_85402d14a04c69766ed7469d1fdc7b78">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;">tic</span>()</span>
<span id="cb19-2">results <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb19-3">  <span class="at" style="color: #657422;">threshold =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">3</span>),</span>
<span id="cb19-4">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"x1"</span>, <span class="st" style="color: #20794D;">"x2"</span>),</span>
<span id="cb19-5">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"y1"</span>, <span class="st" style="color: #20794D;">"y2"</span>),</span>
<span id="cb19-6">  <span class="at" style="color: #657422;">covariate =</span> <span class="fu" style="color: #4758AB;">expand_covariate</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"c1"</span>, <span class="st" style="color: #20794D;">"c2"</span>)),</span>
<span id="cb19-7">  <span class="at" style="color: #657422;">model =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"lm"</span>, <span class="st" style="color: #20794D;">"glm"</span>),</span>
<span id="cb19-8">  <span class="fu" style="color: #4758AB;">distinct</span>(dat, group)</span>
<span id="cb19-9">) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb19-10">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">formula =</span> <span class="fu" style="color: #4758AB;">paste0</span>(y, <span class="st" style="color: #20794D;">" ~ "</span>, x, <span class="st" style="color: #20794D;">" + "</span>, covariate)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb19-11">  <span class="fu" style="color: #4758AB;">group_by</span>(formula, group) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb19-12">  <span class="fu" style="color: #4758AB;">partition</span>(cluster) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb19-13">  <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb19-14">    <span class="at" style="color: #657422;">out =</span> <span class="fu" style="color: #4758AB;">pmap</span>(</span>
<span id="cb19-15">      <span class="fu" style="color: #4758AB;">list</span>(model, formula, group, threshold), </span>
<span id="cb19-16">      <span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">do.call</span>(</span>
<span id="cb19-17">        ..<span class="dv" style="color: #AD0000;">1</span>, </span>
<span id="cb19-18">        <span class="fu" style="color: #4758AB;">list</span>(</span>
<span id="cb19-19">          <span class="at" style="color: #657422;">formula =</span> ..<span class="dv" style="color: #AD0000;">2</span>, </span>
<span id="cb19-20">          <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(</span>
<span id="cb19-21">            dat, </span>
<span id="cb19-22">            group <span class="sc" style="color: #5E5E5E;">==</span> ..<span class="dv" style="color: #AD0000;">3</span>,</span>
<span id="cb19-23">            <span class="fu" style="color: #4758AB;">between</span>(y1, <span class="fu" style="color: #4758AB;">mean</span>(y1) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">sd</span>(y1)<span class="sc" style="color: #5E5E5E;">*</span>..<span class="dv" style="color: #AD0000;">4</span>, <span class="fu" style="color: #4758AB;">mean</span>(y1) <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">sd</span>(y1)<span class="sc" style="color: #5E5E5E;">*</span>..<span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb19-24">          )</span>
<span id="cb19-25">        )</span>
<span id="cb19-26">      ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb19-27">        <span class="fu" style="color: #4758AB;">tidy</span>(<span class="at" style="color: #657422;">conf.int =</span> <span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb19-28">        <span class="fu" style="color: #4758AB;">slice</span>(<span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb19-29">    )</span>
<span id="cb19-30">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb19-31">  <span class="fu" style="color: #4758AB;">collect</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb19-32">  <span class="fu" style="color: #4758AB;">unnest</span>(out) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb19-33">  <span class="fu" style="color: #4758AB;">ungroup</span>()</span>
<span id="cb19-34"><span class="fu" style="color: #4758AB;">toc</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>8.295 sec elapsed</code></pre>
</div>
</div>
<p>Ok, ok, that was too much in one go. Let‚Äôs focus on the key piece here: Applying the modelling function to each row of the specifications, on rows 15 to 27.</p>
<ul>
<li><code>list(model, formula, group, threshold)</code>
<ul>
<li>We pick these variables from the specification table to use as arguments in <code>do.call()</code></li>
</ul></li>
<li><code>do.call(**..1**)</code>
<ul>
<li>This means that we will run the function named in the first element in the above list, <code>model</code> (which is <code>lm</code> or <code>glm</code>), with the subsequent arguments</li>
</ul></li>
<li><code>formula = ..2</code>, use the second element from the list passed to <code>pmap()</code> as the <code>formula</code> argument of <code>model</code> (e.g.&nbsp;<code>lm()</code>)</li>
<li><code>data = filter(...)</code>
<ul>
<li>This is where the action is. We dynamically filter the source data frame <code>dat</code> based on variables in the specification table.</li>
<li><code>group == ..3</code> means that we filter the data on group (the third argument in the list of arguments passed to <code>pmap()</code>)</li>
<li><code>between(y1, mean(y1) - sd(y1)*..4, mean(y1) + sd(y1)*..4)</code> we filter data in <code>dat</code> based on the fourth argument <code>threshold</code>. This line says to include only <code>y1</code> values that are within <code>..4</code> (= <code>threshold</code> in the specification table) standard deviations from the mean.</li>
</ul></li>
</ul>
<p>This syntax seems a bit hairy, but it is entirely general. The key point here is that we don‚Äôt have to learn any new syntax from a new package, but can simply keep applying tidyverse‚Äôs <code>%&gt;%</code>lines with familiar dplyr verbs like <code>filter()</code>. The ugly aspect here is that we are sneaking in those <code>%&gt;%</code>lines inside the <code>do.call()</code> function, which then iterates over the specification table.</p>
<section id="a-visualization" class="level2">
<h2 class="anchored" data-anchor-id="a-visualization">A visualization</h2>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;">library</span>(patchwork)</span>
<span id="cb21-2">results <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">arrange</span>(results, estimate) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">spec =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="fu" style="color: #4758AB;">n</span>())</span>
<span id="cb21-3">p_dash <span class="ot" style="color: #003B4F;">&lt;-</span> results <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;">select</span>(spec, p.value, threshold<span class="sc" style="color: #5E5E5E;">:</span>group) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;">c</span>(spec, p.value), <span class="at" style="color: #657422;">values_transform =</span> as.character) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb21-6">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(spec, value, <span class="at" style="color: #657422;">col =</span> p.value <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">0.05</span>)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-7">  <span class="fu" style="color: #4758AB;">scale_color_brewer</span>(<span class="at" style="color: #657422;">palette =</span> <span class="st" style="color: #20794D;">"Set1"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-8">  <span class="fu" style="color: #4758AB;">scale_x_continuous</span>(</span>
<span id="cb21-9">    <span class="st" style="color: #20794D;">"Specification"</span></span>
<span id="cb21-10">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-11">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="at" style="color: #657422;">size =</span> <span class="fl" style="color: #AD0000;">0.5</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-12">  <span class="fu" style="color: #4758AB;">facet_grid</span>(<span class="at" style="color: #657422;">rows =</span> <span class="fu" style="color: #4758AB;">vars</span>(name), <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free_y"</span>, <span class="at" style="color: #657422;">space =</span> <span class="st" style="color: #20794D;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-13">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">axis.title.y =</span> <span class="fu" style="color: #4758AB;">element_blank</span>())</span>
<span id="cb21-14">p_curve <span class="ot" style="color: #003B4F;">&lt;-</span> results <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb21-15">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(spec, estimate, <span class="at" style="color: #657422;">col =</span> p.value <span class="sc" style="color: #5E5E5E;">&lt;</span> <span class="fl" style="color: #AD0000;">0.05</span>)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-16">  <span class="fu" style="color: #4758AB;">scale_color_brewer</span>(<span class="at" style="color: #657422;">palette =</span> <span class="st" style="color: #20794D;">"Set1"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb21-17">  <span class="fu" style="color: #4758AB;">geom_pointrange</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">ymin =</span> conf.low, <span class="at" style="color: #657422;">ymax =</span> conf.high), <span class="at" style="color: #657422;">size =</span> <span class="fl" style="color: #AD0000;">0.5</span>)</span>
<span id="cb21-18">(p_curve <span class="sc" style="color: #5E5E5E;">/</span> p_dash) <span class="sc" style="color: #5E5E5E;">&amp;</span></span>
<span id="cb21-19">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">legend.position =</span> <span class="st" style="color: #20794D;">"none"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-results-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/parallel-multiverse/index_files/figure-html/fig-results-2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Specification curve figure example with ggplot().</figcaption><p></p>
</figure>
</div>
</div>
</div>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-orbenAssociationAdolescentWellbeing2019" class="csl-entry">
Orben, Amy, and Andrew K. Przybylski. 2019. <span>‚ÄúThe Association Between Adolescent Well-Being and Digital Technology Use.‚Äù</span> <em>Nature Human Behaviour</em> 3 (2, 2): 173‚Äì82. <a href="https://doi.org/10.1038/s41562-018-0506-1">https://doi.org/10.1038/s41562-018-0506-1</a>.
</div>
<div id="ref-simonsohnSpecificationCurveAnalysis2020" class="csl-entry">
Simonsohn, Uri, Joseph P. Simmons, and Leif D. Nelson. 2020. <span>‚ÄúSpecification Curve Analysis.‚Äù</span> <em>Nature Human Behaviour</em>, July, 1‚Äì7. <a href="https://doi.org/10.1038/s41562-020-0912-z">https://doi.org/10.1038/s41562-020-0912-z</a>.
</div>
<div id="ref-steegenIncreasingTransparencyMultiverse2016" class="csl-entry">
Steegen, Sara, Francis Tuerlinckx, Andrew Gelman, and Wolf Vanpaemel. 2016. <span>‚ÄúIncreasing <span>Transparency Through</span> a <span>Multiverse Analysis</span>.‚Äù</span> <em>Perspectives on Psychological Science</em>, September. <a href="https://doi.org/10.1177/1745691616658637">https://doi.org/10.1177/1745691616658637</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2022,
  author = {Matti Vuorre},
  title = {Tidymultiverse},
  date = {2022-11-30},
  url = {https://vuorre.netlify.app/posts/parallel-multiverse},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2022" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2022. <span>‚ÄúTidymultiverse.‚Äù</span> November 30, 2022. <a href="https://vuorre.netlify.app/posts/parallel-multiverse">https://vuorre.netlify.app/posts/parallel-multiverse</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>multiverse</category>
  <category>tidyverse</category>
  <category>specr</category>
  <guid>https://vuorre.netlify.app/posts/parallel-multiverse/index.html</guid>
  <pubDate>Wed, 30 Nov 2022 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/parallel-multiverse/images/undraw-lost-online.png" medium="image" type="image/png" height="117" width="144"/>
</item>
<item>
  <title>Website favicons with hexSticker</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/hexsticker-favicon/index.html</link>
  <description><![CDATA[ 




<p>My website needed a new <a href="https://en.wikipedia.org/wiki/Favicon">favicon</a>, and I decided to create one with R. I quite like the look of those hexagonal R package logos, and it turns out there‚Äôs an R package that helps you make those: <a href="https://github.com/GuangchuangYu/hexSticker">hexSticker</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(hexSticker)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(viridis)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(here)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<p>First, the design. I really like the simple symmetry of a (normal) density curve. So I based my design on that. To make it a bit more interesting, I decided to stack a small number of them on top of another, each with its own color. Here‚Äôs how I went about doing that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;"># A consistent color palette for the image</span></span>
<span id="cb2-2">palette <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">viridis</span>(<span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;"># Create data for the density curves</span></span>
<span id="cb2-5">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand_grid</span>(</span>
<span id="cb2-6">    <span class="at" style="color: #657422;">m =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb2-7">    <span class="fu" style="color: #4758AB;">nesting</span>(<span class="at" style="color: #657422;">s =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">1.5</span>, <span class="fl" style="color: #AD0000;">1.5</span>, <span class="fl" style="color: #AD0000;">1.5</span>), <span class="at" style="color: #657422;">n1 =</span> <span class="fu" style="color: #4758AB;">factor</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">3</span>)),</span>
<span id="cb2-8">    <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">5</span>, <span class="at" style="color: #657422;">by =</span> .<span class="dv" style="color: #AD0000;">01</span>)</span>
<span id="cb2-9">  ) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">dnorm</span>(x, m, s))</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;"># Plot said data</span></span>
<span id="cb2-13">p <span class="ot" style="color: #003B4F;">&lt;-</span> d <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">col =</span> n1, <span class="at" style="color: #657422;">group =</span> n1)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-15">  <span class="co" style="color: #5E5E5E;"># What's a better / more overused color scale? Nothing.</span></span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;">scale_color_viridis_d</span>(<span class="at" style="color: #657422;">begin =</span> .<span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">end =</span> .<span class="dv" style="color: #AD0000;">8</span>, <span class="at" style="color: #657422;">direction =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-17">  <span class="co" style="color: #5E5E5E;"># Adjust the empty areas between plot geoms and axis limits</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(</span>
<span id="cb2-19">    <span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(.<span class="dv" style="color: #AD0000;">35</span>, .<span class="dv" style="color: #AD0000;">15</span>))</span>
<span id="cb2-20">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-21">  <span class="co" style="color: #5E5E5E;"># These curves go up</span></span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;">geom_line</span>(</span>
<span id="cb2-23">    <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> x, <span class="at" style="color: #657422;">y =</span> y),</span>
<span id="cb2-24">    <span class="at" style="color: #657422;">linewidth =</span> <span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb2-25">    <span class="at" style="color: #657422;">position =</span> <span class="fu" style="color: #4758AB;">position_stack</span>()</span>
<span id="cb2-26">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-27">  <span class="co" style="color: #5E5E5E;"># Make the plot otherwise completely empty</span></span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;">theme_void</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-29">  <span class="fu" style="color: #4758AB;">theme_transparent</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-30">  <span class="fu" style="color: #4758AB;">theme</span>(</span>
<span id="cb2-31">    <span class="at" style="color: #657422;">legend.position =</span> <span class="st" style="color: #20794D;">"none"</span></span>
<span id="cb2-32">  )</span></code></pre></div>
</div>
<p>Can you imagine from above what it‚Äôll look like üòâ? You‚Äôll see in a bit. Next I needed to pass the plot object throught <code>hexSticker::sticker()</code> to create the hexagonal sticker plot. There are quite a few arguments to that function and it took me a few minutes to figure out what they do. I basically wanted to fill the hexagonal area with the plot, and add a URL to the corner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">s <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">sticker</span>(</span>
<span id="cb3-2">  p, </span>
<span id="cb3-3">  <span class="at" style="color: #657422;">s_x =</span> <span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;">s_y =</span> <span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;">s_width =</span> <span class="fl" style="color: #AD0000;">1.9</span>,</span>
<span id="cb3-6">  <span class="at" style="color: #657422;">s_height =</span> <span class="fl" style="color: #AD0000;">1.7</span>,</span>
<span id="cb3-7">  <span class="at" style="color: #657422;">h_fill =</span> <span class="st" style="color: #20794D;">"black"</span>,</span>
<span id="cb3-8">  <span class="at" style="color: #657422;">h_color =</span> palette[<span class="dv" style="color: #AD0000;">3</span>],</span>
<span id="cb3-9">  <span class="at" style="color: #657422;">package =</span> <span class="st" style="color: #20794D;">""</span>,</span>
<span id="cb3-10">  <span class="at" style="color: #657422;">url =</span> <span class="st" style="color: #20794D;">"sometimes I R"</span>,</span>
<span id="cb3-11">  <span class="at" style="color: #657422;">u_color =</span> palette[<span class="dv" style="color: #AD0000;">7</span>],</span>
<span id="cb3-12">  <span class="at" style="color: #657422;">u_size =</span> <span class="dv" style="color: #AD0000;">24</span>,</span>
<span id="cb3-13">  <span class="at" style="color: #657422;">dpi =</span> <span class="dv" style="color: #AD0000;">800</span>,</span>
<span id="cb3-14">  <span class="at" style="color: #657422;">filename =</span> <span class="fu" style="color: #4758AB;">here</span>(<span class="st" style="color: #20794D;">"favicon.png"</span>)</span>
<span id="cb3-15">  )</span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;">plot</span>(s)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-favicon" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/hexsticker-favicon/index_files/figure-html/fig-favicon-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Sticker made with ggplot2 and hexSticker.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The more I kept tweaking this, the more it started to look like a tropical fish swimming towards me. Only the eyes are missing! When printed in RStudio or here in the html output of a rmarkdown/quarto document, the margins are oddly large. But the output file looks just as it should, and is now both the logo (top-left corner) and favicon (browser tab) of this website.</p>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2022,
  author = {Matti Vuorre},
  title = {Website Favicons with {hexSticker}},
  date = {2022-06-29},
  url = {https://vuorre.netlify.app/posts/hexsticker-favicon},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2022" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2022. <span>‚ÄúWebsite Favicons with hexSticker.‚Äù</span>
June 29, 2022. <a href="https://vuorre.netlify.app/posts/hexsticker-favicon">https://vuorre.netlify.app/posts/hexsticker-favicon</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <guid>https://vuorre.netlify.app/posts/hexsticker-favicon/index.html</guid>
  <pubDate>Tue, 28 Jun 2022 23:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/hexsticker-favicon/index_files/figure-html/fig-favicon-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Easy notifications from R</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/easy-notifications-from-r/index.html</link>
  <description><![CDATA[ 




<p>R can be a pretty slow tool. So it would be good to know when an expensive computation has ended. One way to do that is to have R send a notification to your phone when it is done. Here, I‚Äôll show how to do that easily with <a href="https://ntfy.sh">ntfy</a>.</p>
<section id="download-ntfy.sh" class="level2">
<h2 class="anchored" data-anchor-id="download-ntfy.sh">Download ntfy.sh</h2>
<p>Go to your app store (iOS/Android) and download the ntfy app.</p>
</section>
<section id="subscribe-to-a-topic" class="level2">
<h2 class="anchored" data-anchor-id="subscribe-to-a-topic">Subscribe to a topic</h2>
<p>Open the app on your phone and <a href="https://ntfy.sh/docs/subscribe/phone/">subscribe to a topic</a>. Just type in a name that‚Äôs both memorable and not likely to already be used by someone else. I use <code>vuorre-r-notifications</code>.</p>
<p><img src="https://vuorre.netlify.app/posts/easy-notifications-from-r/images/subscribe.jpeg" class="img-fluid" alt="Subscribing to vuorre-r-notifications on ntfy.sh"></p>
</section>
<section id="send-notifications" class="level2">
<h2 class="anchored" data-anchor-id="send-notifications">Send notifications</h2>
<p>You can now include variations of <code>system("curl -d 'Notification text' ntfy.sh/vuorre-r-notifications")</code> in your R code. For example, to send a notification after a long running code</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;"># Long running code here</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">Sys.sleep</span>(.<span class="dv" style="color: #AD0000;">1</span>)  <span class="co" style="color: #5E5E5E;"># Sleep for .1 second</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;"># Send notification</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">system</span>(<span class="st" style="color: #20794D;">"curl -d 'Woke up after .1 second nap!' ntfy.sh/vuorre-r-notifications"</span>)</span></code></pre></div>
</div>
<p>You‚Äôll get this notification on your phone:</p>
<p><img src="https://vuorre.netlify.app/posts/easy-notifications-from-r/images/notification.jpeg" class="img-fluid" alt="Notification received on phone"></p>
<p>This is really useful when you have simulations (mcmc or otherwise üòâ) that take a long time, and you‚Äôd like to act as soon as they are done. Have fun!</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2022,
  author = {Matti Vuorre},
  title = {Easy Notifications from {R}},
  date = {2022-06-15},
  url = {https://vuorre.netlify.app/posts/easy-notifications-from-r},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2022" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2022. <span>‚ÄúEasy Notifications from R.‚Äù</span> June 15,
2022. <a href="https://vuorre.netlify.app/posts/easy-notifications-from-r">https://vuorre.netlify.app/posts/easy-notifications-from-r</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>tips</category>
  <guid>https://vuorre.netlify.app/posts/easy-notifications-from-r/index.html</guid>
  <pubDate>Tue, 14 Jun 2022 23:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/easy-notifications-from-r/images/subscribe.jpeg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>How to calculate contrasts from a fitted brms model</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index.html</link>
  <description><![CDATA[ 




<p><a href="https://cran.rstudio.com/web/packages/brms/">brms</a> (Bayesian Regression Models using Stan) is an <a href="https://cran.rstudio.com/">R</a> package that allows fitting complex (multilevel, multivariate, mixture, ‚Ä¶) statistical models with straightforward R modeling syntax, while using <a href="https://mc-stan.org/">Stan</a> for bayesian inference under the hood. You will find many uses of that package on this blog. I am particularly fond of brms‚Äô helper functions for post-processing (visualizing, summarizing, etc) the fitted models. In this post, I will show how to calculate and visualize arbitrary contrasts (aka ‚Äú(general linear) hypothesis tests‚Äù) with brms, with full uncertainty estimates.</p>
<section id="models-and-contrasts" class="level2">
<h2 class="anchored" data-anchor-id="models-and-contrasts">Models and contrasts</h2>
<p>Here, we will discuss linear models, which regress an outcome variable on a weighted combination of predictors, while allowing the weights to vary across individuals (hierarchical linear regression). After fitting the model, you will have estimates of the weights (‚Äúbeta weights‚Äù, or simply regression parameters) that typically consist of an intercept (estimated level of outcome variable when all predictors are zero) and slopes, which indicate how the outcome variable changes as function of one-unit changes of the predictors, when other predictors are at 0.</p>
<p>However, we are often interested in further questions (contrasts, ‚Äúgeneral linear hypothesis tests‚Äù). For example, your model output may report one group‚Äôs change over time, and the difference of that slope between groups, but you are particularly interested in the other group‚Äôs slope. To find that slope, you‚Äôd need to calculate an additional contrast from your model. This is also commonly called ‚Äúprobing interactions‚Äù or sometimes ‚Äúpost hoc testing‚Äù.</p>
<section id="example-data" class="level3">
<h3 class="anchored" data-anchor-id="example-data">Example data</h3>
<p>To make this concrete, let‚Äôs consider a hypothetical example data set from <a href="http://intensivelongitudinal.com/ch4/ch4index.html">Bolger and Laurenceau (2013)</a>: Two groups‚Äô (<code>treatment</code>: 0/1) self-reported <code>intimacy</code> was tracked over 16 days (<code>time</code>). The dataset contains data from a total of 50 (simulated) individuals.</p>
<div class="cell" data-hash="index_cache/html/data_e38f0edea7e5642c6382cafd7401a4d1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(rio)</span>
<span id="cb1-3">dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">import</span>(</span>
<span id="cb1-4">  <span class="st" style="color: #20794D;">"http://www.intensivelongitudinal.com/ch4/ch4R.zip"</span>, </span>
<span id="cb1-5">  <span class="at" style="color: #657422;">setclass =</span> <span class="st" style="color: #20794D;">"tibble"</span>, </span>
<span id="cb1-6">  <span class="at" style="color: #657422;">colClasses =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"id"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"factor"</span>, <span class="st" style="color: #20794D;">"treatment"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"factor"</span>)</span>
<span id="cb1-7">)</span></code></pre></div>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_a27f681d7fd1bddb0bc4ce6bb94a3239">

</div>
</section>
<section id="model" class="level3">
<h3 class="anchored" data-anchor-id="model">Model</h3>
<p>We might be interested in how the two groups‚Äô feelings of intimacy developed over time, and how their temporal trajectories of intimacy differed. To be more specific, we have three questions:</p>
<p>Q1: How did intimacy develop over time for group 0? Q2: How did intimacy develop over time for group 1? Q3: How different were these two time-courses?</p>
<p>To answer, we model intimacy as a function of time, treatment, and their interactions. The hierarchical model includes varying intercepts and effects of time across participants.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb2-2">fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb2-3">  intimacy <span class="sc" style="color: #5E5E5E;">~</span> time <span class="sc" style="color: #5E5E5E;">*</span> treatment <span class="sc" style="color: #5E5E5E;">+</span> (time <span class="sc" style="color: #5E5E5E;">|</span> id),</span>
<span id="cb2-4">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">gaussian</span>(),</span>
<span id="cb2-5">  <span class="at" style="color: #657422;">data =</span> dat,</span>
<span id="cb2-6">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"intimacymodel"</span></span>
<span id="cb2-7">)</span></code></pre></div>
</div>
</section>
<section id="interpreting-the-models-parameters" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-models-parameters">Interpreting the model‚Äôs parameters</h3>
<p>Let‚Äôs then answer our questions by looking at the model‚Äôs summary, and interpreting the estimated population-level parameters (the posterior means and standard deviations).</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_67895bf65846db104876335ef0f1317a">
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Summary of the Intimacy model's parameters</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Parameter </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Est.Error </th>
   <th style="text-align:right;"> Q2.5 </th>
   <th style="text-align:right;"> Q97.5 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> b_Intercept </td>
   <td style="text-align:right;"> 2.89 </td>
   <td style="text-align:right;"> 0.21 </td>
   <td style="text-align:right;"> 2.49 </td>
   <td style="text-align:right;"> 3.31 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> b_time </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> b_treatment1 </td>
   <td style="text-align:right;"> -0.05 </td>
   <td style="text-align:right;"> 0.30 </td>
   <td style="text-align:right;"> -0.68 </td>
   <td style="text-align:right;"> 0.52 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> b_time:treatment1 </td>
   <td style="text-align:right;"> 0.06 </td>
   <td style="text-align:right;"> 0.03 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.13 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The first lesson is that most models are simply too complex to interpret by just looking at the numerical parameter estimates. Therefore, we always draw figures to help us interpret what the model thinks is going on. The figure below shows example participants‚Äô data (left) and the model‚Äôs estimated effects on the right.</p>
<div class="cell" data-hash="index_cache/html/figure_4d5407611eca48fecf627589f2b2def4">
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index_files/figure-html/figure-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, we can begin interpreting the parameters. First, the intercept indicates estimated intimacy when time and treatment were at their respective baseline levels (0). It is always easiest to interpret the parameters by eyeballing the right panel of the figure above and trying to connect the numbers to the figure. This estimate is the left-most point of the red line.</p>
<p>The estimated <code>time</code> parameter describes the slope of the red line (Q1); <code>treatment1</code> is the difference between the two lines at time zero (Q3). However, we cannot immediately answer Q2 from the parameters, although we can see that the slope of the blue line is about 0.05 + 0.06. To get the answer to Q2, or more generally, any contrast or ‚Äúgeneral linear hypothesis test‚Äù from a brms model, we can use the <code>hypothesis()</code> method.</p>
</section>
</section>
<section id="hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="hypothesis">hypothesis()</h2>
<p><code>hypothesis()</code> truly is an underappreciated method of the brms package. It can be very useful in probing complex models. It allows us to calculate, visualize, and summarize, with full uncertainty estimates, any transformation of the model‚Äôs parameters. These transformations are often called ‚Äúcontrasts‚Äù or ‚Äúgeneral linear hypothesis tests‚Äù. But really, they are just transformations of the joint posterior distribution of the model‚Äôs parameters.</p>
<p>To answer Q2, then, we encode our question into a combination of the models parameters:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_933d48cfc0613c1b58f413c4aa875c71">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">q2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="at" style="color: #657422;">q2 =</span> <span class="st" style="color: #20794D;">"time + time:treatment1 = 0"</span>)</span></code></pre></div>
</div>
<p>The slope of group 1 is calculated from the model‚Äôs parameters by adding the slope of group 0 (<code>time</code>) and the interaction term <code>time:treatment1</code>. <code>= 0</code> indicates that we are interested in contrasting the resulting estimate the zero (‚Äútesting against zero‚Äù or even ‚Äútesting the null hypothesis‚Äù). Then, we pass this named string to <code>hypothesis()</code>, and observe the results.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_cf476b65ca6eb7488d02666834f247fc">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">q2_answer <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(fit, q2)</span>
<span id="cb4-2">q2_answer</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
  Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1         q2     0.11      0.02     0.06     0.16         NA        NA    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
</div>
<p>The output indicates that the estimated answer to Question 2 is 0.11 with a standard error of 0.02. I will return to <code>Evid.Ratio</code> and <code>Post.Prob</code> shortly.</p>
<p>The results can also be visualized.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_25c0a52c7a787a16b504300fdba1b2a2">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">plot</span>(q2_answer)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That figure shows the (samples from the) posterior distribution of the answer to Question 2.</p>
</section>
<section id="more-contrasts" class="level2">
<h2 class="anchored" data-anchor-id="more-contrasts">More contrasts</h2>
<p>With <code>hypothesis()</code> you can answer many additional questions about your model, beyond the parameter estimates. To illustrate, say we are interested in the groups‚Äô difference in intimacy at the end of the study (day 15; Question 4). (The difference at time 0 is reported by the group parameter.)</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_ed8dd057638d67ead8434d7c0bfc49eb">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">q4 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="at" style="color: #657422;">q4 =</span> <span class="st" style="color: #20794D;">"treatment1 + time:treatment1 * 15 = 0"</span>)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;">hypothesis</span>(fit, q4)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
  Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1         q4     0.88       0.4     0.05     1.66         NA        NA    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
</div>
<section id="directional-hypotheses-and-posterior-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="directional-hypotheses-and-posterior-probabilities">Directional hypotheses and posterior probabilities</h3>
<p>We can also ask for directional questions. For example, what is the probability that group 0‚Äôs slope is greater than 0 (Q5)?</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_8e4b8c458d4fd63ed7a6f6f26a83ef70">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">q5 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="at" style="color: #657422;">q5 =</span> <span class="st" style="color: #20794D;">"time &gt; 0"</span>)</span>
<span id="cb9-2">q5_answer <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(fit, q5)</span>
<span id="cb9-3">q5_answer</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
  Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1         q5     0.05      0.02     0.01     0.09      47.19      0.98    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;">plot</span>(q5_answer)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can now return to <code>Evid.Ratio</code> and <code>Post.Prob</code>: The latter indicates the posterior probability that the parameter of interest is greater than zero (<code>&gt; 0</code>). (More accurately, the proportion of samples from the posterior that are greater than zero.) That should correspond to what you see in the figure above. The former is the ratio of the hypothesis and its complement (the ratio of <code>time &gt; 0</code> and <code>time &lt; 0</code>). I find posterior probabilities more intuitive than evidence ratios, but they both return essentially the same information. Perhaps of interest, with uniform priors, posterior probabilities will exactly correspond (numerically, not conceptually) to frequentist one-sided p-values (<a href="https://www.ejwagenmakers.com/2017/MarsmanWagenmakers2017ThreeInsights.pdf">Marsman &amp; Wagenmakers, 2017</a>).</p>
</section>
<section id="multiple-hypotheses" class="level3">
<h3 class="anchored" data-anchor-id="multiple-hypotheses">Multiple hypotheses</h3>
<p>You can evaluate multiple hypotheses in one function call:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_2a0c2a85503c24ef96fd2b2d908662f6">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">hypothesis</span>(fit, <span class="fu" style="color: #4758AB;">c</span>(q2, q4, q5))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
  Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1         q2     0.11      0.02     0.06     0.16         NA        NA    *
2         q4     0.88      0.40     0.05     1.66         NA        NA    *
3         q5     0.05      0.02     0.01     0.09      47.19      0.98    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
</div>
</section>
<section id="hierarchical-hypotheses" class="level3">
<h3 class="anchored" data-anchor-id="hierarchical-hypotheses">Hierarchical hypotheses</h3>
<p>Up to this point, we have ‚Äútested‚Äù the model‚Äôs population level effects. (Parameters for the average person. ‚ÄúFixed effects.‚Äù) Because we fit a hierarchical model with varying intercepts and slopes of time, we can also test the individual specific parameters. For example, we can look at every individual‚Äôs estimated intercept (intimacy at time 0):</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_486814e3b005f81a7e064be6ba0663be">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">x <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(fit, <span class="st" style="color: #20794D;">"Intercept = 0"</span>, <span class="at" style="color: #657422;">group =</span> <span class="st" style="color: #20794D;">"id"</span>, <span class="at" style="color: #657422;">scope =</span> <span class="st" style="color: #20794D;">"coef"</span>)</span></code></pre></div>
</div>
<p>In the above, we asked for the results of the hypothesis test, split by group <code>id</code> (which is the grouping factor in our hierarchical model), and indicated <code>coef</code> as the scope. The latter means that the estimates are the subject-specific deviations with the fixed effect added, as opposed to <code>ranef</code>, which are zero-centered.</p>
<p>The results of this question would be a bit too much information to print on screen, so instead we will draw a figure:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_cf8b682c317093de2857b07a71a22e1c">
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>When you find that you have a brms model whose parameters don‚Äôt quite answer your questions, <code>hypothesis()</code> will probably give you the answer. For more advanced post-processing of your models, I recommend taking a look at the <a href="http://mjskay.github.io/tidybayes/">tidybayes</a> package.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2020,
  author = {Matti Vuorre},
  title = {How to Calculate Contrasts from a Fitted Brms Model},
  date = {2020-02-06},
  url = {https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2020" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2020. <span>‚ÄúHow to Calculate Contrasts from a Fitted Brms
Model.‚Äù</span> February 6, 2020. <a href="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model">https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>brms</category>
  <guid>https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index.html</guid>
  <pubDate>Thu, 06 Feb 2020 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2020-02-06-how-to-calculate-contrasts-from-a-fitted-brms-model/index_files/figure-html/figure-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>How to analyze visual analog (slider) scale data?</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In psychological experiments, subjective responses are often collected using two types of response scales: ordinal and visual analog scales. These scales are unlikely to provide normally distributed data. However, researchers often analyze responses from these scales with models that assume normality of the data.<sup>1</sup></p>
<p>Ordinal scales, of which binary ratings are a special case, provide ordinal data and are thus better analyzed using ordinal models <span class="citation" data-cites="BurknerOrdinalRegressionModels2019 LiddellAnalyzingOrdinalData2018">(B√ºrkner and Vuorre 2019; Liddell and Kruschke 2018)</span>.</p>
<p>Analog scales, also known as slider scales, are also unlikely to provide normally distributed responses because the scale is bounded at the low and high ends. These responses also tend to be skewed. It is common for slider responses to bunch at either end of the slider scale, potentially making the deviation from normality more severe.</p>
<p>For example, Figure&nbsp;1 shows a slider scale in action. (I found this random example with a simple internet search at <a href="https://blog.surveyhero.com/2018/09/03/new-question-type-slider/" class="uri">https://blog.surveyhero.com/2018/09/03/new-question-type-slider/</a>). In experiments using slider scales, subjects are typically instructed to use their mouse to drag a response indicator along a horizontal line, and/or click with a mouse on a point of the scale that matches their subjective impression. Sometimes these responses are provided on paper, where subjects are asked to bisect a line at a point that matches their subjective feeling (e.g.&nbsp;halfway between ‚ÄúLeisure‚Äù and ‚ÄúMoney‚Äù if they are subjectively equally important.)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-vas_d49fde4a4c4c62f226b259ae88878eb6">
<div class="cell-output-display">
<div id="fig-vas" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/vas.gif" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Example slider scale from https://blog.surveyhero.com/2018/09/03/new-question-type-slider/</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>These analog ratings are sometimes thought to be ‚Äòbetter‚Äô than discrete ordinal ratings (Likert item responses) because of the greater resolution of the slider scale. The scale‚Äôs resolution is limited only by the resolution of the monitor: For example, if the rating scale is 100 pixels wide, there are 100 possible values for the ratings. It is not unthinkable that such ratings can be considered continuous between the low and high endpoints. However, they are often not well described by the normal distribution.</p>
<section id="normal-model-of-slider-ratings" class="level2">
<h2 class="anchored" data-anchor-id="normal-model-of-slider-ratings">Normal model of slider ratings</h2>
<p>Consider Figure&nbsp;2. This figure shows 200 simulated ratings on a [0, 1] slider scale (meaning that any value between 0 and 1, inclusive of the endpoints, is possible). I have also superimposed a blue curve of the best-fitting normal density on the histogram. The two most notable non-normal features of these data are that they are bounded at 0 and 1 where the data appears to ‚Äúbunch‚Äù, and (possibly) skewed. Of course, these data were simulated; experience with slider scales tells me, however, that this histogram is not unrepresentative of such ratings.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-simulate-example_1387ec0834bc4477a1f4ba455cf43422">
<div class="cell-output-display">
<div id="fig-simulate-example" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-simulate-example-1.png" class="img-fluid figure-img" width="480"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Histogram of 200 simulated slider scale ratings, with a superimposed best-fitting density curve from a normal distribution.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>While the height of the blue curve is not comparable to the heights of the bars (one represents a density, the other counts of observations in rating bins), it should be apparent that features of the rating scale data make the blue normal curve a poor representation of the data.</p>
<p>First, the skew apparent in the data is not captured by the normal density curve. Second, and perhaps more important, the blue curve does not respect the 0 and 1 boundaries of the slider scale data.</p>
<p>Focus on this latter point: We can see that the blue curve assigns density to areas outside the possible values: The model predicts impossible values with alarming frequency. Second, the boundary values 0.0 and 1.0 do not receive any special treatment under the normal model, but we can see that the data are bunched at the boundaries. The great frequency of responses at 0.0 and 1.0 leads to large prediction errors from the normal model of these data.</p>
<p>In other words, (simulated) subjects tend to give many extreme ratings. This is especially apparent in the low end of the rating scale, where the continuous spread of scores tapers off, but then there is a large spike of ratings at zero. The normal model misses these features of the data, and may therefore lead to unrepresentative estimates of the data generating process, and even erroneous conclusions.</p>
</section>
<section id="toward-a-better-model" class="level2">
<h2 class="anchored" data-anchor-id="toward-a-better-model">Toward a better model</h2>
<p>More generally, if your goal is to predict cognition and behavior <span class="citation" data-cites="YarkoniChoosingPredictionExplanation2017">(Yarkoni and Westfall 2017)</span>, a model that is obviously a poor representation of your data‚Äîin terms of having such a poor predictive utility‚Äîshould not be your first choice for data analysis.</p>
<p>Admittedly, the data in Figure&nbsp;2 were simulated, and it remains an empirical question as to how common these features are in real data, and how severe these issues are to normal models (t-test, ANOVA, correlation, etc.).</p>
<p>Nevertheless, it would be desirable to have an accessible data-analytic model for slider scale data, whose assumption better match observed features of the data. Here, I introduce one such model‚Äîthe zero-one-inflated beta (ZOIB) model‚Äîand show how it can be applied to real data using the R package brms <span class="citation" data-cites="BurknerBrmsPackageBayesian2017">(B√ºrkner 2017)</span>. I also compare this model to standard analyses of slider scale data and conclude that the ZOIB can provide more detailed and accurate inferences from data than its conventional counterparts.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/meme_fea791b67312972a519790a812746af9">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/zoidberg.jpg" class="img-fluid figure-img" width="240"></p>
<p></p><figcaption class="figure-caption">Dr.&nbsp;John A. Zoidberg thinks you should try a ZOIB model on your slider scale data.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-zero-one-inflated-beta-model" class="level1">
<h1>The zero-one-inflated beta model</h1>
<p>Above, we established‚Äîrather informally‚Äîthat normal models may be less than optimal for slider scale data. Of course, no model is the <em>correct</em> model of such data, but it would be desirable to use a model that best represents the data under study.</p>
<p>The model for analysis of slider scale data discussed here has been called the ‚Äúzero-one-inflated beta‚Äù model, or ZOIB <span class="citation" data-cites="LiuZoibPackageBayesian2015">(Liu and Kong 2015)</span>. It is a model of data in the closed [0, 1] interval, and has two components: A beta distribution for responses in the closed (0, 1) interval, and a bernoulli distribution for the binary {0, 1} responses. Under this model, predictors can affect either or both the continuous and binary responses, the proportion of binary responses, or the spread of the continuous ratings.</p>
<p>To understand ZOIB, let‚Äôs start with a closer look at the theoretical beta density.</p>
<section id="the-beta-distribution" class="level2">
<h2 class="anchored" data-anchor-id="the-beta-distribution">The beta distribution</h2>
<p>The beta distribution used in beta regression <span class="citation" data-cites="FerrariBetaRegressionModelling2004">(Ferrari and Cribari-Neto 2004)</span> is a model of data in the open (0, 1) interval. (i.e.&nbsp;all values from 0 to 1, but not 0 and 1 themselves, are permitted.)</p>
<p>The beta distribution typically has two parameters, which in R are called <code>shape1</code> and <code>shape2</code>. Together, they determine the location, spread, and skew of the distribution. Four example beta densities are shown in Figure&nbsp;3. Using R‚Äôs <code>dbeta()</code>, I drew four curves corresponding to beta densities with different <code>shape1</code> and <code>2</code> parameters.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-beta-distributions_77b48c6794176e948912869205427887">
<div class="cell-output-display">
<div id="fig-beta-distributions" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-beta-distributions-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Four examples of the beta density, corresponding to different shape parameters.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>This default parameterization is useful, for example, as a prior distribution for proportions: The <code>shape1</code> and <code>shape2</code> parameters can define the prior number of zeros and ones, respectively. For example, in the above figure, <code>dbeta(x, shape1 = 1, shape2 = 1)</code> results in a uniform prior over proportions, because the prior zeros and ones are 1 each.</p>
<p>However, for our purposes, it is more useful to parameterize the beta distribution with a mean and a precision. To convert the former parameterization to mean (which we‚Äôll call <img src="https://latex.codecogs.com/png.latex?%5Cmu"> (mu)) and precision (<img src="https://latex.codecogs.com/png.latex?%5Cphi"> (phi)), the following formulas can be used</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%5Cmbox%7Bshape1%7D%20&amp;=%20%5Cmu%20%5Cphi%20%5C%5C%0A%5Cmbox%7Bshape2%7D%20&amp;=%20(1%20-%20%5Cmu)%5Cphi%0A%5Cend%7Balign*%7D"></p>
<p>(This parameterization is provided in R in the PropBeta functions from the extraDist package, which calls the precision parameter, or <img src="https://latex.codecogs.com/png.latex?%5Cphi">, <code>size</code>.) Redrawing the figure from above with this parameterization using the <code>dprop()</code> function, we get the figure below.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/beta-reparameterized-distributions_6d43416edc798f0ea6ef572070c83111">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/beta-reparameterized-distributions-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Four examples of the reparameterized beta density (<code>dprop()</code>).</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Shown above are four density functions of the beta family, whose precision and mean are varied. The first (red line) is a beta distribution with precision = 1, and mean = 0.5. It results in a uniform distribution. If a subject gave random slider scale responses, they might look much like this distribution (any rating is equally probably as any other rating).</p>
<p>The second beta distribution (green line) has precision 10, and mean 0.2. It is heavily skewed to the right. The third distribution (teal line) has precision 10, and a mean of 0.9. The fourth one, most similar to a normal distribution, has precision 70 and mean 0.50 (purple line).</p>
<p>In beta regression, this family of distributions is used to model observations, and covariates can have effects on both the mean and precision parameters.</p>
<p>However, beta regression only allows outcomes in the open (0, 1) interval. We know that slider scales often result in a bunching of values at the boundaries, and these boundary values might be informative of the participants‚Äô cognition and behavior. To handle these extreme values, we can add a zero-one inflation process to the beta distribution.</p>
</section>
<section id="zero-one-inflation" class="level2">
<h2 class="anchored" data-anchor-id="zero-one-inflation">Zero-one inflation</h2>
<p>The zero-one-inflated beta (ZOIB) adds a separate discrete process for the {0, 1} values, using two additional parameters. Following convention, we shall call them <img src="https://latex.codecogs.com/png.latex?%5Calpha"> (alpha) and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> (gamma). These parameters describe the probability of an observation being a 0 or 1 (<img src="https://latex.codecogs.com/png.latex?%5Calpha">), and conditional on that, whether the observation was 1 (<img src="https://latex.codecogs.com/png.latex?%5Cgamma">).</p>
<p>In other words, the model of outcomes under ZOIB is described by four parameters. The first is <img src="https://latex.codecogs.com/png.latex?%5Calpha">, the probability that an observation is either 0 or 1. (Thus, <img src="https://latex.codecogs.com/png.latex?1-%5Calpha"> is the probability of a non-boundary observation.) If an observation is not 0 or 1, the datum is described by the beta distribution with some mean <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and precision <img src="https://latex.codecogs.com/png.latex?%5Cphi">. If an observation is 0 or 1, the probability of it being 1 is given by <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> (just like your usual model of binary outcomes, e.g.&nbsp;logistic regression). So you can think of the model as a kind of mixture of beta and logistic regressions, where the <img src="https://latex.codecogs.com/png.latex?%5Calpha"> parameter describes the mixing proportions. The mathematical representation of this model is given in <a href="https://cran.rstudio.com/web/packages/brms/vignettes/brms_families.html#zero-inflated-and-hurdle-models">this vignette</a> <span class="citation" data-cites="BurknerBrmsPackageBayesian2017">(B√ºrkner 2017)</span>.</p>
<p>To illustrate, I wrote a little function <code>rzoib()</code> that takes these parameters as arguments, and generates <code>n</code> random draws. Here is a histogram of 1k samples from four ZOIB distributions with various combinations of the parameters:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/zoib-distributions_4b0ffacde88a39739a5f0aa829a7ed2f">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/zoib-distributions-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Four different ZOIB distributions resulting from various combinations of the parameters. (Parameter names are abbreviated; a = alpha, g = gamma, etc.)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Take the first (red) one. <img src="https://latex.codecogs.com/png.latex?%5Calpha"> was set to zero, and therefore there are no observations exactly at zero or 1. Because <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200">, it doesn‚Äôt matter that <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> was set to 0.5. <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> is the conditional one probability, given that the observation was 0 or 1. Therefore, the first histogram only contains draws from a beta distribution with mean = 0.2, and precision = 6.</p>
<p>Next, take a look at the second (green) histogram. Here, <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200.1">, so 10% of the observations will be either 0 or 1. Of these 10%, 30% are ones (<img src="https://latex.codecogs.com/png.latex?%5Cgamma%20=%200.3">). The bulk of the distribution, 90%, are draws from a beta distribution with a mean = 0.5, and precision = 3.</p>
<p>The bottom two histograms are two more combinations of the four parameters. Try to understand how their shapes are explained by the specific parameter combinations.</p>
<p>In summary, ZOIB is a reasonable model of slider scale data that can capture their major features, has support for the entire [0, 1] range of data, and does not assign density to impossible values (unlike the normal model). It also has an intuitive way of dealing with the boundary values as a separate process, thus providing more nuanced information about the outcome variable under study.</p>
<p>Next, we discuss a regression model with ZOIB as the data model: We are most interested in how other variables affect or relate to the outcome variables under study (slider scale ratings). By modeling the four parameters of the ZOIB model on predictors, ZOIB regression allows us to do just that.</p>
</section>
</section>
<section id="zoib-regression" class="level1">
<h1>ZOIB regression</h1>
<p>In this example, we examine the ZOIB model in the context of one binary predictor variable (Group A vs B, a ‚Äúbetween subjects‚Äù manipulation).</p>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example data</h2>
<p>To illustrate the ZOIB model in action, I simulated a data set of 100 ratings from two groups, A and B. These data are shown in Figure&nbsp;4.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-zoib-example_f89e588e13fec1a98ff7bba3a1fdd2c7">
<div class="cell-output-display">
<div id="fig-zoib-example" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-zoib-example-1.png" class="img-fluid figure-img" width="288"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Simulated data set of two group‚Äôs slider scale ratings, with means and bootstrapped 95% CIs in blue. The ratings are jittered horizontally to reveal overlapping data points.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/zoib-exampletab_0d983374bb6eba9277ef29281c5fb222">

</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/ex-ttest_d167746b8fa2757ccdc3bab5adb7c10c">

</div>
<p>We are interested in the extent to which Group A‚Äôs ratings differ from Group B‚Äôs ratings. It is common practice to address this question with a t-test, treating the ratings as normally distributed within each group. I compared the two groups‚Äô means with a t-test: The difference was not statistically significant (B - A = 0.06, 95%CI = [-0.07, 0.2], p=0.340). I‚Äôve also heard that you can do something called a Mann-Whitney U test, or a Kruskal-Wallis test when you have a categorical predictor and don‚Äôt want to assume a parametric form for your outcomes. I tried those as well. Neither of these nonparametric tests were significant (p=0.226; p=0.225). I therefore concluded that I was unable to reject the null hypothesis that Group A and Group B‚Äôs population means are not different.</p>
<p>But as can be seen from Figure&nbsp;2, the normal model makes unreasonable assumptions about these ratings. We see in Figure&nbsp;4 that there are many non-normal features in this example data set; e.g.&nbsp;many values are bunched at 0.0 and 1.0. Let‚Äôs fit the ZOIB model on these data, and see if our conclusions differ. Spoiler alert: they do.</p>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>We will model the data as ZOIB, and use <code>group</code> as a predictor of the mean and precision of the beta distribution, the zero-one inflation probability <img src="https://latex.codecogs.com/png.latex?%5Calpha">, and the conditional one-inflation probability <img src="https://latex.codecogs.com/png.latex?%5Cgamma">. In other words, in this model <code>group</code> may affect the mean and/or precision of the assumed beta distribution of the continuous ratings (0, 1), and/or the probability with which a binary rating is given, and/or the probability that a binary rating is 1. How do we estimate this model?</p>
<p>It might not come as a surprise that we estimate the model with bayesian methods, using the R package brms <span class="citation" data-cites="BurknerBrmsPackageBayesian2017">(B√ºrkner 2017)</span>. Previously, I have discussed how to estimate signal detection theoretic models, ‚Äúrobust models‚Äù, and other multilevel models using this package. I‚Äôm a big fan of brms because of its modeling flexibility and post-processing functions: With concise syntax, you can fit a wide variety of possibly nonlinear, multivariate, and multilevel models, and analyze and visualize the models‚Äô results.</p>
<p>Let‚Äôs load the package, and start building our model.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(brms)</span></code></pre></div>
</div>
<p>The R formula syntax allows a concise representation of regression models in the form of <code>response ~ predictors</code>. For a simple normal (i.e.&nbsp;gaussian) model of the mean of <code>Ratings</code> as a function of <code>group</code>, you could write <code>Ratings ~ group, family = gaussian</code>. However, we want to predict the four parameters of the ZOIB model, and so will need to expand this notation.</p>
<p>The brms package allows modeling more than one parameter of an outcome distribution. Specifically, we want to predict so-called ‚Äúdistributional parameters‚Äù, and <code>bf()</code> allows predicting them in their own formulas. Implicitly, <code>Ratings ~ group</code> means that you want to model the <em>mean</em> of <code>Ratings</code> on <code>group</code>. Therefore, to model <img src="https://latex.codecogs.com/png.latex?%5Cphi">, <img src="https://latex.codecogs.com/png.latex?%5Calpha">, and <img src="https://latex.codecogs.com/png.latex?%5Cgamma">, we will give them their own regression formulas within a call to <code>bf()</code>:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/brms-bf_1852a8e969083f61e39a4efa79ee547a">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">zoib_model <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb2-2">  Rating <span class="sc" style="color: #5E5E5E;">~</span> group,</span>
<span id="cb2-3">  phi <span class="sc" style="color: #5E5E5E;">~</span> group,</span>
<span id="cb2-4">  zoi <span class="sc" style="color: #5E5E5E;">~</span> group,</span>
<span id="cb2-5">  coi <span class="sc" style="color: #5E5E5E;">~</span> group, </span>
<span id="cb2-6">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">zero_one_inflated_beta</span>()</span>
<span id="cb2-7">)</span></code></pre></div>
</div>
<p>The four sub-models of our model are, in order of appearance: 1. the model of the beta distribution‚Äôs mean (read, ‚Äúpredict <code>Rating</code>‚Äôs mean from <code>group</code>‚Äù). Then, 2. the model of <code>phi</code>; the beta distribution‚Äôs precision. 3. <code>zoi</code> is the zero-one inflation (<img src="https://latex.codecogs.com/png.latex?%5Calpha">); that is, we model the probability of a binary rating as a function of <code>group</code>. 4. <code>coi</code> is the conditional one-inflation: Given that a response was {0, 1}, the probability of it being 1 is modelled on <code>group</code>.</p>
<p>As is usual in R‚Äôs formula syntax, the intercepts of each of these formulas are implicitly included. (To make intercepts explicit, use e.g.&nbsp;<code>Rating ~ 1 + group</code>.) Therefore, this model will have 8 parameters; the intercepts are Group A‚Äôs mean, <code>phi</code>, <code>zoi</code>, and <code>coi</code>. Then, there will be a Group B parameter for each of them, indicating the extent to which the parameters differ for Group B versus Group A.</p>
<p>If <code>group</code> has a positive effect on (the mean of) <code>Rating</code>, we may conclude that the continuous rating‚Äôs mean differs as function of Group. On the other hand, if <code>coi</code> is affected by <code>group</code>, Group has an effect on the binary {0, 1} ratings. If group has no effects on any of the parameters, we throw up our hands and design a new study.</p>
<p>Finally, we specified <code>family = zero_one_inflated_beta()</code>. Just like logistic regression, ZOIB regression is a type of generalized linear model. Therefore, each distributional parameter is modeled through a link function. The mean, zoi, and coi parameters are modeled through a logit link function. Phi is modeled through a log link function. These link functions can be changed by giving named arguments to <code>zero_one_inflated_beta()</code>. It is important to keep in mind the specific link functions, we will need them when interpreting the model‚Äôs parameters.</p>
<p>To estimate this model, we pass the resulting <code>zoib_model</code> to <code>brm()</code>, with a data frame from the current R environment, 4 CPU cores for speed, and a file argument to save the resulting model to disk. The last two arguments are optional.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;">formula =</span> zoib_model,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;">data =</span> dat,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"brm-zoib"</span></span>
<span id="cb3-6">)</span></code></pre></div>
</div>
<p>brms estimates the regression model using bayesian methods: It will return random draws from the parameters‚Äô posterior distribution. It takes less than a minute to draw samples from this model. Let‚Äôs then interpret the estimated parameters (i.e.&nbsp;the numerical summaries of the posterior distribution):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_b6cba7b5785bbafe900170141d8864ce">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;">summary</span>(fit)</span>
<span id="cb4-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: zero_one_inflated_beta </span></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = logit; phi = log; zoi = logit; coi = logit </span></span>
<span id="cb4-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: Rating ~ group </span></span>
<span id="cb4-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          phi ~ group</span></span>
<span id="cb4-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          zoi ~ group</span></span>
<span id="cb4-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          coi ~ group</span></span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: dat (Number of observations: 100) </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb4-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb4-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept         0.33      0.16     0.03     0.64 1.00     7221     2600</span></span>
<span id="cb4-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## phi_Intercept     1.50      0.24     1.00     1.94 1.00     6306     3106</span></span>
<span id="cb4-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## zoi_Intercept    -0.80      0.32    -1.44    -0.18 1.00     7341     2983</span></span>
<span id="cb4-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## coi_Intercept     0.62      0.56    -0.40     1.75 1.00     6324     3166</span></span>
<span id="cb4-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## groupB            0.91      0.21     0.50     1.32 1.00     6770     2984</span></span>
<span id="cb4-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## phi_groupB        0.48      0.33    -0.15     1.14 1.00     5750     2654</span></span>
<span id="cb4-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## zoi_groupB        0.08      0.43    -0.75     0.91 1.00     7812     3178</span></span>
<span id="cb4-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## coi_groupB       -0.87      0.75    -2.35     0.52 1.00     6093     2866</span></span>
<span id="cb4-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb4-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb4-24"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb4-25"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>First, the summary of this model prints a paragraph of information about the model, such as the outcome family (ZOIB), link functions, etc. The regression coefficients are found under the ‚ÄúPopulation-Level Effects:‚Äù header. The columns of this section are ‚ÄúEstimate‚Äù, the posterior mean or point estimate of the parameter. ‚ÄúEst.Error‚Äù, the posterior standard deviation, or so called standard error of the parameter. Then, the lower and upper limit of the 95% Credible Interval. The two last columns are diagnostics of the model fitting procedure.</p>
<p>The first four rows of this describe the parameters for the baseline group (Group A). <code>Intercept</code> is the logit-transformed mean of the beta distribution for Group A‚Äôs ratings (the subset of ratings that were (0, 1)). Next, <code>phi_Intercept</code> describes the precision of the beta distribution fitted to Group A‚Äôs slider responses, on the scale of the (log) link function. <code>zoi_Intercept</code> is the zero or one inflation of Group A‚Äôs data, on the logit scale. <code>coi_Intercept</code> is the conditional one inflation; out of the 0 or 1 ratings in Group A‚Äôs data, describing the proportion of ones (out of the 0/1 responses)?</p>
<p>These parameters are described on the link scale, so for each of them, we can use the inverse link function to transform them to the response scale. Precision (<code>phi_Intercept</code>) was modeled on the log scale. Therefore, we can convert it back to the original scale by exponentiating. For the other parameters, which were modeled on the logit scale, we can use the inverse, which is <code>plogis()</code>.</p>
<p>However, before converting the parameters, it is important to note that the estimates displayed above are summaries (means, quantiles) of the posterior draws of the parameters on the link function scale. Therefore, we cannot simply convert the summaries. Instead, we must transform each of the posterior samples, and then re-calculate the summaries. The following code accomplishes this ‚Äútransform-then-summarize‚Äù procedure for each of the four parameters:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_5d9fc5fcbfff575b48f050ddbd6a1e8f">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">posterior_samples</span>(fit, <span class="at" style="color: #657422;">pars =</span> <span class="st" style="color: #20794D;">"b_"</span>)[,<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">4</span>] <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"b_phi_Intercept"</span>), exp) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="st" style="color: #20794D;">"b_phi_Intercept"</span>), plogis) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;">posterior_summary</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;">as.data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;">rownames_to_column</span>(<span class="st" style="color: #20794D;">"Parameter"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;">kable</span>(<span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>) </span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Est.Error</th>
<th style="text-align: right;">Q2.5</th>
<th style="text-align: right;">Q97.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">b_Intercept</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">0.66</td>
</tr>
<tr class="even">
<td style="text-align: left;">b_phi_Intercept</td>
<td style="text-align: right;">4.59</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">2.72</td>
<td style="text-align: right;">6.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">b_zoi_Intercept</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.45</td>
</tr>
<tr class="even">
<td style="text-align: left;">b_coi_Intercept</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.85</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can then interpret these summaries, beginning with <code>b_Intercept</code>. This is the estimated mean of the beta distribution fitted to Group A‚Äôs (0, 1) rating scale responses (with its standard error, lower- and upper limits of the 95% CI). Then, <code>b_Phi_Intercept</code> is the precision of the beta distribution. <code>zoi</code> is the zero-one inflation, and <code>coi</code> the conditional one inflation.</p>
<p>To make <code>b_zoi_Intercept</code> concrete, we should be able to compare its posterior mean to the observed proportion of 0/1 values in the data:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_d32c7eaac5ed6e62ffc18a46f8f950da">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">mean</span>(dat<span class="sc" style="color: #5E5E5E;">$</span>Rating[dat<span class="sc" style="color: #5E5E5E;">$</span>group<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"A"</span>] <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">round</span>(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb6-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## [1] 0.311</span></span></code></pre></div>
</div>
<p>Above we calculated the proportion of zeros and ones in the data set, and found that it matches the estimated value. Similarly, for <code>coi</code>, we can find the corresponding value from the data:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_ac6dca96dcaa50a7b9d6ca452b14e19b">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">mean</span>(dat<span class="sc" style="color: #5E5E5E;">$</span>Rating[dat<span class="sc" style="color: #5E5E5E;">$</span>group<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"A"</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> dat<span class="sc" style="color: #5E5E5E;">$</span>Rating <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">1</span>] <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;">round</span>(<span class="dv" style="color: #AD0000;">3</span>)</span>
<span id="cb7-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## [1] 0.643</span></span></code></pre></div>
</div>
<p>Let‚Äôs get back to the model summary output. The following four parameters are the effects of being in group B on these parameters. Most importantly, <code>groupB</code> is the effect of group B (versus group A) on the mean of the ratings‚Äô assumed beta distribution, in the logit scale. Immediately, we can see that the parameter‚Äôs 95% Credible Interval does not include zero. Traditionally, this parameter would be called ‚Äúsignificant‚Äù; group B‚Äôs (0, 1) ratings are on average greater than group A‚Äôs.</p>
<p>To transform this effect back to the data scale, we can again use <code>plogis()</code>. However, it is important to keep in mind that the effect‚Äôs size on the original scale depends on the intercept, getting smaller as the intercept increases (just like in any other generalized linear model.) The following bit of code transforms this effect and its uncertainty back to the original scale.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_7d26594ef60e0ef3eaed6747388bd71a">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">h <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"B - A"</span> <span class="ot" style="color: #003B4F;">=</span> <span class="st" style="color: #20794D;">"plogis(Intercept + groupB) = plogis(Intercept)"</span>)</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;">hypothesis</span>(fit, h)</span>
<span id="cb8-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Hypothesis Tests for class b:</span></span>
<span id="cb8-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star</span></span>
<span id="cb8-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1      B - A     0.19      0.05      0.1     0.28         NA        NA    *</span></span>
<span id="cb8-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb8-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.</span></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## '*': For one-sided hypotheses, the posterior probability exceeds 95%;</span></span>
<span id="cb8-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## for two-sided hypotheses, the value tested against lies outside the 95%-CI.</span></span>
<span id="cb8-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Posterior probabilities of point hypotheses assume equal prior probabilities.</span></span></code></pre></div>
</div>
<p>The data were simulated with the <code>rzoib()</code> function, and I set <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200.25,%20%5Cgamma%20=%200.5,%20%5Cmu%20=%200.6%20+%200.15%5Cmbox%7BgroupB%7D,%20%5Cphi%20=%205">. Therefore, the results of the t-tests and nonparametric tests were misses; a true effect was missed. On the other hand, the ZOIB regression model detected the true effect of group on the beta distribution‚Äôs mean.</p>
<p>Finally, let‚Äôs visualize this key finding using the <code>conditional_effects()</code> function from brms.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-ex-me_aed1f396fa2dcf093960d34d14e062b2">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">plot</span>(</span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;">conditional_effects</span>(fit, <span class="at" style="color: #657422;">dpar =</span> <span class="st" style="color: #20794D;">"mu"</span>), </span>
<span id="cb9-3">  <span class="at" style="color: #657422;">points =</span> <span class="cn" style="color: #8f5902;">TRUE</span>, </span>
<span id="cb9-4">  <span class="at" style="color: #657422;">point_args =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">width =</span> .<span class="dv" style="color: #AD0000;">05</span>, <span class="at" style="color: #657422;">shape =</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb9-5">)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-ex-me" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-ex-me-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;5: Estimated mu parameters from the example ZOIB fit, as filled points and error bars (95% CIs), with the original data (empty circles).</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Comparing Figure&nbsp;5 to Figure&nbsp;4 reveals the fundamental difference of the normal t-test model, and the ZOIB model: The ZOIB regression (Figure&nbsp;5) has found a large difference between the continuous part of the slider ratings‚Äô means because it has treated the data with an appropriate model. By conflating the continuous and binary data, the t-test did not detect this difference.</p>
<p>In conclusion, this example showed that ZOIB results in more informative, and potentially more accurate, inferences from analog scale (‚Äúslider‚Äù) data. Of course, in this simulation we had the benefit of knowing the true state of matters: The data were simulated from a ZOIB model. Nevertheless, we have reasoned that by respecting the major features of slider scale data, the ZOIB is a more accurate representation of it, and was therefore able to detect a difference where the t-test did not. Next, I put this conjecture to a test by conducting a small simulation study.</p>
</section>
</section>
<section id="simulation-compare-zoib-and-t-test-performances" class="level1">
<h1>Simulation: Compare ZOIB and t-test performances</h1>
<p>To compare the performance of the t-test and ZOIB in a little bit more detail, I conducted a small simulation study. I simulated 100 data sets of 200 ratings from two independent groups, from the ZOIB model (100 ratings per group). I set <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%200.2,%20%5Cgamma%20=%200.7,%20%5Cmu%20=%200.6%20+%200.1%5Cmbox%7BgroupB%7D,%20%5Cphi%20=%205">; that is, there was a small effect of group on the mean of the beta distribution, and all other parameters were constant across groups. A sample of the resulting data sets is shown in Figure&nbsp;6.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/zoib-sim-1_91ebf9ab74e950b4005676b8b8abf427">

</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-sim-examplesets_03586da8508d5d58d42a692663107647">
<div class="cell-output-display">
<div id="fig-sim-examplesets" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-sim-examplesets-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;6: Six randomly selected simulated data sets. Points are individual ratings (jittered to show overlapping points), while blue symbols indicate the means and bootstrapped 95% CIs.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sim-sig-ttests_5b758580ad7ad2a0cbfb37d54f6af372">

</div>
<p>I first conducted an independent samples, unequal variances t-test on each of the 100 simulated data sets, comparing the two groups‚Äô mean ratings. 35% of these t-tests were significantly positive at the .05 level. That is, the power of the t-test in this simulation was about 35%. (Uncertainty in this value is moderate, because I only did 100 simulation runs.)</p>
<div class="cell" data-layout-align="center">

</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sim-sig-brms_a2d3b32c194bda0a063d87cb01f5f792">

</div>
<p>I then estimated the ZOIB model for each of the 100 simulated data sets. Statistical significance does not play a role in Bayesian statistics, but to most easily compare the results of these two models, I calculated the proportion of simulations for which the estimated Group on <img src="https://latex.codecogs.com/png.latex?%5Cmu"> effect‚Äôs 95% Credible Interval was entirely above zero. If a 95% CI does not include zero, disrespecting the philosophical differences of bayesian and frequentist statistics, I may say that the estimate is ‚Äúsignificant‚Äù.</p>
<p>This parameter was significantly greater than zero in 66% of the ZOIB models estimated on the same 100 simulated data sets. That is, the power of this model to detect an effect was much greater than the power of the t-test. These results are illustrated in Figure&nbsp;7.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-sims-compare_86473af857a11cf2e39a1f2b4a67b7af">
<div class="cell-output-display">
<div id="fig-sims-compare" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/fig-sims-compare-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7: Results of the simulation study. Top: the estimated mean difference and 95% CI of the two groups‚Äô ratings, as estimated by a t-test. Red = not statistically significant; blue = statistically significant. The data sets are ordered on the x axis on the estimated mean difference. Bottom: simulation results of the ZOIB model. Same as the top panel, but the estimated parameter is the difference between the two group‚Äôs mu parameters of the beta distribution. (I back-transformed the mu parameter from the logit scale to the data scale to make the results numerically more comparable across the t-test and ZOIB models.) In both panels, the horizontal green line indicates the true effect used in the simulations.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As can be seen in this figure, in this particular setup, the t-tests severely underperformed in detecting a true effect when compared to the ZOIB model. Of course, this is to be expected, because the data were generated from the ZOIB model.</p>
<p>Out there in the wild, which of these models is closer to the true data generating process for slider scale ratings? Normal models, or ZOIB? (Or, most likely, some other class of models?) As we have seen, normal models may be poor representations of bounded and skewed slider scale data. It is therefore possible that the routine use of normal models in analyzing slider scale data can result in missing true effects at a rate higher than indicated by conventional power analyses.</p>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>I have not extensively reviewed the performance of the ZOIB model in this blog post. Neither did I analyze real slider scale data. Therefore, I can not and would not recommend exclusively favoring the ZOIB model over normal models for the analysis of slider scale data. However, I can recommend at least trying ZOIB for your own slider scale data, and thinking about what models might best fit your data if they appear non normal.</p>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>There are many limitations to the current discussion, and the simulation studies should be considerably expanded to more realistic and variable situations.</p>
<p>One limitation of the ZOIB model might be what I here discussed as its main benefit. ZOIB separates the binary and continuous processes, such that a predictor‚Äôs effect on one or both of them are independent in the model. However, it is likely that these two processes are somehow correlated. Thus, ZOIB does not give only one ‚Äúeffect‚Äù of a predictor on the ratings, but two, one for the continuous part, and one for the binary. By not getting a single effect, if nothing else, the model is more complex and probably more difficult to analyze and/or explain.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<p>The beta regression model has previously been discussed as a reasonable model of data in the open (0, 1) interval <span class="citation" data-cites="FerrariBetaRegressionModelling2004">(Ferrari and Cribari-Neto 2004)</span>. It‚Äôs application in psychological studies has also been discussed by <span class="citation" data-cites="SmithsonBetterLemonSqueezer2006 VerkuilenMixedMixtureRegression2012">(Smithson and Verkuilen 2006; see also Verkuilen and Smithson 2012)</span>. These earlier papers recommended that values at the 0 and 1 boundaries be somehow transformed to make the data suitable for the model, but transforming the data such that a model can be fitted seems like a bad idea.</p>
<p>Mixtures of beta and discrete models were discussed by <span class="citation" data-cites="OspinaInflatedBetaDistributions2008">Ospina and Ferrari (2008)</span>, and an R package for estimation of the ZOIB model was introduced by <span class="citation" data-cites="LiuZoibPackageBayesian2015">Liu and Kong (2015)</span>. <span class="citation" data-cites="LiuReviewComparisonBayesian2018">Liu and Eugenio (2018)</span> found that ZOIB models are better estimated with Bayesian methods than with maximum likelihood methods.</p>
<p>More information about the brms package can be found in <span class="citation" data-cites="BurknerBrmsPackageBayesian2017">B√ºrkner (2017)</span>, and in the excellent vignettes at <a href="https://cran.rstudio.com/web/packages/brms/" class="uri">https://cran.rstudio.com/web/packages/brms/</a>.</p>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-BurknerBrmsPackageBayesian2017" class="csl-entry">
B√ºrkner, Paul-Christian. 2017. <span>‚ÄúBrms: <span>An</span> <span>R</span> <span>Package</span> for <span>Bayesian</span> <span>Multilevel</span> <span>Models</span> <span>Using</span> <span>Stan</span>.‚Äù</span> <em>Journal of Statistical Software</em> 80 (1): 1‚Äì28. <a href="https://doi.org/10.18637/jss.v080.i01">https://doi.org/10.18637/jss.v080.i01</a>.
</div>
<div id="ref-BurknerOrdinalRegressionModels2019" class="csl-entry">
B√ºrkner, Paul-Christian, and Matti Vuorre. 2019. <span>‚ÄúOrdinal <span>Regression</span> <span>Models</span> in <span>Psychology</span>: <span>A</span> <span>Tutorial</span>.‚Äù</span> <em>Advances in Methods and Practices in Psychological Science</em> 2 (1): 77‚Äì101. <a href="https://doi.org/10.1177/2515245918823199">https://doi.org/10.1177/2515245918823199</a>.
</div>
<div id="ref-FerrariBetaRegressionModelling2004" class="csl-entry">
Ferrari, Silvia, and Francisco Cribari-Neto. 2004. <span>‚ÄúBeta <span>Regression</span> for <span>Modelling</span> <span>Rates</span> and <span>Proportions</span>.‚Äù</span> <em>Journal of Applied Statistics</em> 31 (7): 799‚Äì815. <a href="https://doi.org/10.1080/0266476042000214501">https://doi.org/10.1080/0266476042000214501</a>.
</div>
<div id="ref-LiddellAnalyzingOrdinalData2018" class="csl-entry">
Liddell, Torrin M., and John K. Kruschke. 2018. <span>‚ÄúAnalyzing Ordinal Data with Metric Models: <span>What</span> Could Possibly Go Wrong?‚Äù</span> <em>Journal of Experimental Social Psychology</em> 79 (November): 328‚Äì48. <a href="https://doi.org/10.1016/j.jesp.2018.08.009">https://doi.org/10.1016/j.jesp.2018.08.009</a>.
</div>
<div id="ref-LiuReviewComparisonBayesian2018" class="csl-entry">
Liu, Fang, and Evercita C Eugenio. 2018. <span>‚ÄúA Review and Comparison of <span>Bayesian</span> and Likelihood-Based Inferences in Beta Regression and Zero-or-One-Inflated Beta Regression.‚Äù</span> <em>Statistical Methods in Medical Research</em> 27 (4): 1024‚Äì44. <a href="https://doi.org/10.1177/0962280216650699">https://doi.org/10.1177/0962280216650699</a>.
</div>
<div id="ref-LiuZoibPackageBayesian2015" class="csl-entry">
Liu, Fang, and Yunchuan Kong. 2015. <span>‚ÄúZoib: <span>An</span> <span>R</span> <span>Package</span> for <span>Bayesian</span> <span>Inference</span> for <span>Beta</span> <span>Regression</span> and <span>Zero</span>/<span>One</span> <span>Inflated</span> <span>Beta</span> <span>Regression</span>.‚Äù</span> <em>The R Journal</em> 7 (2): 34‚Äì51. <a href="https://journal.r-project.org/archive/2015/RJ-2015-019/index.html">https://journal.r-project.org/archive/2015/RJ-2015-019/index.html</a>.
</div>
<div id="ref-OspinaInflatedBetaDistributions2008" class="csl-entry">
Ospina, Raydonal, and Silvia L. P. Ferrari. 2008. <span>‚ÄúInflated Beta Distributions.‚Äù</span> <em>Statistical Papers</em> 51 (1): 111. <a href="https://doi.org/10.1007/s00362-008-0125-4">https://doi.org/10.1007/s00362-008-0125-4</a>.
</div>
<div id="ref-SmithsonBetterLemonSqueezer2006" class="csl-entry">
Smithson, Michael, and Jay Verkuilen. 2006. <span>‚ÄúA Better Lemon Squeezer? <span>Maximum</span>-Likelihood Regression with Beta-Distributed Dependent Variables.‚Äù</span> <em>Psychological Methods</em> 11 (1): 54‚Äì71. <a href="https://doi.org/10.1037/1082-989X.11.1.54">https://doi.org/10.1037/1082-989X.11.1.54</a>.
</div>
<div id="ref-VerkuilenMixedMixtureRegression2012" class="csl-entry">
Verkuilen, Jay, and Michael Smithson. 2012. <span>‚ÄúMixed and <span>Mixture</span> <span>Regression</span> <span>Models</span> for <span>Continuous</span> <span>Bounded</span> <span>Responses</span> <span>Using</span> the <span>Beta</span> <span>Distribution</span>.‚Äù</span> <em>Journal of Educational and Behavioral Statistics</em> 37 (1): 82‚Äì113. <a href="https://doi.org/10.3102/1076998610396895">https://doi.org/10.3102/1076998610396895</a>.
</div>
<div id="ref-YarkoniChoosingPredictionExplanation2017" class="csl-entry">
Yarkoni, Tal, and Jacob Westfall. 2017. <span>‚ÄúChoosing <span>Prediction</span> <span>Over</span> <span>Explanation</span> in <span>Psychology</span>: <span>Lessons</span> <span>From</span> <span>Machine</span> <span>Learning</span>.‚Äù</span> <em>Perspectives on Psychological Science</em> 12 (6): 1100‚Äì1122. <a href="https://doi.org/10.1177/1745691617693393">https://doi.org/10.1177/1745691617693393</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Technically, normal models assume that the residuals are normally distributed. I will keep referring to data being normally distributed or not, for clarity.‚Ü©Ô∏é</p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2019,
  author = {Matti Vuorre},
  title = {How to Analyze Visual Analog (Slider) Scale Data?},
  date = {2019-02-18},
  url = {https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2019" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2019. <span>‚ÄúHow to Analyze Visual Analog (Slider) Scale
Data?‚Äù</span> February 18, 2019. <a href="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models">https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models</a>.
</div></div></section></div> ]]></description>
  <category>psychology</category>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>brms</category>
  <guid>https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index.html</guid>
  <pubDate>Mon, 18 Feb 2019 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2019-02-18-analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/index_files/figure-html/beta-distributions-1.png" medium="image" type="image/png" height="70" width="144"/>
</item>
<item>
  <title>Combine ggplots with patchwork</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index.html</link>
  <description><![CDATA[ 




<p><a href="https://ggplot2.tidyverse.org/">ggplot2</a> is the best R package for data visualization, and has powerful features for ‚Äúfacetting‚Äù plots into small multiples based on categorical variables.</p>
<section id="facetting-figures-into-small-multiples" class="level2">
<h2 class="anchored" data-anchor-id="facetting-figures-into-small-multiples">Facetting figures into small multiples</h2>
<p>This ‚Äúfacetting‚Äù is useful for showing the same figure, e.g.&nbsp;a bivariate relationship, at multiple levels of some other variable</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;">aes</span>(mpg, disp)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;">geom_point</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-4">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"cyl"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>But if you would like to get a figure that consists of multiple panels of unrelated plots‚Äîwith different variables on the X and Y axes, potentially from different data sources‚Äîthings become more complicated.</p>
</section>
<section id="combining-arbitrary-ggplots" class="level2">
<h2 class="anchored" data-anchor-id="combining-arbitrary-ggplots">Combining arbitrary ggplots</h2>
<p>Say you have these three figures</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">p <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggplot</span>(mtcars)</span>
<span id="cb2-2">  </span>
<span id="cb2-3">a <span class="ot" style="color: #003B4F;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;">aes</span>(mpg, disp, <span class="at" style="color: #657422;">col =</span> <span class="fu" style="color: #4758AB;">as.factor</span>(vs)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;">geom_smooth</span>(<span class="at" style="color: #657422;">se =</span> F) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;">geom_point</span>()</span>
<span id="cb2-7"></span>
<span id="cb2-8">b <span class="ot" style="color: #003B4F;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;">aes</span>(disp, gear, <span class="at" style="color: #657422;">group =</span> gear) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-10">  ggstance<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">geom_boxploth</span>()</span>
<span id="cb2-11"></span>
<span id="cb2-12">c <span class="ot" style="color: #003B4F;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;">aes</span>(hp) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;">stat_density</span>(<span class="at" style="color: #657422;">geom =</span> <span class="st" style="color: #20794D;">"area"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;">coord_cartesian</span>(<span class="at" style="color: #657422;">expand =</span> <span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
</div>
<p>How would you go about combining them? There are a few options, such as <code>grid.arrange()</code> in the <a href="https://cran.r-project.org/web/packages/gridExtra/index.html">gridExtra</a> package, and <code>plot_grid()</code> in the <a href="https://cran.r-project.org/web/packages/cowplot/vignettes/plot_grid.html">cowplot</a> package. Today, I‚Äôll point out a newer package that introduces a whole new syntax for combining together, <a href="https://github.com/thomasp85/patchwork">patchwork</a>.</p>
</section>
<section id="patchwork" class="level2">
<h2 class="anchored" data-anchor-id="patchwork">Patchwork</h2>
<p>patchwork is not yet on CRAN, so install it from GitHub:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;"># install.packages("devtools")</span></span>
<span id="cb3-2">devtools<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">install_github</span>(<span class="st" style="color: #20794D;">"thomasp85/patchwork"</span>)</span></code></pre></div>
</div>
<p>Once you load the package, you can add ggplots together by adding them with <code>+</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;">library</span>(patchwork)</span>
<span id="cb4-2">a <span class="sc" style="color: #5E5E5E;">+</span> b <span class="sc" style="color: #5E5E5E;">+</span> c</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Basically, you can add ggplots together as if they were geoms inside a single ggplot. However, there‚Äôs more. <code>|</code> specifies side-by-side addition</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">a <span class="sc" style="color: #5E5E5E;">|</span> c</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And <code>/</code> is for adding plots under the previous plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">b <span class="sc" style="color: #5E5E5E;">/</span> c</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These operators can be used to flexibly compose figures from multiple components, using parentheses to group plots and <code>+</code>, <code>|</code>, and <code>/</code> to add the groups together</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">(a <span class="sc" style="color: #5E5E5E;">|</span> b) <span class="sc" style="color: #5E5E5E;">/</span> c</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Use <code>plot_annotation()</code> to add tags, and <code>&amp;</code> to pass theme elements to all plot elements in a composition</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">(a <span class="sc" style="color: #5E5E5E;">|</span> b) <span class="sc" style="color: #5E5E5E;">/</span> c <span class="sc" style="color: #5E5E5E;">+</span> </span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;">plot_annotation</span>(<span class="at" style="color: #657422;">tag_levels =</span> <span class="st" style="color: #20794D;">"A"</span>) <span class="sc" style="color: #5E5E5E;">&amp;</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">legend.position =</span> <span class="st" style="color: #20794D;">"none"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/mainfig-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Tweak this a little bit and throw it in a manuscript.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>There are many more examples on <a href="https://github.com/thomasp85/patchwork">patchwork‚Äôs GitHub page</a>. I‚Äôve found this package more useful in composing figures out of multiple plots than its alternatives, mainly because of the concise but powerful syntax.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2018,
  author = {Matti Vuorre},
  title = {Combine Ggplots with Patchwork},
  date = {2018-12-13},
  url = {https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2018" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2018. <span>‚ÄúCombine Ggplots with Patchwork.‚Äù</span>
December 13, 2018. <a href="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork">https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork</a>.
</div></div></section></div> ]]></description>
  <category>data science</category>
  <category>visualization</category>
  <category>ggplot2</category>
  <category>R</category>
  <guid>https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index.html</guid>
  <pubDate>Thu, 13 Dec 2018 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2018-12-13-rpihkal-combine-ggplots-with-patchwork/index_files/figure-html/mainfig-1.png" medium="image" type="image/png" height="82" width="144"/>
</item>
<item>
  <title>Glue your strings together</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2018-12-12-rpihkal-stop-pasting-and-start-gluing/index.html</link>
  <description><![CDATA[ 




<p>We‚Äôve all been there; writing <a href="https://github.com/crsh/papaja">manuscripts</a> with <a href="https://rmarkdown.rstudio.com/">R Markdown</a> and dreaming of easy in-text code bits for reproducible reporting. Say you‚Äôve fit a regression model to your data, and would then like to report the model‚Äôs parameters in your text, without writing the values in the text. (If the data or model changes, you‚Äôd need to re-type the values again.)</p>
<p>For example, you can print this model summary easily in the R console:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_1d55d8b00819b38a1d9b8a2c4eaba991">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(mpg <span class="sc" style="color: #5E5E5E;">~</span> disp, <span class="at" style="color: #657422;">data =</span> mtcars)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">summary</span>(fit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = mpg ~ disp, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.8922 -2.2022 -0.9631  1.6272  7.2305 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 29.599855   1.229720  24.070  &lt; 2e-16 ***
disp        -0.041215   0.004712  -8.747 9.38e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.251 on 30 degrees of freedom
Multiple R-squared:  0.7183,    Adjusted R-squared:  0.709 
F-statistic: 76.51 on 1 and 30 DF,  p-value: 9.38e-10</code></pre>
</div>
</div>
<p>And to cite those values in the text body of your manuscript, you can write the text in R Markdown like this:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_b6d07cb8a933e2a8d357be12cdb3788c">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">The model intercept was <span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">r round(coef(fit)[1], 2)</span><span class="st" style="color: #20794D;">`</span>, great.</span></code></pre></div>
</div>
<p>Which would show up in your manuscript like this:</p>
<p>The model intercept was 29.6, great.</p>
<section id="paste" class="level2">
<h2 class="anchored" data-anchor-id="paste">Paste</h2>
<p>However, when you want to present more information, such as the parameter estimate with its standard error, you will have to <code>paste()</code> those strings together:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_366835565a5649d76ca7ecbfddb15497">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">(x <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">round</span>(<span class="fu" style="color: #4758AB;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;">$</span>coefficients, <span class="dv" style="color: #AD0000;">3</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)   29.600      1.230  24.070        0
disp          -0.041      0.005  -8.747        0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">intercept <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">paste</span>(<span class="st" style="color: #20794D;">"b = "</span>, x[<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>], <span class="st" style="color: #20794D;">", SE = "</span>, x[<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">2</span>], <span class="at" style="color: #657422;">sep =</span> <span class="st" style="color: #20794D;">""</span>)</span></code></pre></div>
</div>
<p>You can then just cite the <code>intercept</code> object in your text body:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_22c54f4cec02aea840f6173b9f095127">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">The model intercept was very very <span class="fu" style="color: #4758AB;">significant</span> (<span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">r intercept</span><span class="st" style="color: #20794D;">`</span>).</span></code></pre></div>
</div>
<p>Which would render in your PDF or word document as:</p>
<p>The model intercept was very very significant (b = 29.6, SE = 1.23).</p>
<p><code>paste()</code> is a base R function, and as such very robust and reproducible‚Äìall R installations will have it. However, as such it has a fairly terrible syntax where you have to quote strings, separate strings and variables with commas, etc. This task is made much easier with <code>glue()</code>.</p>
</section>
<section id="glue" class="level2">
<h2 class="anchored" data-anchor-id="glue">Glue</h2>
<p><a href="https://glue.tidyverse.org/">glue</a> is a small R package that allows you to join strings together in a neat, pythonific way. It replaces the need for quoting and separating arguments in <code>paste()</code>, by asking you to wrap variables in curly braces. Here‚Äôs how to do the above pasting with glue:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_866bccea6b1abb57c9eda7c96862ed47">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;">library</span>(glue)</span>
<span id="cb8-2">intercept <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">glue</span>(<span class="st" style="color: #20794D;">"b = {x[1, 1]}, SE = {x[1, 2]}"</span>)</span></code></pre></div>
</div>
<p>Which gives you the same string as the much messier <code>paste()</code> approach: b = 29.6, SE = 1.23</p>
<section id="glue-with-data-frames" class="level3">
<h3 class="anchored" data-anchor-id="glue-with-data-frames">Glue with data frames</h3>
<p>Glue has other neat (more advanced) features, such as gluing variables row-by-row in a data frame:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_ef356586f2856edca015da27ea96579b">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">library</span>(dplyr)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;">as.data.frame</span>(x) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;">glue_data</span>(</span>
<span id="cb9-4">    <span class="st" style="color: #20794D;">"{rownames(.)}'s point estimate was {Estimate}, with an SE of {`Std. Error`}."</span></span>
<span id="cb9-5">  )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)'s point estimate was 29.6, with an SE of 1.23.
disp's point estimate was -0.041, with an SE of 0.005.</code></pre>
</div>
</div>
</section>
</section>
<section id="appendix-papaja" class="level2">
<h2 class="anchored" data-anchor-id="appendix-papaja">Appendix: papaja</h2>
<p>For some models (like our simple linear model example here), the <a href="https://github.com/crsh/papaja">papaja R package</a> (which deserves its own rpihkal post!) has very useful shortcuts</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_e5b0a3fe2a4d085c9ce4e216c074a105">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;">library</span>(papaja)</span>
<span id="cb11-2">intercept <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apa_print</span>(fit)<span class="sc" style="color: #5E5E5E;">$</span>estimate<span class="sc" style="color: #5E5E5E;">$</span>Intercept</span></code></pre></div>
</div>
<p>If you now cite <code>intercept</code> in the text body of your manuscript, it renders into <img src="https://latex.codecogs.com/png.latex?%5CLaTeX"> (which is interpreted nicely if you are outputting PDF or Word documents; here on this website it looks odd):</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_887e8b3d753d5ffa1bf57423ff8600ab">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">The model intercept was rather <span class="fu" style="color: #4758AB;">significant</span> (<span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">r intercept</span><span class="st" style="color: #20794D;">`</span>).</span></code></pre></div>
</div>
<p>The model intercept was rather significant (<img src="https://latex.codecogs.com/png.latex?b%20=%2029.60">, 95% CI <img src="https://latex.codecogs.com/png.latex?%5B27.09,%2032.11%5D">).</p>
<p>Read more about glue at <a href="https://glue.tidyverse.org/" class="uri">https://glue.tidyverse.org/</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2018,
  author = {Matti Vuorre},
  title = {Glue Your Strings Together},
  date = {2018-12-12},
  url = {https://vuorre.netlify.app/posts/2018-12-12-rpihkal-stop-pasting-and-start-gluing},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2018" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2018. <span>‚ÄúGlue Your Strings Together.‚Äù</span> December
12, 2018. <a href="https://vuorre.netlify.app/posts/2018-12-12-rpihkal-stop-pasting-and-start-gluing">https://vuorre.netlify.app/posts/2018-12-12-rpihkal-stop-pasting-and-start-gluing</a>.
</div></div></section></div> ]]></description>
  <category>data science</category>
  <category>R</category>
  <guid>https://vuorre.netlify.app/posts/2018-12-12-rpihkal-stop-pasting-and-start-gluing/index.html</guid>
  <pubDate>Wed, 12 Dec 2018 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Bayesian Estimation of Signal Detection Models</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index.html</link>
  <description><![CDATA[ 




<section id="signal-detection-theory" class="level2">
<h2 class="anchored" data-anchor-id="signal-detection-theory">Signal Detection Theory</h2>
<p>Signal Detection Theory (SDT) is a common framework for modeling memory and perception. Calculating point estimates of equal variance Gaussian SDT parameters is easy using widely known formulas. More complex SDT models, such as the unequal variance SDT model, require more complicated modeling techniques. These models can be estimated using Bayesian (nonlinear and/or hierarchical) regression methods, which are sometimes difficult to implement in practice. In this tutorial, I describe how to estimate equal and unequal variance Gaussian SDT models as Generalized Linear Models for single participants, and for multiple participants simultaneously using hierarchical Bayesian models (or Generalized Linear Mixed Models).</p>
<p>Consider a recognition memory experiment where participants are shown a series of images, some of which are new (participant has not seen before) and some of which are old (participant has seen before). Participants answer, for each item, whether they think they have seen the item before (‚Äúold!‚Äù response) or not (‚Äúnew!‚Äù response). SDT models allow modeling participants‚Äô sensitivity‚Äîhow well they can distinguish new and old images‚Äîand response criterion‚Äîtheir tendency of <em>bias</em> to respond ‚Äúold!‚Äù‚Äîseparately, and can therefore be enormously useful in modeling the participants‚Äô memory processes. This similar logic applies to e.g.&nbsp;perception, where SDT was initially introduced in.</p>
<p>The conceptual basis of SDT models is that on each trial, when a stimulus is presented, participants experience some inner ‚Äúfamiliarity‚Äù (or memory strength) signal, which is hidden from the experimenter, or <em>latent</em>. The participants then decide, based on this familiarity signal, whether they have encountered the current stimulus stimulus previously (‚Äúold!‚Äù) or not (‚Äúnew!‚Äù). I assume that readers are at least somewhat familiar with the basics of SDT, and will not discuss the underlying theory further. A classic introduction to the topic is <span class="citation" data-cites="macmillan_detection_2005">Macmillan and Creelman (2005)</span>.</p>
<section id="example-data" class="level3">
<h3 class="anchored" data-anchor-id="example-data">Example data</h3>
<p>We move on to examining a practical example using the R statistical programming environment <span class="citation" data-cites="r_core_team_r:_2017">(R Core Team 2017)</span>. The following R packages were used in this tutorial:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_4da87d835f5dcae23f05ccbc5beabd96">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(bayesplot)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(ggridges)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(sdtalt)  <span class="co" style="color: #5E5E5E;"># devtools::install_github("cran/sdtalt") (not on CRAN)</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<p>The example data is called <code>confcontr</code>, and is provided as a data frame in the sdtalt package <span class="citation" data-cites="wright_sdtalt:_2011">(Wright 2011)</span>: ‚ÄúThese are the data from the control group in Skagerberg and Wright‚Äôs study of memory conformity. Basically, this is the simplest old/new recognition memory design.‚Äù <span class="citation" data-cites="skagerberg_manipulating_2008">(Skagerberg and Wright 2008)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_45a4f5b5867cae54565597549af315e3">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">data</span>(confcontr)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_e63342113ab8bdc42ce7f3c97d4b88bc">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example recognition memory data</caption>
<thead>
<tr class="header">
<th style="text-align: right;">subno</th>
<th style="text-align: right;">sayold</th>
<th style="text-align: right;">isold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">53</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="equal-variance-gaussian-sdt-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="equal-variance-gaussian-sdt-model">Equal Variance Gaussian SDT Model</h2>
<p>We consider the most common SDT model, that assumes the participants‚Äô distributions of familiarity are two Gaussian distributions with equal variances, but possibly different means (i.e.&nbsp;previously seen items elicit a stronger familiarity signal, on average). This model is known as the EVSDT (equal variance SDT) model.</p>
<p>We estimate the model‚Äôs parameters for a single participant using three methods: ‚ÄúManual‚Äù calculation of the point estimates using easy formulas translated to R code; estimating the model using a Bayesian Generalized Linear Model; and estimating the model using a Bayesian nonlinear model.</p>
<section id="calculate-evsdt-parameters-point-estimates" class="level3">
<h3 class="anchored" data-anchor-id="calculate-evsdt-parameters-point-estimates">Calculate EVSDT parameters‚Äô point estimates</h3>
<p>We begin by calculating the maximum likelihood estimates of the EVSDT parameters, separately for each participant in the data set. Before doing so, I note that this data processing is only required for manual calculation of the point estimates; the modeling methods described below take the raw data and therefore don‚Äôt require this step.</p>
<p>First, we‚Äôll compute for each trial whether the participant‚Äôs response was a hit, false alarm, correct rejection, or a miss. We‚Äôll do this by creating a new variable, <code>type</code>:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sdtcalc-1_b77db132b4043367b024801c8810abdc">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sdt <span class="ot" style="color: #003B4F;">&lt;-</span> confcontr <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb3-3">    <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"hit"</span>,</span>
<span id="cb3-4">    <span class="at" style="color: #657422;">type =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(isold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> sayold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="st" style="color: #20794D;">"miss"</span>, type),</span>
<span id="cb3-5">    <span class="at" style="color: #657422;">type =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(isold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> sayold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="st" style="color: #20794D;">"cr"</span>, type), <span class="co" style="color: #5E5E5E;"># Correct rejection</span></span>
<span id="cb3-6">    <span class="at" style="color: #657422;">type =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(isold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> sayold <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="st" style="color: #20794D;">"fa"</span>, type) <span class="co" style="color: #5E5E5E;"># False alarm</span></span>
<span id="cb3-7">  )</span></code></pre></div>
</div>
<p>Then we can simply count the numbers of these four types of trials for each participant, and put the counts on one row per participant.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sdtcalc-2_cffac45810b3280164a4df55e006c34d">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">sdt <span class="ot" style="color: #003B4F;">&lt;-</span> sdt <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">group_by</span>(subno, type) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;">summarise</span>(<span class="at" style="color: #657422;">count =</span> <span class="fu" style="color: #4758AB;">n</span>()) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;">spread</span>(type, count) <span class="co" style="color: #5E5E5E;"># Format data to one row per person</span></span></code></pre></div>
</div>
<p>For a single subject, <em>d‚Äô</em> can be calculated as the difference of the standardized hit and false alarm rates <span class="citation" data-cites="stanislaw_calculation_1999">(Stanislaw and Todorov 1999)</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?d'%20=%20%5CPhi%5E%7B-1%7D(HR)%20-%20%5CPhi%5E%7B-1%7D(FAR)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5CPhi"> is the cumulative normal density function, and is used to convert <em>z</em> scores into probabilities. Its inverse, <img src="https://latex.codecogs.com/png.latex?%5CPhi%5E%7B-1%7D">, converts a proportion (such as a hit rate or false alarm rate) into a <em>z</em> score. From here on, I refer to standardized hit and false alarm rates as <em>zHR</em> and <em>zFAR</em>, respectively. The response criterion <em>c</em> is given by the negative standardized false alarm rate -<em>zFAR</em> <span class="citation" data-cites="decarlo_signal_1998">(DeCarlo 1998)</span>.</p>
<p>We can use R‚Äôs proportion to z-score function (<img src="https://latex.codecogs.com/png.latex?%5CPhi%5E%7B-1%7D">), <code>qnorm()</code>, to calculate each participant‚Äôs <em>d‚Äô</em> and <em>c</em> from the counts of hits, false alarms, misses and correct rejections:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sdtcalc-3_4c7b2a3c6d0cb0127a02e6f512f8c49c">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">sdt <span class="ot" style="color: #003B4F;">&lt;-</span> sdt <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb5-3">    <span class="at" style="color: #657422;">zhr =</span> <span class="fu" style="color: #4758AB;">qnorm</span>(hit <span class="sc" style="color: #5E5E5E;">/</span> (hit <span class="sc" style="color: #5E5E5E;">+</span> miss)),</span>
<span id="cb5-4">    <span class="at" style="color: #657422;">zfa =</span> <span class="fu" style="color: #4758AB;">qnorm</span>(fa <span class="sc" style="color: #5E5E5E;">/</span> (fa <span class="sc" style="color: #5E5E5E;">+</span> cr)),</span>
<span id="cb5-5">    <span class="at" style="color: #657422;">dprime =</span> zhr <span class="sc" style="color: #5E5E5E;">-</span> zfa,</span>
<span id="cb5-6">    <span class="at" style="color: #657422;">crit =</span> <span class="sc" style="color: #5E5E5E;">-</span>zfa</span>
<span id="cb5-7">  )</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Point estimates of EVSDT parameters</caption>
<thead>
<tr class="header">
<th style="text-align: right;">subno</th>
<th style="text-align: right;">cr</th>
<th style="text-align: right;">fa</th>
<th style="text-align: right;">hit</th>
<th style="text-align: right;">miss</th>
<th style="text-align: right;">zhr</th>
<th style="text-align: right;">zfa</th>
<th style="text-align: right;">dprime</th>
<th style="text-align: right;">crit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">53</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">-0.31</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.31</td>
</tr>
<tr class="even">
<td style="text-align: right;">54</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">-0.63</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">0.63</td>
</tr>
<tr class="odd">
<td style="text-align: right;">55</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">0.47</td>
</tr>
<tr class="even">
<td style="text-align: right;">56</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">-0.88</td>
<td style="text-align: right;">1.76</td>
<td style="text-align: right;">0.88</td>
</tr>
<tr class="odd">
<td style="text-align: right;">57</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-0.41</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right;">0.41</td>
</tr>
<tr class="even">
<td style="text-align: right;">58</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-0.75</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">0.75</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This data frame now has point estimates of every participant‚Äôs <em>d‚Äô</em> and <em>c</em>. The implied EVSDT model for participant 53 is shown in Figure&nbsp;1.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-sdtplot-1_d95c49654c2fee5ded5a88220f072522">
<div class="cell-output-display">
<div id="fig-sdtplot-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-sdtplot-1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: The equal variance Gaussian signal detection model for the first participant in the data, based on manual calculation of the parameter‚Äôs point estimates. The two distributions are the noise distribution (dashed) and the signal distribution (solid); the dotted vertical line represents the response criterion. d‚Äô is the distance between the peaks of the two distributions.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimate-evsdt-model-with-a-glm" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="estimate-evsdt-model-with-a-glm">Estimate EVSDT model with a GLM</h3>
<p>Generalized Linear Models (GLM) are a powerful class of regression models that allow modeling binary outcomes, such as our ‚Äúold!‚Äù / ‚Äúnew!‚Äù responses. In <code>confcontr</code>, each row (trial) can have one of two responses, ‚Äúold!‚Äù (<code>sayold = 1</code>) or ‚Äúnew!‚Äù (<code>sayold = 0</code>). We use GLM to regress these responses on the stimulus type: On each trial, the to-be-judged stimulus can be either new (<code>isold = 0</code>) or old (<code>isold = 1</code>).</p>
<p>In a GLM of binary outcomes, we assume that the outcomes are Bernoulli distributed (binomial with 1 trial), with probability <img src="https://latex.codecogs.com/png.latex?p_i"> that <img src="https://latex.codecogs.com/png.latex?y_i%20=%201">.</p>
<p><img src="https://latex.codecogs.com/png.latex?y_i%20%5Csim%20Bernoulli(p_i)"></p>
<p>Because probabilities have upper and lower bounds at 1 and 0, and we wish to use a linear model (generalized <em>linear</em> model) of the <em>p</em> parameter, we don‚Äôt model <em>p</em> with a linear model. Instead, we map <em>p</em> to a ‚Äúlinear predictor‚Äù <img src="https://latex.codecogs.com/png.latex?%5Ceta"> with a link function, and model <img src="https://latex.codecogs.com/png.latex?%5Ceta"> with a linear regression model. If this link function is probit, we have a ‚Äúprobit GLM‚Äù:</p>
<aside>
You are probably familiar with logistic regression models, which are just another binary GLM, but with the logistic link function!
</aside>
<p><img src="https://latex.codecogs.com/png.latex?p_i%20=%20%5CPhi(%5Ceta_i)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5CPhi"> is again the cumulative normal density function and maps <em>z</em> scores to probabilities. We then model <img src="https://latex.codecogs.com/png.latex?%5Ceta"> on an intercept and a slope:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ceta_i%20=%20%5Cbeta_0%20+%20%5Cbeta_1%5Cmbox%7Bisold%7D_i"></p>
<p>Given this parameterization, the intercept of the model (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) is going to be the standardized false alarm rate (probability of saying 1 when predictor is 0), which we take as our criterion <em>c</em>. The slope of the model is the increase in the probability of saying 1 when the predictor is 1, in <em>z</em>-scores, which is another way of saying <em>d‚Äô</em>. Therefore, <img src="https://latex.codecogs.com/png.latex?c%20=%20-zFAR%20=%20-%5Cbeta_0">, and <img src="https://latex.codecogs.com/png.latex?d'%20=%20%5Cbeta_1">. If you prefer the conventional calculation of <img src="https://latex.codecogs.com/png.latex?c%20=%20-.5*(zHR%20+%20zFAR)"> (e.g., Macmillan &amp; Creelman, 2005), you can recode isold as +.5 vs.&nbsp;-.5 instead of 1 vs.&nbsp;0.</p>
<aside>
<strong>Note.</strong> The criterion parameterization here is unconventional and you probably want to use the contrast coding as suggested above, instead of the R standard coding I use here. See <code>?contrasts()</code>. <strong>Huge thanks to <a href="https://github.com/fidadoma">Filip</a> and <a href="https://github.com/MikeKSU">Mike</a> for letting me know about this issue!</strong>
</aside>
<p>The connection between SDT models and GLM is discussed in detail by <span class="citation" data-cites="decarlo_signal_1998">DeCarlo (1998)</span>. Two immediate benefits of thinking about SDT models in a GLM framework is that we can now easily include predictors on <em>c</em> and <em>d‚Äô</em>, and estimate SDT models with varying coefficients using hierarchical modeling methods <span class="citation" data-cites="decarlo_statistical_2010 rouder_introduction_2005">(DeCarlo 2010; Rouder and Lu 2005)</span>. This latter point means that we can easily fit the models for multiple participants (and items!) simultaneously, while at the same time pooling information across participants (and items). We will return to this point below.</p>
<p>Because we wrote the SDT model as a GLM, we have a variety of software options for estimating the model. For this simple model, you could just use base R‚Äôs <code>glm()</code>. Here, we use the Bayesian regression modeling R package brms <span class="citation" data-cites="burkner_brms:_2017 stan_development_team_rstan:_2016">(B√ºrkner 2017; Stan Development Team 2016a)</span>, because its model formula syntax extends seamlessly to more complicated models that we will discuss later. We can estimate the GLM with brms‚Äôs <code>brm()</code> function, by providing as arguments a model formula in brms syntax (identical to base R model syntax for simple models), an outcome distribution with a link function, and a data frame.</p>
<p>brms‚Äôs model syntax uses variable names from the data. We regress the binary <code>sayold</code> responses on the binary <code>isold</code> predictor with the following formula: <code>sayold ~ isold</code>. The distribution of the outcomes is specified with <code>family</code> argument. To specify the bernoulli distribution with a probit link function, we use <code>family = bernoulli(link="probit")</code>. We will only model the first participant‚Äôs data (number 53), and therefore specify the data with <code>data = filter(confcontr, subno==53)</code>.</p>
<p>The <code>brm()</code> function also allows specifying prior distributions on the parameters, but for this introductory discussion we omit discussion of priors. In addition, to run multiple MCMC chains <span class="citation" data-cites="kruschke_doing_2014 ravenzwaaij_simple_2016">(Kruschke 2014; van Ravenzwaaij, Cassey, and Brown 2016)</span> in parallel, we set the <code>cores</code> argument to 4 (this makes the model estimation faster). Finally, we also specify <code>file</code>, to save the model to a file so that we don‚Äôt have to re-estimate the model whenever we restart R.</p>
<p>Putting these pieces together, we estimate the SDT model as a probit GLM, using data stored in <code>confcontr</code>, for subject 53 only, with the following function:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fit-glm_d92fc4f3b2d707997e2ff9a89c11210d">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">evsdt_1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb6-2">  sayold <span class="sc" style="color: #5E5E5E;">~</span> isold,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">bernoulli</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"probit"</span>),</span>
<span id="cb6-4">  <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(confcontr, subno <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">53</span>),</span>
<span id="cb6-5">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb6-6">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel1-1"</span></span>
<span id="cb6-7">)</span></code></pre></div>
</div>
<p>The estimated model is saved in <code>evsdt_1</code>, whose <code>summary()</code> method returns a numerical summary of the estimated parameters along with some information and diagnostics about the model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_97959537e15c0c0d1bb5ffcbddd6c3cd">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_1)</span>
<span id="cb7-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb7-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit </span></span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ isold </span></span>
<span id="cb7-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: filter(confcontr, subno == 53) (Number of observations: 100) </span></span>
<span id="cb7-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept    -0.31      0.18    -0.66     0.03 1.00     3528     2413</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold         0.39      0.25    -0.11     0.88 1.00     3846     2644</span></span>
<span id="cb7-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb7-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb7-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb7-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>The regression parameters (<code>Intercept</code> (recall, <img src="https://latex.codecogs.com/png.latex?c%20=%20-%5Cbeta_0">) and <code>isold</code> (<img src="https://latex.codecogs.com/png.latex?d'%20=%20%5Cbeta_1">)) are described in the ‚ÄúPopulation-Level Effects‚Äù table in the above output. <code>Estimate</code> reports the posterior means, which are comparable to maximum likelihood point estimates, and <code>Est.Error</code> reports the posterior standard deviations, which are comparable to standard errors. The next two columns report the parameter‚Äôs 95% Credible Intervals (CIs). The estimated parameters‚Äô means match the point estimates we calculated by hand (see table above.)</p>
<p>In fact, the posterior modes will exactly correspond to the maximum likelihood estimates, if we use uniform priors. The posterior density of <em>d‚Äô</em> and <em>c</em>, for participant 53, is illustrated in Figure&nbsp;2: The maximum likelihood estimate is spot on the highest peak of the posterior density.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-densityplot_10c0d03bd0871ffdcac96b9475d71636">
<div class="cell-output-display">
<div id="fig-densityplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-densityplot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: The (approximate) joint posterior density of subject 53‚Äôs SDT parameters. Lighter yellow colors indicate higher posterior density. The red dot indicates the ‚Äòmanually‚Äô calculated MLE point estimate of d‚Äô.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Figure&nbsp;2 raises some interesting questions: What happens if we ignore the uncertainty in the estimated parameters (the colorful cloud of decreasing plausibility around the peak)? The answer is that not much happens for inference about averages by ignoring the subject-specific parameters‚Äô uncertainty, <em>if the design is balanced across participants.</em> But what will happen if we use the point estimates as predictors in some other regression, while ignoring their uncertainty? What are the implications of having very uncertain estimates? Should we trust the mode?</p>
<p>In any case, I hope the above has illustrated that the equal variance Gaussian SDT parameters are easy to obtain within the GLM framework. Next, we describe how to estimate the SDT model using brms‚Äô nonlinear modeling syntax.</p>
</section>
<section id="estimate-evsdt-with-a-nonlinear-model" class="level3">
<h3 class="anchored" data-anchor-id="estimate-evsdt-with-a-nonlinear-model">Estimate EVSDT with a nonlinear model</h3>
<p>Here, we write the EVSDT model in a similar way as the GLM above, but simply flip the criterion and <em>d‚Äô</em>. To do that we need to use brms‚Äô nonlinear modelling syntax. This parameterization will give <em>c</em> directly, without the need to flip the estimated parameter value. Although conceptually similar to above, and not necessarily useful by itself, it might be useful to fit this small variation of the above GLM to get familiar with brms‚Äô nonlinear modeling syntax. We write the model as follows <span class="citation" data-cites="decarlo_signal_1998">(DeCarlo 1998)</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?p_i%20=%20%5CPhi(d'%5Cmbox%7Bisold%7D_i%20-%20c)"></p>
<p>This model gives us direct estimates of <em>c</em> and <em>d‚Äô</em>. Writing and estimating nonlinear models can be considerably more involved than fitting GLMs. Accordingly, the code below is a bit more complicated. The key point here is, however, that using brms, we can estimate models that may be nonlinear without deviating too far from the basic formula syntax.</p>
<p>First, we‚Äôll specify the model using the <code>bf()</code> function:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_ddeb186797d289238f50581a9532828e">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">m2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb8-2">  sayold <span class="sc" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">Phi</span>(dprime <span class="sc" style="color: #5E5E5E;">*</span> isold <span class="sc" style="color: #5E5E5E;">-</span> c),</span>
<span id="cb8-3">  dprime <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>, c <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span>,</span>
<span id="cb8-4">  <span class="at" style="color: #657422;">nl =</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span id="cb8-5">)</span></code></pre></div>
</div>
<p>Let‚Äôs walk through this code line by line. On the first line, we specify the model of <code>sayold</code> responses. Recall that we are modeling the responses as Bernoulli distributed (this will be specified as an argument to the estimation function, below). Therefore, the right-hand side of the first line (after ~) is a model of the probability parameter (<img src="https://latex.codecogs.com/png.latex?p_i">) of the Bernoulli distribution.</p>
<p>The two unknown parameters in the model, <em>d‚Äô</em> and <em>c</em>, are estimated from data, as indicated by the second line (i.e.&nbsp;<code>dprime ~ 1</code>). The third line is required to tell brms that the model is nonlinear. To further understand how to write models with brms‚Äô nonlinear modeling syntax, see (<code>vignette("brms_nonlinear", package = "brms")</code>) (or <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_nonlinear.html">here</a>).</p>
<p>Because the parameters of nonlinear models can be more difficult to estimate, brms requires the user to set priors when <code>nl = TRUE</code>. We set somewhat arbitrary priors on <code>dprime</code> and <code>c</code> (the scale parameter is standard deviation, not variance):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_31353c58d803019cf0161c6190d725c6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">Priors <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(.<span class="dv" style="color: #AD0000;">5</span>, <span class="dv" style="color: #AD0000;">3</span>), <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"dprime"</span>),</span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">1.5</span>), <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"c"</span>)</span>
<span id="cb9-4">)</span></code></pre></div>
</div>
<p>After specifying the model and priors, fitting the model is done again using <code>brm()</code> with only a few adjustments: because we specified the link function inside <code>bf()</code> (the <code>Phi()</code> function), we should explicitly set <code>link="identity"</code> in the <code>family</code> argument. Because nonlinear models are trickier to estimate, we also adjust the underlying Stan sampler‚Äôs <code>adapt_delta</code> parameter (this will make the MCMC a little slower but will return less noisy results).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_6dab2d09b77d8995f25f96981dc790ec">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">evsdt_2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb10-2">  m2,</span>
<span id="cb10-3">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">bernoulli</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"identity"</span>),</span>
<span id="cb10-4">  <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(confcontr, subno <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">53</span>),</span>
<span id="cb10-5">  <span class="at" style="color: #657422;">prior =</span> Priors,</span>
<span id="cb10-6">  <span class="at" style="color: #657422;">control =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">adapt_delta =</span> .<span class="dv" style="color: #AD0000;">99</span>),</span>
<span id="cb10-7">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb10-8">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel1-2"</span></span>
<span id="cb10-9">)</span></code></pre></div>
</div>
<p>Notice that we now entered <code>m2</code> as the first argument, whereas with the first model, we simply wrote the formula inside the <code>brm()</code> function. These two ways are equivalent, but because this model is more complicated, I saved it into a variable as a separate line of code.</p>
<p>We can then compare the two models‚Äô estimated parameters. Recall that the latter model directly reports the standardized false alarm rate (<em>c</em>).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-7_1531f7603ccd9f7897d075ed7999107f">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_1)</span>
<span id="cb11-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit </span></span>
<span id="cb11-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ isold </span></span>
<span id="cb11-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: filter(confcontr, subno == 53) (Number of observations: 100) </span></span>
<span id="cb11-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept    -0.31      0.18    -0.66     0.03 1.00     3528     2413</span></span>
<span id="cb11-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold         0.39      0.25    -0.11     0.88 1.00     3846     2644</span></span>
<span id="cb11-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb11-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb11-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb11-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span>
<span id="cb11-17"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_2)</span>
<span id="cb11-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb11-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb11-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ Phi(dprime * isold - c) </span></span>
<span id="cb11-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          dprime ~ 1</span></span>
<span id="cb11-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          c ~ 1</span></span>
<span id="cb11-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: filter(confcontr, subno == 53) (Number of observations: 100) </span></span>
<span id="cb11-24"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb11-25"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb11-26"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb11-27"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb11-28"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb11-29"><span class="do" style="color: #5E5E5E;
font-style: italic;">## dprime_Intercept     0.38      0.25    -0.10     0.87 1.01      871      956</span></span>
<span id="cb11-30"><span class="do" style="color: #5E5E5E;
font-style: italic;">## c_Intercept          0.31      0.17    -0.04     0.64 1.00      872     1159</span></span>
<span id="cb11-31"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb11-32"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb11-33"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb11-34"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>The results are very similar, but note that priors were included only in the nonlinear syntax model. The only real difference is that the MCMC algorithm explored <code>evsdt_2</code>‚Äôs posterior less efficiently, as shown by the smaller effective sample sizes (<code>..._ESS</code>) for both parameters. This means that the random draws from the posterior distribution, for <code>evsdt_2</code>, have greater autocorrelation, and therefore we should possibly draw more samples for more accurate inference. The posterior distributions obtained with the 2 methods are shown in Figure&nbsp;3.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-densityplot2_8b34c1b966e590134673e0e04c604233">
<div class="cell-output-display">
<div id="fig-densityplot2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-densityplot2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Top row: The (approximate) joint posterior density of subject 53‚Äôs SDT parameters, estimated with the GL model and the nonlinear model. Lighter yellow colors indicate higher posterior density. The red dot indicates the sample mean d‚Äô that was calculated ‚Äòmanually‚Äô. Bottom row: The marginal posterior densities of c and dprime from GLM (red) and nonlinear (blue) models.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>There is little benefit in using the second, ‚Äúnonlinear‚Äù parameterization of EVSDT in this case. However, it is useful to study this simpler case to make it easier to understand how to fit more complicated nonlinear models with brms.</p>
</section>
<section id="interim-discussion" class="level3">
<h3 class="anchored" data-anchor-id="interim-discussion">Interim discussion</h3>
<section id="fitting-one-subjects-evsdt-model-with-different-methods" class="level4">
<h4 class="anchored" data-anchor-id="fitting-one-subjects-evsdt-model-with-different-methods">Fitting one subject‚Äôs EVSDT model with different methods</h4>
<p>We have now estimated the equal variance Gaussian SDT model‚Äôs parameters for one subject‚Äôs data using three methods: Calculating point estimates manually, with a probit GLM, and with a probit model using brms‚Äô nonlinear modeling syntax. The main difference between these methods, so far, is that the modeling methods provide estimates of uncertainty in the parameters, whereas the manual calculation does not. This point leads us directly to hierarchical models <span class="citation" data-cites="rouder_introduction_2005 rouder_signal_2007">(Rouder and Lu 2005; Rouder et al. 2007)</span>, which we discuss next.</p>
<p>However, there are other, perhaps more subtle, benefits of using a regression model framework for estimating SDT models. There is something to be said, for example, about the fact that the models take the raw data as input. ‚ÄòManual‚Äô calculation involves, well, manual computation of values, which may be more error prone than using raw data. This is especially clear if the modeling methods are straightforward to apply: I hope to have illustrated that with R and brms <span class="citation" data-cites="burkner_brms:_2017">(B√ºrkner 2017)</span>, Bayesian modeling methods are easy to apply and accessible to a wide audience.</p>
<p>Moving to a modeling framework will also allow us to include multiple sources of variation, such as heterogeneity across items and participants, through crossed ‚Äúrandom‚Äù effects <span class="citation" data-cites="rouder_signal_2007">(Rouder et al. 2007)</span>, and covariates that we think might affect the SDT parameters. By changing the link function, we can also easily use other distributions, such as logistic, to represent the signal and noise distributions <span class="citation" data-cites="decarlo_signal_1998 decarlo_statistical_2010">(DeCarlo 1998, 2010)</span>.</p>
</section>
<section id="prior-distribution" class="level4">
<h4 class="anchored" data-anchor-id="prior-distribution">Prior distribution</h4>
<p>Finally, priors. Newcomers to the Bayesian modeling framework might object to the use of prior distributions, and think that they are unduly biasing the results. However, moderately informative priors usually have far less of an influence on inference than newcomers might assume. Above, we specified the GLM with practically no prior information; if you are reluctant to include existing knowledge into your model, feel free to leave it out. Things are, unfortunately, a little more complicated with the nonlinear modeling functions: The posterior geometry might be funky (technical term), in which case the priors could mainly serve to nudge the posterior samples to be drawn from sensible parameter values.</p>
<p>Further, priors can be especially useful in estimating SDT models: If participants‚Äô hit or false alarm rates are 0 or 1‚Äìa fairly common scenario‚Äìmild prior information can be used in a principled manner to release the estimated quantities from the hostile captivity of the boundary values. Prior literature has discussed various corrections to 0 and 1 rates <span class="citation" data-cites="stanislaw_calculation_1999">(Stanislaw and Todorov 1999)</span>. However, Bayesian priors can take care of these edge cases in a more principled manner.</p>
</section>
</section>
</section>
<section id="evsdt-for-multiple-participants" class="level2">
<h2 class="anchored" data-anchor-id="evsdt-for-multiple-participants">EVSDT for multiple participants</h2>
<p>Above, we obtained parameter estimates of the EVSDT model for a single subject using three methods: Manual calculation of point estimates <span class="citation" data-cites="stanislaw_calculation_1999">(Stanislaw and Todorov 1999)</span>, estimating the model as a GLM (Generalized Linear Model; <span class="citation" data-cites="decarlo_signal_1998">DeCarlo (1998)</span>), and estimating the model as a GLM using brms‚Äô nonlinear modeling syntax <span class="citation" data-cites="burkner_brms:_2017">(B√ºrkner 2017)</span>.</p>
<p>However, researchers are usually not as interested in the specific subjects that happened to participate in their experiment, as they are in the population of potential subjects. Therefore, we are unsatisfied with parameters which describe only the subjects that happened to participate in our study: The final statistical model should have parameters that estimate features of the population of interest.</p>
<p>Broadly, there are two methods for obtaining these ‚Äúpopulation level‚Äù parameters. By far the most popular method is to summarise the manually calculated subject-specific point estimates of <em>d‚Äô</em> and <em>c</em> with their sample means and standard deviations. From these, we can calculate standard errors, t-tests, confidence intervals, etc. Another method‚Äìwhich I hope to motivate here‚Äìis to build a bigger model that estimates subject-specific and population-level parameters simultaneously. We call this latter method ‚Äúhierarchical‚Äù or ‚Äúmultilevel‚Äù modeling <span class="citation" data-cites="gelman_data_2007 rouder_introduction_2005">(Gelman and Hill 2007; Rouder and Lu 2005)</span>. In this section, I show how to obtain population-level EVSDT parameters with these two methods, using the R programming language and the brms R package <span class="citation" data-cites="r_core_team_r:_2017 burkner_brms:_2017">(R Core Team 2017; B√ºrkner 2017)</span>.</p>
<section id="population-level-evsdt-model" class="level3">
<h3 class="anchored" data-anchor-id="population-level-evsdt-model">Population-level EVSDT Model</h3>
<p>We now use these data to estimate the population-level EVSDT parameters using two methods: Manual calculation and hierarchical modeling. For hierarchical modeling, I provide R &amp; brms code to estimate the model as a Generalized Linear Mixed Model (GLMM). I also show how to estimate the GLMM with brms‚Äô nonlinear modeling syntax.</p>
<section id="estimation-by-summarizing-subjects-point-estimates" class="level4">
<h4 class="anchored" data-anchor-id="estimation-by-summarizing-subjects-point-estimates">Estimation by summarizing subjects‚Äô point estimates</h4>
<p>Above we calculated <em>d‚Äô</em> and <em>c</em> for every participant in the sample:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-8_2a75f51ae7c79f3a21fb352e39d13798">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Sample participants‚Äô SDT parameters</caption>
<thead>
<tr class="header">
<th style="text-align: right;">subno</th>
<th style="text-align: right;">cr</th>
<th style="text-align: right;">fa</th>
<th style="text-align: right;">hit</th>
<th style="text-align: right;">miss</th>
<th style="text-align: right;">zhr</th>
<th style="text-align: right;">zfa</th>
<th style="text-align: right;">dprime</th>
<th style="text-align: right;">crit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">53</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">-0.31</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.31</td>
</tr>
<tr class="even">
<td style="text-align: right;">54</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">-0.63</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">0.63</td>
</tr>
<tr class="odd">
<td style="text-align: right;">55</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">0.47</td>
</tr>
<tr class="even">
<td style="text-align: right;">56</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">-0.88</td>
<td style="text-align: right;">1.76</td>
<td style="text-align: right;">0.88</td>
</tr>
<tr class="odd">
<td style="text-align: right;">57</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-0.41</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: right;">0.41</td>
</tr>
<tr class="even">
<td style="text-align: right;">58</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-0.75</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">0.75</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can therefore calculate sample means and standard errors for both parameters using these individual-specific values. Here‚Äôs one way to do it:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-9_93ea554a72baecf56d3945384768919c">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">sdt_sum <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">select</span>(sdt, subno, dprime, crit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Select these variables only</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;">gather</span>(parameter, value, <span class="sc" style="color: #5E5E5E;">-</span>subno) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Convert data to long format</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;">group_by</span>(parameter) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Prepare to summarise on these grouping variables</span></span>
<span id="cb12-4">  <span class="co" style="color: #5E5E5E;"># Calculate summary statistics for grouping variables</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;">summarise</span>(<span class="at" style="color: #657422;">n =</span> <span class="fu" style="color: #4758AB;">n</span>(), <span class="at" style="color: #657422;">mu =</span> <span class="fu" style="color: #4758AB;">mean</span>(value), <span class="at" style="color: #657422;">sd =</span> <span class="fu" style="color: #4758AB;">sd</span>(value), <span class="at" style="color: #657422;">se =</span> sd <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">sqrt</span>(n))</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Average EVSDT parameters</caption>
<thead>
<tr class="header">
<th style="text-align: left;">parameter</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">mu</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">crit</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">dprime</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">1.09</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.09</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The sample means (<code>mu</code>) are estimates of the population means, and the sample standard deviations (<code>sd</code>) divided by <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7BN%20subjects%7D"> are estimated standard deviations of the respective sampling distributions: the standard errors (<code>se</code>). Because the standard deviations of the sampling distributions are unknown and therefore estimated from the data, researchers almost always substitute the Gaussian sampling distribution with a Student‚Äôs <em>t</em>-distribution to obtain <em>p</em>-values and confidence intervals (i.e.&nbsp;we run <em>t</em>-tests, not <em>z</em>-tests.)</p>
<p>Note that this method involves calculating point estimates of unknown parameters (the subject-specifc parameters), and then summarizing these parameters with additional models. In other words, we first fit N models with P parameters each (N = number of subjects, P = 2 parameters), and then P more models to summarise the subject-specific models.</p>
<p>Next, we‚Äôll use hierarchical regression<sup>1</sup> methods to obtain subject-specific and population-level parameters in one single step.</p>
</section>
<section id="estimation-with-a-hierarchical-model-glmm" class="level4">
<h4 class="anchored" data-anchor-id="estimation-with-a-hierarchical-model-glmm">Estimation with a hierarchical model (GLMM)</h4>
<p>We can estimate the EVSDT model‚Äôs parameters for every subject and the population average in one step using a Generalized Linear Mixed Model (GLMM). <span class="citation" data-cites="gelman_data_2007">Gelman and Hill (2007)</span> and <span class="citation" data-cites="mcelreath_statistical_2016">McElreath (2016)</span> are good general introductions to hierarchical models. <span class="citation" data-cites="rouder_introduction_2005">Rouder and Lu (2005)</span> and <span class="citation" data-cites="rouder_signal_2007">Rouder et al. (2007)</span> discuss hierarchical modeling in the context of signal detection theory.</p>
<p>This model is very much like the GLM discussed in Part 1, but now the subject-specific <em>d‚Äô</em>s and <em>c</em>s are modeled as draws from a multivariate normal distribution, whose (‚Äúhyper‚Äù)parameters describe the population-level parameters. We subscript subjects‚Äô parameters with <em>j</em>, rows in data with <em>i</em>, and write the model as:</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bij%7D%20%5Csim%20Bernoulli(p_%7Bij%7D)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5CPhi(p_%7Bij%7D)%20=%20%5Cbeta_%7B0j%7D%20+%20%5Cbeta_%7B1j%7D%5Cmbox%7Bisold%7D_%7Bij%7D"></p>
<p>The outcomes <img src="https://latex.codecogs.com/png.latex?y_%7Bij%7D"> are 0 if participant <em>j</em> responded ‚Äúnew!‚Äù on trial <em>i</em>, 1 if they responded ‚Äúold!‚Äù. The probability of the ‚Äúold!‚Äù response for row <em>i</em> for subject <em>j</em> is <img src="https://latex.codecogs.com/png.latex?p_%7Bij%7D">. We then write a linear model on the probits (<em>z</em>-scores; <img src="https://latex.codecogs.com/png.latex?%5CPhi">, ‚ÄúPhi‚Äù) of <em>p</em>s. The subject-specific intercepts (recall, <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0"> = <em>-zFAR</em>) and slopes (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> = <em>d‚Äô</em>) are described by multivariate normal with means and a covariance matrix for the parameters.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5B%5Cbegin%7Barray%7D%7Bc%7D%0A%5Cbeta_%7B0j%7D%20%5C%5C%20%5Cbeta_%7B1j%7D%0A%5Cend%7Barray%7D%5Cright%5D%0A%5Csim%20MVN(%0A%5Cleft%5B%5Cbegin%7Barray%7D%7Bc%7D%0A%5Cmu_%7B0%7D%20%5C%5C%20%5Cmu_%7B1%7D%0A%5Cend%7Barray%7D%5Cright%5D,%0A%5CSigma%0A)%0A"></p>
<p>The means <img src="https://latex.codecogs.com/png.latex?%5Cmu_0"> and <img src="https://latex.codecogs.com/png.latex?%5Cmu_1">, i.e.&nbsp;the population-level parameters, can be interpreted as parameters ‚Äúfor the average person‚Äù <span class="citation" data-cites="bolger_intensive_2013">(Bolger and Laurenceau 2013)</span>. The covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma"> contains the subject-specific parameters‚Äô (co)variances, but I find it easier to discuss standard deviations (I call them <img src="https://latex.codecogs.com/png.latex?%5Ctau">, ‚Äútau‚Äù) and correlations. The standard deviations describe the between-person heterogeneities in the population. The correlation term, in turn, describes the covariance of the <em>d‚Äô</em>s and <em>c</em>s: Are people with higher <em>d‚Äô</em>s more likely to have higher <em>c</em>s?</p>
<p>This model is therefore more informative than running multiple separate GLMs, because it models the covariances as well, answering important questions about heterogeneity in effects.</p>
<p>The brms syntax for this model is very similar to the one-subject model. We have five population-level parameters to estimate. The intercept and slope describe the means: In R and brms modeling syntax, an intercept is indicated with <code>1</code> (and can be omitted because it is automatically included, here I include it for clarity), and slope of a variable by including that variable‚Äôs name in the data. To include the two regression coefficients, we write <code>sayold ~ 1 + isold</code>.</p>
<p>However, we also have three (co)variance parameters to estimate. To include subject-specific parameters (recall, subjects are indexed by <code>subno</code> variable in data <code>d</code>), and therefore the (co)variance parameters, we expand the formula to <code>sayold ~ 1 + isold + (1 + isold | subno)</code>. The part in the parentheses describes <code>subno</code> specific intercepts (<code>1</code>) and slopes of <code>isold</code>. Otherwise, the call to <code>brm()</code> is the same as with the GLM in Part 1:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-10_0670f66759c8a31d8bd8dab7565e03fb">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">evsdt_glmm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(sayold <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> isold <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> isold <span class="sc" style="color: #5E5E5E;">|</span> subno),</span>
<span id="cb13-2">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">bernoulli</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"probit"</span>),</span>
<span id="cb13-3">  <span class="at" style="color: #657422;">data =</span> confcontr,</span>
<span id="cb13-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb13-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel2-1"</span></span>
<span id="cb13-6">)</span></code></pre></div>
</div>
<p>Let‚Äôs take a look at the GLMM‚Äôs estimated parameters. First, direct your eyes to the ‚ÄúPopulation-Level Effects‚Äù table in the below output. These two parameters are the mean -criterion (<code>Intercept</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmu_0">) and <em>d‚Äô</em> (<code>isold</code>, <img src="https://latex.codecogs.com/png.latex?%5Cmu_1">). Recall that we are looking at numerical summaries of (random samples from) the parameters‚Äô posterior distributions: <code>Estimate</code> is the posterior mean.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-11_75a27195df4b9f8ce57ced3253d146c0">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_glmm)</span>
<span id="cb14-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb14-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit </span></span>
<span id="cb14-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ 1 + isold + (1 + isold | subno) </span></span>
<span id="cb14-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: confcontr (Number of observations: 3100) </span></span>
<span id="cb14-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb14-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb14-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb14-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Group-Level Effects: </span></span>
<span id="cb14-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ~subno (Number of levels: 31) </span></span>
<span id="cb14-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb14-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(Intercept)            0.26      0.05     0.16     0.37 1.00     1672     2368</span></span>
<span id="cb14-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(isold)                0.39      0.08     0.24     0.56 1.00     1077     2112</span></span>
<span id="cb14-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(Intercept,isold)    -0.56      0.19    -0.84    -0.09 1.00      985     1805</span></span>
<span id="cb14-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb14-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb14-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb14-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept    -0.66      0.06    -0.78    -0.54 1.00     1769     2349</span></span>
<span id="cb14-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold         1.06      0.08     0.89     1.22 1.00     1643     2815</span></span>
<span id="cb14-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb14-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb14-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb14-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>We can then compare the Population-level mean parameters of this model to the sample summary statistics we calculated above. The posterior means map nicely to the calculated means, and the posterior standard deviations match the calculated standard errors.</p>
<p>These mean effects are visualized as a colored density in the left panel of Figure&nbsp;4. However, the GLMM also returns estimates of the parameters‚Äô (co)variation in the population. Notice that we also calculated the sample standard deviations, which also provide this information, but we have no estimates of uncertainty in those point estimates. The GLMM, on the other hand, provides full posterior distributions for these parameters.</p>
<p>The heterogeneity parameters are reported in the ‚ÄúGroup-Level Effects‚Äù<sup>2</sup> table, above. We find that the criteria are positively correlated with <em>d‚Äô</em>s (recall that Intercept = -<em>c</em>). The two standard deviations are visualized in the right panel of Figure&nbsp;4.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-evsdt-glmm-viz1_00c951e00c7769f9e841569d1e56604f">
<div class="cell-output-display">
<div id="fig-evsdt-glmm-viz1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-evsdt-glmm-viz1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Left panel: The (approximate) joint posterior density of the average d‚Äô and criterion. Lighter values indicate higher posterior probability. Right panel: The (approximate) joint posterior density of the standard deviations of d‚Äôs and criteria in the population. In both panels, the red dot indicates the ‚Äòmanually‚Äô calculated sample statistics.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>It is evident in Figure&nbsp;4 that the sample means approximately match the posterior mode, but less so for the sample standard deviations, which are far from the peak of the standard deviations‚Äô posterior distribution. By ignoring the uncertainty in the subject-specific parameters, the ‚Äòmanual calculation‚Äô method has over-estimated the heterogeneity of <em>d‚Äô</em>s and <em>c</em>s in the population, in comparison to the GLMM which takes the subject-specific parameters‚Äô uncertainty into account.</p>
<p>This idea has further implications, revealed by investigating the two methods‚Äô estimates of the subject-specific parameters. Recall that the manual calculation method involved estimating (the point estimates of) a separate model for each participant. A hierarchical model considers all participants‚Äô data simultaneously, and the estimates are allowed to inform each other via the shared prior distribution (right hand side of the equation repeated from above):</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cleft%5B%5Cbegin%7Barray%7D%7Bc%7D%0A%5Cbeta_%7B0j%7D%20%5C%5C%20%5Cbeta_%7B1j%7D%0A%5Cend%7Barray%7D%5Cright%5D%0A%5Csim%20N(%0A%5Cleft%5B%5Cbegin%7Barray%7D%7Bc%7D%0A%5Cmu_%7B0%7D%20%5C%5C%20%5Cmu_%7B1%7D%0A%5Cend%7Barray%7D%5Cright%5D,%0A%5CSigma%0A)%0A"></p>
<p>This ‚Äúpartial pooling‚Äù of information <span class="citation" data-cites="gelman_data_2007">(Gelman and Hill 2007)</span> is evident when we plot the GLMM‚Äôs subject-specific parameters in the same scatterplot with the N models method (calculating point estimates separately for everybody; Figure&nbsp;5).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-evsdt-glmm-viz2_5fe27ab95f00d614025cb0fe7164d02b">
<div class="cell-output-display">
<div id="fig-evsdt-glmm-viz2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-evsdt-glmm-viz2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;5: Subject-specific d‚Äôs and criteria as given by the independent models (filled circles), and as estimated by the hierarchical model (empty circles). The hierarchical model shrinks the estimated parameters toward the overall mean parameters (red dot). This shrinkage is greater for more extreme parameter values: Each subject-specific parameter is a compromise between that subject‚Äôs data, and other subjects in the sample. As the data points per subject, or the heterogeneity between subjects, increases, this shrinkage will decrease. The hierarchical model essentially says ‚ÄòPeople are different, but not <em>that</em> different‚Äô.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We see that estimating the EVSDT model for many individuals simultaneously with a hierarchical model is both easy to fit and informative. Specifically, it is now easy to include predictors on the parameters, and answer questions about possible influences on <em>d‚Äô</em> and <em>c</em>.</p>
</section>
<section id="including-predictors" class="level4">
<h4 class="anchored" data-anchor-id="including-predictors">Including predictors</h4>
<p>Do the EVSDT parameters differ between groups of people? How about between conditions, within people? To answer these questions, we would repeat the manual calculation of parameters as many times as needed, and then draw inference by ‚Äúsubmitting‚Äù the subject-specific parameters to e.g.&nbsp;an ANOVA model. The GLMM approach affords a more straightforward solution to including predictors: We simply add parameters to the regression model.</p>
<p>For example, if there were two groups of participants, indexed by variable <code>group</code> in data, we could extend the brms GLMM syntax to (the <code>...</code> is a placeholder for other arguments used above, I also dropped the <code>1</code> for clarity because they are implicitly included):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-12_0c52c22740347a1f27173dfe96da2466">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;">brm</span>(sayold <span class="sc" style="color: #5E5E5E;">~</span> isold <span class="sc" style="color: #5E5E5E;">*</span> group <span class="sc" style="color: #5E5E5E;">+</span> (isold <span class="sc" style="color: #5E5E5E;">|</span> subno), ...)</span></code></pre></div>
</div>
<p>This model would have two additional parameters: <code>group</code> would describe the difference in <em>c</em> between groups, and the interaction term <code>isold:group</code> would describe the difference in <em>d‚Äô</em> between groups. If, on the other hand, we were interested in the effects of <code>condition</code>, a within-subject manipulation, we would write:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-13_74be4d2a747c7fa8019ffcf902c90f9c">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;">brm</span>(sayold <span class="sc" style="color: #5E5E5E;">~</span> isold <span class="sc" style="color: #5E5E5E;">*</span> condition <span class="sc" style="color: #5E5E5E;">+</span> (isold <span class="sc" style="color: #5E5E5E;">*</span> condition <span class="sc" style="color: #5E5E5E;">|</span> subno), ...)</span></code></pre></div>
</div>
<p>With small changes, this syntax extends to ‚Äúmixed‚Äù between- and within-subject designs.</p>
</section>
<section id="estimation-with-a-glmm-nonlinear-syntax" class="level4">
<h4 class="anchored" data-anchor-id="estimation-with-a-glmm-nonlinear-syntax">Estimation with a GLMM (nonlinear syntax)</h4>
<p>Here, I briefly describe fitting the above GLMM with brms‚Äô nonlinear model syntax. The basic model is a straightforward reformulation of the single-subject case in Part 1 and the GLMM described above:</p>
<p><img src="https://latex.codecogs.com/png.latex?p_%7Bij%7D%20=%20%5CPhi(d'_j%5Cmbox%7Bisold%7D_%7Bij%7D%20-%20c_%7Bj%7D)"></p>
<p>The varying d-primes and criteria are modeled as multivariate normal, as with the GLMM. It turns out that this rather complex model is surprisingly easy to fit with brms. The formula is very similar to the single-subject nonlinear model but we tell <code>bf()</code> that the dprimes and criteria should have subject-specific parameters, as well as population-level parameters.</p>
<p>Above, with the GLMM, subject-specific effects were given by <code>(1 + isold | subno)</code>. With the nonlinear modeling syntax, we specify varying effects across multiple parameters using <code>|s|</code> instead of <code>|</code> to tell brms that these parameters should be within one covariance matrix. This syntax gives us the ‚Äúcorrelated random effects signal detection model‚Äù discussed in <span class="citation" data-cites="rouder_signal_2007">Rouder et al. (2007)</span>. Apart from the syntax, the model is the same as the GLMM above, but the sign of the intercept is flipped.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-14_a6a2318c8e167acb1182949512989a58">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">glmm2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(sayold <span class="sc" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">Phi</span>(dprime <span class="sc" style="color: #5E5E5E;">*</span> isold <span class="sc" style="color: #5E5E5E;">-</span> c),</span>
<span id="cb17-2">  dprime <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">|</span> s <span class="sc" style="color: #5E5E5E;">|</span> subno),</span>
<span id="cb17-3">  c <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">|</span> s <span class="sc" style="color: #5E5E5E;">|</span> subno),</span>
<span id="cb17-4">  <span class="at" style="color: #657422;">nl =</span> <span class="cn" style="color: #8f5902;">TRUE</span></span>
<span id="cb17-5">)</span></code></pre></div>
</div>
<p>This time, we‚Äôll set priors on the mean parameters and on the (co)variance parameters. Of note is the <code>lkj(4)</code> parameter which slightly regularizes the <em>d‚Äô</em>-<em>criterion</em> correlation toward zero <span class="citation" data-cites="mcelreath_statistical_2016 stan_development_team_stan:_2016">(McElreath 2016; Stan Development Team 2016b)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-15_4060e7795bf57a8697f5a87736a05bd5">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">Priors <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">3</span>), <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"dprime"</span>, <span class="at" style="color: #657422;">lb =</span> <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb18-3">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">3</span>), <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"c"</span>),</span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">student_t</span>(<span class="dv" style="color: #AD0000;">10</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"sd"</span>, <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"dprime"</span>),</span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">student_t</span>(<span class="dv" style="color: #AD0000;">10</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"sd"</span>, <span class="at" style="color: #657422;">nlpar =</span> <span class="st" style="color: #20794D;">"c"</span>),</span>
<span id="cb18-6">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">lkj</span>(<span class="dv" style="color: #AD0000;">4</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"cor"</span>)</span>
<span id="cb18-7">)</span></code></pre></div>
</div>
<p>We fit the model as before, but adjust the <code>control</code> argument, and set <code>inits</code> to zero to improve sampling efficiency (thanks to <a href="https://twitter.com/tsawallis">Tom Wallis</a> for this tip):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-16_6df524d303eda18d8449f507ffa46996">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">evsdt_glmm2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(glmm2,</span>
<span id="cb19-2">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">bernoulli</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"identity"</span>),</span>
<span id="cb19-3">  <span class="at" style="color: #657422;">data =</span> confcontr,</span>
<span id="cb19-4">  <span class="at" style="color: #657422;">prior =</span> Priors,</span>
<span id="cb19-5">  <span class="at" style="color: #657422;">control =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">adapt_delta =</span> .<span class="dv" style="color: #AD0000;">99</span>),</span>
<span id="cb19-6">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>, <span class="at" style="color: #657422;">inits =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb19-7">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel2-2"</span></span>
<span id="cb19-8">)</span></code></pre></div>
</div>
<p>Although this model samples less efficiently than the first GLMM formulation, we (unsurprisingly) observe similar results.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-17_1cfdeac63dfd11906201218690354d3a">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_glmm)</span>
<span id="cb20-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb20-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit </span></span>
<span id="cb20-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ 1 + isold + (1 + isold | subno) </span></span>
<span id="cb20-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: confcontr (Number of observations: 3100) </span></span>
<span id="cb20-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb20-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb20-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Group-Level Effects: </span></span>
<span id="cb20-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ~subno (Number of levels: 31) </span></span>
<span id="cb20-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb20-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(Intercept)            0.26      0.05     0.16     0.37 1.00     1672     2368</span></span>
<span id="cb20-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(isold)                0.39      0.08     0.24     0.56 1.00     1077     2112</span></span>
<span id="cb20-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(Intercept,isold)    -0.56      0.19    -0.84    -0.09 1.00      985     1805</span></span>
<span id="cb20-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb20-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb20-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept    -0.66      0.06    -0.78    -0.54 1.00     1769     2349</span></span>
<span id="cb20-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold         1.06      0.08     0.89     1.22 1.00     1643     2815</span></span>
<span id="cb20-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb20-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb20-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span>
<span id="cb20-24"><span class="fu" style="color: #4758AB;">summary</span>(evsdt_glmm2)</span>
<span id="cb20-25"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: bernoulli </span></span>
<span id="cb20-26"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb20-27"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: sayold ~ Phi(dprime * isold - c) </span></span>
<span id="cb20-28"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          dprime ~ 1 + (1 | s | subno)</span></span>
<span id="cb20-29"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          c ~ 1 + (1 | s | subno)</span></span>
<span id="cb20-30"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: confcontr (Number of observations: 3100) </span></span>
<span id="cb20-31"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb20-32"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb20-33"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-34"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Group-Level Effects: </span></span>
<span id="cb20-35"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ~subno (Number of levels: 31) </span></span>
<span id="cb20-36"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb20-37"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(dprime_Intercept)                  0.36      0.07     0.22     0.52 1.00     1543     2092</span></span>
<span id="cb20-38"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(c_Intercept)                       0.24      0.05     0.15     0.35 1.00     1289     2143</span></span>
<span id="cb20-39"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(dprime_Intercept,c_Intercept)     0.43      0.20    -0.01     0.74 1.00     1299     1902</span></span>
<span id="cb20-40"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-41"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb20-42"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb20-43"><span class="do" style="color: #5E5E5E;
font-style: italic;">## dprime_Intercept     1.05      0.08     0.89     1.22 1.00     1239     1378</span></span>
<span id="cb20-44"><span class="do" style="color: #5E5E5E;
font-style: italic;">## c_Intercept          0.65      0.06     0.54     0.77 1.00     1217     2071</span></span>
<span id="cb20-45"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb20-46"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb20-47"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb20-48"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>For technical reasons, each parameter in <code>evsdt_glmm2</code> has a <code>_Intercept</code> suffix, but the results are the same across the two ways of writing this model.</p>
</section>
</section>
<section id="interim-discussion-1" class="level3">
<h3 class="anchored" data-anchor-id="interim-discussion-1">Interim discussion</h3>
<p>Hierarchical modeling techniques have several advantages over traditional methods, such as (M)ANOVA, for modeling data with within-subject manipulations and repeated measures. For example, many models that previously required using parameters from subject-specific models as inputs to another model can be modeled within a single hierarchical model. Hierarchical models naturally account for unbalanced data, and allow incorporating continuous predictors and discrete outcomes. In the specific context of SDT, we observed that hierarchical models also estimate important parameters that describe possible between-person variability in parameters in the population of interest.</p>
<p>From casual observation, it appears that hierarchical models are becoming more widely used. Many applied papers now analyze data using multilevel models, instead of rm-ANOVA, suggesting that there is demand for these models within applied research contexts. Conceptualizing more complex, possibly nonlinear models as hierarchical models should then afford a more unified framework for data analysis. Furthermore, by including parameters for between-person variability, these models allow researchers to quantify the extent to which their effects of interest vary and, possibly, whether these effects hold for everybody in the population.</p>
</section>
</section>
<section id="unequal-variance-gaussian-sdt-model" class="level2">
<h2 class="anchored" data-anchor-id="unequal-variance-gaussian-sdt-model">Unequal variance Gaussian SDT model</h2>
<p>Next, I extend the discussion to rating tasks to show how unequal variance Gaussian SDT (UVSDT) models can be estimated with with Bayesian methods, using R and the brms package <span class="citation" data-cites="burkner_brms:_2017 r_core_team_r:_2017">(B√ºrkner 2017; R Core Team 2017)</span>. As above, we first focus on estimating the model for a single participant, and then discuss hierarchical models for multiple participants.</p>
<section id="example-data-rating-task" class="level3">
<h3 class="anchored" data-anchor-id="example-data-rating-task">Example data: Rating task</h3>
<p>We begin with a brief discussion of the rating task, with example data from <span class="citation" data-cites="decarlo_using_2003">Decarlo (2003)</span>. Above, we discussed signal detection experiments where the item was either old or new, and participants provided binary ‚Äúold!‚Äù or ‚Äúnew!‚Äù responses. Here, we move to a slight modification of this task, where participants are allowed to express their certainty: On each trial, the presented item is still old or new, but participants now <em>rate their confidence</em> in whether the item was old or new. For example, and in the data below, participants can answer with numbers indicating their confidence that the item is old: 1 = Definitely new, ‚Ä¶, 6 = Definitely old.</p>
<p>One interpretation of the resulting data is that participants set a number of criteria for the confidence ratings, such that greater evidence is required for 6-responses, than 4-responses, for example. That is, there will be different criteria for responding ‚Äúdefinitely new‚Äù, ‚Äúmaybe new‚Äù, and so forth. However, the participant‚Äôs underlying discriminability should remain unaffected.</p>
<p>The example data is shown in a summarised form below (counts of responses for each confidence bin, for both old (<code>isold</code> = 1) and new trial types <span class="citation" data-cites="decarlo_using_2003">(Decarlo 2003)</span>):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-18_d9adb15c8aae9112aabd108f3144d495">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">dsum <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb21-2">  <span class="at" style="color: #657422;">isold =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>),</span>
<span id="cb21-3">  <span class="at" style="color: #657422;">y =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">6</span>, <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">6</span>),</span>
<span id="cb21-4">  <span class="at" style="color: #657422;">count =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">174</span>, <span class="dv" style="color: #AD0000;">172</span>, <span class="dv" style="color: #AD0000;">104</span>, <span class="dv" style="color: #AD0000;">92</span>, <span class="dv" style="color: #AD0000;">41</span>, <span class="dv" style="color: #AD0000;">8</span>, <span class="dv" style="color: #AD0000;">46</span>, <span class="dv" style="color: #AD0000;">57</span>, <span class="dv" style="color: #AD0000;">66</span>, <span class="dv" style="color: #AD0000;">101</span>, <span class="dv" style="color: #AD0000;">154</span>, <span class="dv" style="color: #AD0000;">173</span>)</span>
<span id="cb21-5">)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example rating data from Decarlo (2003)</caption>
<thead>
<tr class="header">
<th style="text-align: right;">isold</th>
<th style="text-align: right;">y</th>
<th style="text-align: right;">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">174</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">172</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">104</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">92</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">41</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">46</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">57</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">66</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">101</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">154</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">173</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>However, we don‚Äôt need to summarise data to counts (or cell means, or the like), but can instead work with raw responses, as provided by the experimental program. Working with such trial-level data is especially useful when we wish to include covariates. Here is the data in the raw trial-level format:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-19_50abd354d40ccd0cec041ac4002a1368">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">uncount</span>(dsum, <span class="at" style="color: #657422;">weights =</span> count)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example rating data in raw format from Decarlo (2003)</caption>
<thead>
<tr class="header">
<th style="text-align: right;">isold</th>
<th style="text-align: right;">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can now proceed to fit the SDT models to this person‚Äôs data, beginning with the EVSDT model.</p>
</section>
<section id="evsdt-one-subjects-rating-responses" class="level3">
<h3 class="anchored" data-anchor-id="evsdt-one-subjects-rating-responses">EVSDT: one subject‚Äôs rating responses</h3>
<p>Recall that for the EVSDT model of binary responses, we modeled the probability <em>p</em> (of responding ‚Äúold!‚Äù on trial <em>i</em>) as</p>
<p><img src="https://latex.codecogs.com/png.latex?p_i%20=%20%5CPhi(d'%5Cmbox%7Bisold%7D_i%20-%20c)"></p>
<p>This model gives the (z-scored) probability of responding ‚Äúold‚Äù for new items (<em>c</em> = zFAR), and the increase (in z-scores) in ‚Äúold‚Äù responses for old items (<em>d‚Äô</em>). For rating data, the model is similar but we now include multiple <em>c</em>s. These index the different criteria for responding with the different confidence ratings. The criteria are assumed to be ordered‚Äìpeople should be more lenient to say unsure old, vs.&nbsp;sure old, when the signal (memory strength) on that trial was weaker.</p>
<p>The EVSDT model for rating responses models the <em>cumulative probability</em> of responding with confidence rating <em>k</em> or less (<img src="https://latex.codecogs.com/png.latex?p(y_i%20%5Cleq%20k_i)">; <span class="citation" data-cites="decarlo_using_2003">Decarlo (2003)</span>):</p>
<p><img src="https://latex.codecogs.com/png.latex?p(y_i%20%5Cleq%20k_i)%20=%20%5CPhi(d'%5Cmbox%7Bisold%7D_i%20-%20c_%7Bki%7D)"></p>
<p>This model is also known as an ordinal probit (<img src="https://latex.codecogs.com/png.latex?%5CPhi">) model, and can be fit with widely available regression modeling software. <span class="citation" data-cites="decarlo_using_2003">(Decarlo 2003)</span> showed how to use the PLUM procedure in SPSS to fit it for a single participant. However, we can obtain Bayesian inference for this model by estimating the model with the brms package in R <span class="citation" data-cites="burkner_brms:_2017 stan_development_team_stan:_2016">(B√ºrkner 2017; Stan Development Team 2016b)</span>. Ignoring prior distributions for now, the brms syntax for estimating this model with the above data is:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-20_05f6df2727c73c3e59916b7fca1b5e5f">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">fit1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(y <span class="sc" style="color: #5E5E5E;">~</span> isold,</span>
<span id="cb23-2">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">cumulative</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"probit"</span>),</span>
<span id="cb23-3">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb23-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb23-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel3-1"</span></span>
<span id="cb23-6">)</span></code></pre></div>
</div>
<p>This model estimates an intercept (criterion) for each response category, and the effect of <code>isold</code>, which is <em>d‚Äô</em>. The model‚Äôs posterior distribution is summarised below:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-21_5e5689b4d3f85364c2e22676c6c4408b">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;">summary</span>(fit1)</span>
<span id="cb24-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: cumulative </span></span>
<span id="cb24-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit; disc = identity </span></span>
<span id="cb24-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: y ~ isold </span></span>
<span id="cb24-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 1188) </span></span>
<span id="cb24-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb24-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb24-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb24-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb24-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb24-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[1]    -0.44      0.05    -0.54    -0.35 1.00     4155     3083</span></span>
<span id="cb24-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[2]     0.23      0.05     0.14     0.32 1.00     5584     3151</span></span>
<span id="cb24-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[3]     0.67      0.05     0.57     0.77 1.00     5537     3058</span></span>
<span id="cb24-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[4]     1.20      0.06     1.09     1.31 1.00     4292     3495</span></span>
<span id="cb24-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[5]     1.88      0.07     1.75     2.01 1.00     3827     3194</span></span>
<span id="cb24-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold            1.25      0.07     1.13     1.38 1.00     3899     3026</span></span>
<span id="cb24-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb24-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Family Specific Parameters: </span></span>
<span id="cb24-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">##      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb24-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## disc     1.00      0.00     1.00     1.00   NA       NA       NA</span></span>
<span id="cb24-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb24-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb24-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb24-24"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>The five intercepts are the five criteria in the model, and <code>isold</code> is <em>d‚Äô</em>. I also estimated this model using SPSS, so it might be helpful to compare the results from these two approaches:</p>
<pre><code>PLUM y WITH x
/CRITERIA=CIN(95) DELTA(0) LCONVERGE(0) MXITER(100) MXSTEP(5) PCONVERGE(1.0E-6) SINGULAR(1.0E-8)
/LINK=PROBIT
/PRINT=FIT KERNEL PARAMETER SUMMARY.

Parameter Estimates
|-----------------|--------|----------|-----------------------------------|
|                 |Estimate|Std. Error|95% Confidence Interval            |
|                 |        |          |-----------------------|-----------|
|                 |        |          |Lower Bound            |Upper Bound|
|---------|-------|--------|----------|-----------------------|-----------|
|Threshold|[y = 1]|-.442   |.051      |-.541                  |-.343      |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 2]|.230    |.049      |.134                   |.326       |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 3]|.669    |.051      |.569                   |.769       |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 4]|1.198   |.056      |1.088                  |1.308      |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 5]|1.876   |.066      |1.747                  |2.005      |
|---------|-------|--------|----------|-----------------------|-----------|
|Location |x      |1.253   |.065      |1.125                  |1.381      |
|-------------------------------------------------------------------------|
Link function: Probit.</code></pre>
<p>Unsurprisingly, the numerical results from brms (posterior means and standard deviations, credibility intervals) match the frequentist ones obtained from SPSS under these conditions.</p>
<p>We can now illustrate graphically how the estimated parameters map to the signal detection model. <em>d‚Äô</em> is the separation of the signal and noise distributions‚Äô peaks: It indexes the subject‚Äôs ability to discriminate signal from noise trials. The five intercepts are the (z-scored) criteria for responding with the different confidence ratings. If we convert the z-scores to proportions (using R‚Äôs <code>pnorm()</code> for example), they measure the (cumulative) area under the noise distribution to the left of that z-score. The model is visualized in Figure&nbsp;6.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-fit1-plot_c2f6f0bec7da8b44557c8a46e5a1090f">
<div class="cell-output-display">
<div id="fig-fit1-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-fit1-plot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;6: The equal variance Gaussian signal detection model, visualized from the parameters‚Äô posterior means. The two distributions are the noise distribution (dashed) and the signal distribution (solid). Dotted vertical lines are response criteria. d‚Äô is the distance between the peaks of the two distributions.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="uvsdt-one-subjects-rating-responses" class="level3">
<h3 class="anchored" data-anchor-id="uvsdt-one-subjects-rating-responses">UVSDT: one subject‚Äôs rating responses</h3>
<p>Notice that the above model assumed that the noise and signal distributions have the same variance. The unequal variances SDT (UVSDT) model allows the signal distribution to have a different variance than the noise distribution (whose standard deviation is still arbitrarily fixed at 1). It has been found that when the signal distribution‚Äôs standard deviation is allowed to vary, it is consistently greater than 1.</p>
<p>The UVSDT model adds one parameter, and we can write out the resulting model by including the signal distribution‚Äôs standard deviation as a scale parameter in the above equation <span class="citation" data-cites="decarlo_using_2003">(Decarlo 2003)</span>. However, because the standard deviation parameter must be greater than zero, it is convenient to model <img src="https://latex.codecogs.com/png.latex?%5Cmbox%7Blog%7D(%5Csigma_%7Bold%7D)%20=%20a"> instead:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(y_i%20%5Cleq%20k_i)%20=%20%5CPhi(%5Cfrac%7Bd'%5Cmbox%7Bisold%7D_i%20-%20c_k%7D%7B%5Cmbox%7Bexp%7D(a%5Cmbox%7Bisold%7D_i)%7D)"></p>
<p>It turns out that this nonlinear model‚Äîalso knows as a probit model with heteroscedastic error (e.g. <span class="citation" data-cites="decarlo_statistical_2010">DeCarlo (2010)</span>)‚Äîcan be estimated with brms. Initially, I thought that we could write out a nonlinear brms formula for the ordinal probit model, but brms does not support nonlinear cumulative ordinal models. I then proceeded to modify the raw Stan code to estimate this model, but although that worked, it would be less practical for applied work because not everyone wants to go through the trouble of writing Stan code.</p>
<p>After some back and forth with the creator of brms‚ÄîPaul B√ºrkner, who deserves a gold medal for his continuing hard work on this free and open-source software‚ÄîI found out that brms by default includes a similar parameter in ordinal regression models. If you scroll back up and look at the summary of <code>fit1</code>, at the top you will see that the model‚Äôs formula is:</p>
<pre><code>Formula: y ~ isold 
disc = 1</code></pre>
<p>In other words, there is a ‚Äúdiscrimination‚Äù parameter <code>disc</code>, which is set to 1 by default. Here‚Äôs how brms parameterizes the ordinal probit model:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(y_i%20%5Cleq%20k_i)%20=%20%5CPhi(disc%20*%20(c_%7Bki%7D%20-%20d'%5Cmbox%7Bisold%7D_i))"></p>
<p>Importantly, we can also include predictors on <code>disc</code>. In this case, we want to estimate <code>disc</code> when <code>isold</code> is 1, such that <code>disc</code> is 1 for new items, but estimated from data for old items. This parameter is by default modelled through a log link function, and including a 0/1 predictor (<code>isold</code>) will therefore work fine:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(y_i%20%5Cleq%20k_i)%20=%20%5CPhi(%5Cmbox%7Bexp%7D(disc%5Cmbox%7Bisold%7D_i)%20*%20(c_%7Bki%7D%20-%20d'%5Cmbox%7Bisold%7D_i))"></p>
<p>We can therefore estimate this model with only a small tweak to the EVSDT model‚Äôs code:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-22_428eaaf877b03a93cbc87b879a318e6b">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">uvsdt_m <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(y <span class="sc" style="color: #5E5E5E;">~</span> isold, disc <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> isold)</span></code></pre></div>
</div>
<p>There are two brms formulas in the model. The first, <code>y ~ isold</code> is already familiar to us. In the second formula, we write <code>disc ~ 0 + isold</code> to prevent the parameter from being estimated for the noise distribution: Recall that we have set the standard deviation of the noise distribution to be one (achieved by <img src="https://latex.codecogs.com/png.latex?exp(disc%20*%20%5Cmbox%7B0%7D)%20=%201">). In R‚Äôs (and by extension, brms‚Äô) modeling syntax <code>0 + ...</code> means removing the intercept from the model. By including <code>isold</code> only, we achieve the 0/1 predictor as described above. We can then estimate the model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-23_ec0c905a25f1833be446498c195dfba9">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">fit2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(uvsdt_m,</span>
<span id="cb28-2">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">cumulative</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"probit"</span>),</span>
<span id="cb28-3">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb28-4">  <span class="at" style="color: #657422;">control =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">adapt_delta =</span> .<span class="dv" style="color: #AD0000;">99</span>),</span>
<span id="cb28-5">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb28-6">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel3-2"</span></span>
<span id="cb28-7">)</span></code></pre></div>
</div>
<p>The model‚Äôs estimated parameters:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-24_475e3d1532f1ee1038f6c1cbe17e77ca">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;">summary</span>(fit2)</span>
<span id="cb29-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: cumulative </span></span>
<span id="cb29-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit; disc = log </span></span>
<span id="cb29-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: y ~ isold </span></span>
<span id="cb29-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          disc ~ 0 + isold</span></span>
<span id="cb29-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 1188) </span></span>
<span id="cb29-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb29-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb29-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb29-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb29-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb29-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[1]    -0.54      0.05    -0.64    -0.43 1.00     3023     2786</span></span>
<span id="cb29-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[2]     0.20      0.05     0.11     0.30 1.00     5092     3354</span></span>
<span id="cb29-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[3]     0.71      0.05     0.61     0.82 1.00     4178     3179</span></span>
<span id="cb29-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[4]     1.37      0.07     1.24     1.51 1.00     2477     2738</span></span>
<span id="cb29-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[5]     2.31      0.11     2.10     2.54 1.00     1541     2376</span></span>
<span id="cb29-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold            1.53      0.10     1.34     1.72 1.00     1701     1866</span></span>
<span id="cb29-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## disc_isold      -0.36      0.06    -0.48    -0.24 1.00     1601     2444</span></span>
<span id="cb29-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb29-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb29-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb29-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>Notice that we need to flip the sign of the <code>disc</code> parameter to get <img src="https://latex.codecogs.com/png.latex?%5Cmbox%7Blog%7D(%5Csigma_%7Bold%7D)">. Exponentiation gives us the standard deviation of the signal distribution, and because we estimated the model in the Bayesian framework, our estimate of this parameter is a posterior distribution, plotted on the y-axis of Figure&nbsp;7.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-uvsdt-densityplot_21e65b4fa9ace85843b0a40f1bbcca5f">
<div class="cell-output-display">
<div id="fig-uvsdt-densityplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-uvsdt-densityplot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7: The (approximate) joint posterior density of two UVSDT parameters (d‚Äô and standard deviation of the signal distribution) fitted to one participant‚Äôs data. Lighter yellow colors indicate higher posterior density. Red point shows the maximum likelihood estimates obtained from SPSS‚Äôs ordinal regression module.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can also compare the results from brms‚Äô to ones obtained from SPSS (SPSS procedure described in <span class="citation" data-cites="decarlo_using_2003">(Decarlo 2003)</span>):</p>
<pre><code>PLUM y WITH x
/CRITERIA=CIN(95) DELTA(0) LCONVERGE(0) MXITER(100) MXSTEP(5) PCONVERGE(1.0E-6) SINGULAR(1.0E-8)
/LINK=PROBIT
/PRINT=FIT KERNEL PARAMETER SUMMARY
/SCALE=x .

Parameter Estimates
|-----------------|--------|----------|-----------------------------------|
|                 |Estimate|Std. Error|95% Confidence Interval            |
|                 |        |          |-----------------------|-----------|
|                 |        |          |Lower Bound            |Upper Bound|
|---------|-------|--------|----------|-----------------------|-----------|
|Threshold|[y = 1]|-.533   |.054      |-.638                  |-.428      |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 2]|.204    |.050      |.107                   |.301       |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 3]|.710    |.053      |.607                   |.813       |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 4]|1.366   |.067      |1.235                  |1.498      |
|         |-------|--------|----------|-----------------------|-----------|
|         |[y = 5]|2.294   |.113      |2.072                  |2.516      |
|---------|-------|--------|----------|-----------------------|-----------|
|Location |x      |1.519   |.096      |1.331                  |1.707      |
|---------|-------|--------|----------|-----------------------|-----------|
|Scale    |x      |.348    |.063      |.225                   |.472       |
|-------------------------------------------------------------------------|
Link function: Probit.</code></pre>
<p>Again, the maximum likelihood estimates (SPSS) match our Bayesian quantities numerically, because we used uninformative prior distributions. Plotting the model‚Äôs implied distributions illustrates that the signal distribution has greater variance than the noise distribution (Figure&nbsp;8).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-fit2-plot_76f86ab50f55426293f0c4c6ed01e7d6">
<div class="cell-output-display">
<div id="fig-fit2-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-fit2-plot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8: The unequal variance Gaussian signal detection model, visualized from the parameters‚Äô posterior means. The two distributions are the noise distribution (dashed) and the signal distribution (solid). Dotted vertical lines are response criteria. d‚Äô is the scaled distance between the peaks of the two distributions.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Additional quantities of interest can be calculated from the parameters‚Äô posterior distributions. One benefit of obtaining samples from the posterior is that if we complete these calculations row-wise, we automatically obtain (samples from) the posterior distributions of these additional quantities.</p>
<p>Here, we calculate one such quantity: The ratio of the noise to signal standard deviations (<img src="https://latex.codecogs.com/png.latex?%5Cmbox%7Bexp%7D(-a)">; notice that our model returns <em>-a</em> as <em>disc_isold</em>), which is also the slope of the z-ROC curve. We‚Äôll first obtain the posterior samples of <em>disc_isold</em>, then calculate the ratio, and summarize the samples from ratio‚Äôs posterior distribution with their 2.5%, 50%, and 97.5%iles:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-25_57eef78ec81bae0f3f8c0d412b960854">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;">as.data.frame</span>(fit2, <span class="at" style="color: #657422;">pars =</span> <span class="st" style="color: #20794D;">"b_disc_isold"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb31-2">  <span class="fu" style="color: #4758AB;">transmute</span>(<span class="at" style="color: #657422;">ratio =</span> <span class="fu" style="color: #4758AB;">exp</span>(b_disc_isold)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;">pull</span>(ratio) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;">quantile</span>(<span class="at" style="color: #657422;">probs =</span> <span class="fu" style="color: #4758AB;">c</span>(.<span class="dv" style="color: #AD0000;">025</span>, .<span class="dv" style="color: #AD0000;">5</span>, .<span class="dv" style="color: #AD0000;">975</span>))</span>
<span id="cb31-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##      2.5%       50%     97.5% </span></span>
<span id="cb31-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 0.6175506 0.6991651 0.7894645</span></span></code></pre></div>
</div>
<p>These summaries are the parameter‚Äôs 95% Credible interval and median, and as such can be used to summarize this quantity in a publication. We could also visualize the posterior draws as a histogram:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-26_1b0f82d7300a5119f158604ccb404871">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;">as.data.frame</span>(fit2, <span class="at" style="color: #657422;">pars =</span> <span class="st" style="color: #20794D;">"b_disc_isold"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;">transmute</span>(<span class="at" style="color: #657422;">ratio =</span> <span class="fu" style="color: #4758AB;">exp</span>(b_disc_isold)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb32-3">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(ratio)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb32-4">  <span class="fu" style="color: #4758AB;">geom_histogram</span>(<span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"gray70"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb32-5">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, .<span class="dv" style="color: #AD0000;">1</span>))) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb32-6">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">aspect.ratio =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="uvsdt-for-multiple-participants" class="level2">
<h2 class="anchored" data-anchor-id="uvsdt-for-multiple-participants">UVSDT for multiple participants</h2>
<p>Above, we fit the UVSDT model for a single subject. However, we almost always want to discuss our inference about the population, not individual subjects. Further, if we wish to discuss individual subjects, we should place them in the context of other subjects. A multilevel (aka hierarchical, mixed) model accomplishes these goals by including population- and subject-level parameters.</p>
<section id="example-data-set" class="level3">
<h3 class="anchored" data-anchor-id="example-data-set">Example data set</h3>
<p>We‚Äôll use a data set of 48 subjects‚Äô confidence ratings on a 6 point scale: 1 = ‚Äúsure new‚Äù, ‚Ä¶, 6 = ‚Äúsure old‚Äù <span class="citation" data-cites="koen_examining_2013">(Koen et al. 2013)</span>. This data set is included in the R package MPTinR <span class="citation" data-cites="singmann_mptinr:_2013">(Singmann and Kellen 2013)</span>.</p>
<p>In this experiment <span class="citation" data-cites="koen_examining_2013">(Koen et al. 2013)</span>, participants completed a study phase, and were then tested under full attention, or while doing a second task. Here, we focus on the rating data provided in the full attention condition. Below, I reproduce the aggregate rating counts for old and new items from the Table in the article‚Äôs appendix. (It is useful to ensure that we are indeed using the same data.)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-27_591f92c721fcc8d6bfb9ce3aef292f7f">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example data from Koen et al.&nbsp;(2013)</caption>
<thead>
<tr class="header">
<th style="text-align: left;">isold</th>
<th style="text-align: right;">6</th>
<th style="text-align: right;">5</th>
<th style="text-align: right;">4</th>
<th style="text-align: right;">3</th>
<th style="text-align: right;">2</th>
<th style="text-align: right;">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">old</td>
<td style="text-align: right;">2604</td>
<td style="text-align: right;">634</td>
<td style="text-align: right;">384</td>
<td style="text-align: right;">389</td>
<td style="text-align: right;">422</td>
<td style="text-align: right;">309</td>
</tr>
<tr class="even">
<td style="text-align: left;">new</td>
<td style="text-align: right;">379</td>
<td style="text-align: right;">356</td>
<td style="text-align: right;">454</td>
<td style="text-align: right;">871</td>
<td style="text-align: right;">1335</td>
<td style="text-align: right;">1365</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For complete R code, including pre-processing the data, please refer to the source code of this blog post. I have omitted some of the less important code from the blog post for clarity.</p>
</section>
<section id="model-syntax" class="level3">
<h3 class="anchored" data-anchor-id="model-syntax">Model syntax</h3>
<p>Here‚Äôs the brms syntax we used for estimating the model for a single participant:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-28_73090bfce94800ef7985638fb3f6720b">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">uvsdt_m <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(y <span class="sc" style="color: #5E5E5E;">~</span> isold, disc <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> isold)</span></code></pre></div>
</div>
<p>With the above syntax we specifed seven parameters: Five intercepts (aka ‚Äòthresholds‚Äô in the cumulative probit model) on <code>y</code><sup>3</sup>; the effect of <code>isold</code> on <code>y</code>; and the effect of <code>isold</code> on the discrimination parameter <code>disc</code><sup>4</sup>. There are five intercepts (thresholds), because there are six response categories.</p>
<p>We extend the code to a hierarchical model by specifying that all these parameters vary across participants (variable <code>id</code> in the data).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-29_b7e5f4e4ad47bad962b9ba1535013b44">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">uvsdt_h <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb34-2">  y <span class="sc" style="color: #5E5E5E;">~</span> isold <span class="sc" style="color: #5E5E5E;">+</span> (isold <span class="sc" style="color: #5E5E5E;">|</span> s <span class="sc" style="color: #5E5E5E;">|</span> id),</span>
<span id="cb34-3">  disc <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> isold <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> isold <span class="sc" style="color: #5E5E5E;">|</span> s <span class="sc" style="color: #5E5E5E;">|</span> id)</span>
<span id="cb34-4">)</span></code></pre></div>
</div>
<p>Recall from above that using <code>|s|</code> leads to estimating correlations among the varying effects. There will only be one standard deviation associated with the thresholds; that is, the model assumes that subjects vary around the mean threshold similarly for all thresholds.</p>
</section>
<section id="prior-distributions" class="level3">
<h3 class="anchored" data-anchor-id="prior-distributions">Prior distributions</h3>
<p>I set a N(1, 3) prior on dprime, just because I know that in these tasks performance is usually pretty good. Perhaps this prior is also influenced by my reading of the paper! I also set a N(0, 1) prior on <em>a</em>: Usually this parameter is found to be around <img src="https://latex.codecogs.com/png.latex?-%5Cfrac%7B1%7D%7B4%7D">, but I‚Äôm ignoring that information.</p>
<p>The <em>t(7, 0, .33)</em> priors on the between-subject standard deviations reflect my assumption that the subjects should be moderately similar to one another, but also allows larger deviations. (They are <em>t</em>-distributions with seven degrees of freedom, zero mean, and .33 standard deviation.)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-30_feb73d2b76a04449462053ca162d8890">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">Prior <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">3</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">coef =</span> <span class="st" style="color: #20794D;">"isold"</span>),</span>
<span id="cb35-3">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">normal</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">coef =</span> <span class="st" style="color: #20794D;">"isold"</span>, <span class="at" style="color: #657422;">dpar =</span> <span class="st" style="color: #20794D;">"disc"</span>),</span>
<span id="cb35-4">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">student_t</span>(<span class="dv" style="color: #AD0000;">7</span>, <span class="dv" style="color: #AD0000;">0</span>, .<span class="dv" style="color: #AD0000;">33</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"sd"</span>),</span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">student_t</span>(<span class="dv" style="color: #AD0000;">7</span>, <span class="dv" style="color: #AD0000;">0</span>, .<span class="dv" style="color: #AD0000;">33</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"sd"</span>, <span class="at" style="color: #657422;">dpar =</span> <span class="st" style="color: #20794D;">"disc"</span>),</span>
<span id="cb35-6">  <span class="fu" style="color: #4758AB;">prior</span>(<span class="fu" style="color: #4758AB;">lkj</span>(<span class="dv" style="color: #AD0000;">2</span>), <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"cor"</span>)</span>
<span id="cb35-7">)</span></code></pre></div>
</div>
</section>
<section id="estimate-and-summarise-parameters" class="level3">
<h3 class="anchored" data-anchor-id="estimate-and-summarise-parameters">Estimate and summarise parameters</h3>
<p>We can then estimate the model as before. Be aware that this model takes quite a bit longer to estimate, so for this example I have set only 500 HMC iterations.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fit_9871ea17509b19c4788b33ddc7600127">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">fit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(uvsdt_h,</span>
<span id="cb36-2">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">cumulative</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"probit"</span>),</span>
<span id="cb36-3">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb36-4">  <span class="at" style="color: #657422;">prior =</span> Prior,</span>
<span id="cb36-5">  <span class="at" style="color: #657422;">control =</span> <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">adapt_delta =</span> .<span class="dv" style="color: #AD0000;">9</span>), <span class="at" style="color: #657422;">inits =</span> <span class="dv" style="color: #AD0000;">0</span>,</span>
<span id="cb36-6">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>, <span class="at" style="color: #657422;">iter =</span> <span class="dv" style="color: #AD0000;">500</span>,</span>
<span id="cb36-7">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sdtmodel4-1"</span></span>
<span id="cb36-8">)</span></code></pre></div>
</div>
<p>We then display numerical summaries of the model‚Äôs parameters. Note that the effective sample sizes are modest, and Rhats indicate that we would benefit from drawing more samples from the posterior. For real applications, I recommend more than 500 iterations per chain.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-31_5171fd898d61fbf288ddaaef9138d37a">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;">summary</span>(fit)</span>
<span id="cb37-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: cumulative </span></span>
<span id="cb37-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = probit; disc = log </span></span>
<span id="cb37-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: y ~ isold + (isold | s | id) </span></span>
<span id="cb37-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          disc ~ 0 + isold + (0 + isold | s | id)</span></span>
<span id="cb37-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 9502) </span></span>
<span id="cb37-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 500; warmup = 250; thin = 1;</span></span>
<span id="cb37-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 1000</span></span>
<span id="cb37-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb37-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Group-Level Effects: </span></span>
<span id="cb37-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ~id (Number of levels: 48) </span></span>
<span id="cb37-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb37-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(Intercept)                 0.34      0.04     0.27     0.43 1.00      187      406</span></span>
<span id="cb37-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(isold)                     0.77      0.10     0.60     0.99 1.02      153      270</span></span>
<span id="cb37-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(disc_isold)                0.46      0.05     0.37     0.57 1.00      173      357</span></span>
<span id="cb37-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(Intercept,isold)         -0.46      0.12    -0.68    -0.21 1.02      203      359</span></span>
<span id="cb37-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(Intercept,disc_isold)     0.34      0.13     0.09     0.59 1.03      155      304</span></span>
<span id="cb37-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## cor(isold,disc_isold)        -0.76      0.07    -0.87    -0.60 1.01      224      487</span></span>
<span id="cb37-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb37-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb37-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb37-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[1]    -0.59      0.05    -0.69    -0.49 1.01      132      323</span></span>
<span id="cb37-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[2]     0.20      0.05     0.11     0.30 1.02      129      340</span></span>
<span id="cb37-24"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[3]     0.70      0.05     0.60     0.81 1.02      132      270</span></span>
<span id="cb37-25"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[4]     1.05      0.05     0.94     1.16 1.02      141      334</span></span>
<span id="cb37-26"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept[5]     1.50      0.05     1.39     1.61 1.01      147      216</span></span>
<span id="cb37-27"><span class="do" style="color: #5E5E5E;
font-style: italic;">## isold            1.88      0.12     1.67     2.12 1.03      115      240</span></span>
<span id="cb37-28"><span class="do" style="color: #5E5E5E;
font-style: italic;">## disc_isold      -0.39      0.07    -0.52    -0.26 1.01      139      255</span></span>
<span id="cb37-29"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb37-30"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb37-31"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb37-32"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>Let‚Äôs first focus on the ‚ÄúPopulation-level Effects‚Äù: The effects for the ‚Äúaverage person‚Äù. <code>isold</code> is <em>d‚Äô</em>, and is very close to the one reported in the paper (eyeballing Figure 3 in <span class="citation" data-cites="koen_examining_2013">Koen et al. (2013)</span>; this <em>d‚Äô</em> is not numerically reported in the paper). <code>disc_isold</code> is, because of the model‚Äôs parameterization, <img src="https://latex.codecogs.com/png.latex?-%5Cmbox%7Blog%7D(%5Csigma_%7Bsignal%7D)%20=%20-a">. The paper discusses <img src="https://latex.codecogs.com/png.latex?V_o%20=%20%5Csigma_%7Bsignal%7D">, and therefore we transform each posterior sample of our <em>-a</em> to obtain samples from <img src="https://latex.codecogs.com/png.latex?V_o">‚Äôs posterior distribution.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-32_9714f29300e7d7af3182e77f3d775bc3">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">samples <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">posterior_samples</span>(fit, <span class="st" style="color: #20794D;">"b_"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb38-2">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">Vo =</span> <span class="fu" style="color: #4758AB;">exp</span>(<span class="sc" style="color: #5E5E5E;">-</span>b_disc_isold))</span></code></pre></div>
</div>
<p>We can then plot density curves <span class="citation" data-cites="gabry_bayesplot:_2017">(Gabry 2017)</span> for each of the Population-level Effects in our model, including <img src="https://latex.codecogs.com/png.latex?V_o">. Figure&nbsp;9 shows that our estimate of <img src="https://latex.codecogs.com/png.latex?V_o"> corresponds very closely to the one reported in the paper (Figure 3 in <span class="citation" data-cites="koen_examining_2013">Koen et al. (2013)</span>).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-population-density_d3b015c3cd381edc5e137c77214ceda5">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;">mcmc_areas</span>(samples, <span class="at" style="color: #657422;">point_est =</span> <span class="st" style="color: #20794D;">"mean"</span>, <span class="at" style="color: #657422;">prob =</span> .<span class="dv" style="color: #AD0000;">8</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-population-density" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-population-density-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9: Density plots of UVSDT model‚Äôs Population-level Effects‚Äô posterior distributions. Different parameters are indicated on the y-axis, and possible values on the x-axis. Vertical lines are posterior means, and shaded areas are 80% credible intervals.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<section id="heterogeneity-parameters" class="level4">
<h4 class="anchored" data-anchor-id="heterogeneity-parameters">Heterogeneity parameters</h4>
<p>Although the ‚Äúpopulation-level estimates‚Äù, which perhaps should be called ‚Äúaverage effects‚Äù, are usually the main target of inference, they are not the whole story, nor are they necessarily the most interesting part of it. It has been firmly established that, when allowed to vary, the standard deviation of the signal distribution is greater than 1. However, the between-subject variability of this parameter has received less interest. Figure&nbsp;10 reveals that the between-subject heterogeneity of <em>a</em> is quite large: The subject-specific effects have a standard deviation around .5.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-population-density2_c397d659b8d2dd56931013b7c423216b">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">samples_h <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">posterior_samples</span>(fit, <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"sd_"</span>, <span class="st" style="color: #20794D;">"cor_"</span>))</span>
<span id="cb40-2"><span class="fu" style="color: #4758AB;">mcmc_areas</span>(samples_h, <span class="at" style="color: #657422;">point_est =</span> <span class="st" style="color: #20794D;">"mean"</span>, <span class="at" style="color: #657422;">prob =</span> .<span class="dv" style="color: #AD0000;">8</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-population-density2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-population-density2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;10: Density plots of the standard deviation and correlation parameters of the UVSDT model‚Äôs parameters. Parameter‚Äôs appended with ‚Äôsd_id__‚Äô are between-id standard deviations, ones with ‚Äôcor_id__‚Äô are between-id correlations.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Figure&nbsp;10 also tells us that the subject-specific <em>d‚Äô</em>s and <em>a</em>s are correlated (‚Äúcor_id__isold__disc_isold‚Äù). We can further investigate this relationship by plotting the subject specific signal-SDs and <em>d‚Äô</em>s side by side:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-side-by-side_ea51284d9b5b1488f806ef54211ff4f9">
<div class="cell-output-display">
<div id="fig-side-by-side" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-side-by-side-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;11: Ridgeline plot of posterior distributions of subject-specific standard deviations (left) and d-primes (right). The ordering of subjects on the y-axis is the same, so as to highlight the relationship between the two variables.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>As can be seen in the ridgeline plots <span class="citation" data-cites="wilke_ggridges:_2017">(Wilke 2017)</span> in Figure&nbsp;11, participants with greater <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7Bsignal%7D"> tend to have greater d‚Äô: Increase in recognition sensitivity is accompanied with an increase in the signal distribution‚Äôs variability. The density plots also make it clear that we are much less certain about individuals whose values (either one) are greater, as shown by the spread out posterior distributions. Yet another way to visualize this relationship is with a scatterplot of the posterior means Figure&nbsp;12.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fig-scatterplot_5b3bcda037882f3c42dbe6933ba34e4e">
<div class="cell-output-display">
<div id="fig-scatterplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/fig-scatterplot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12: Scatterplot of posterior means of subject-specific d-primes and signal distribution standard deviations.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Estimating EVSDT and UVSDT models in the Bayesian framework with the brms package <span class="citation" data-cites="burkner_brms:_2017">(B√ºrkner 2017)</span> is both easy (relatively speaking) and informative. In this post, we estimated a hierarchical nonlinear cognitive model using no more than a few lines of code. Previous literature on the topic (e.g. <span class="citation" data-cites="rouder_signal_2007">Rouder et al. (2007)</span>) has focused on simpler (EVSDT) models with more complicated implementations‚Äìhopefully in this post I have shown that these models are within the reach of a greater audience, provided that they have some familiarity with R.</p>
<p>Another point worth making is a more general one about hierarchical models: We know that participants introduce (random) variation in our models. Ignoring this variation is clearly not good <span class="citation" data-cites="estes_problem_1956">(Estes 1956)</span>. It is more appropriate to model this variability, and use the resulting parameters to draw inference about the heterogeneity in parameters (and more generally, cognitive strategies) across individuals. Although maximum likelihood methods provide (noisy) point estimates of what I‚Äôve here called between-subject heterogeneity parameters, the Bayesian method allows drawing firm conclusions about these parameters.</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bolger_intensive_2013" class="csl-entry">
Bolger, Niall, and Jean-Philippe Laurenceau. 2013. <em>Intensive Longitudinal Methods: An Introduction to Diary and Experience Sampling Research</em>. Guilford Press. <a href="http://www.intensivelongitudinal.com/">http://www.intensivelongitudinal.com/</a>.
</div>
<div id="ref-burkner_brms:_2017" class="csl-entry">
B√ºrkner, Paul-Christian. 2017. <span>‚ÄúBrms: <span>An R Package</span> for <span>Bayesian Multilevel Models Using Stan</span>.‚Äù</span> <em>Journal of Statistical Software</em> 80 (1): 1‚Äì28. <a href="https://doi.org/10.18637/jss.v080.i01">https://doi.org/10.18637/jss.v080.i01</a>.
</div>
<div id="ref-decarlo_signal_1998" class="csl-entry">
DeCarlo, Lawrence T. 1998. <span>‚ÄúSignal Detection Theory and Generalized Linear Models.‚Äù</span> <em>Psychological Methods</em> 3 (2): 186‚Äì205. <a href="https://doi.org/10.1037/1082-989X.3.2.186">https://doi.org/10.1037/1082-989X.3.2.186</a>.
</div>
<div id="ref-decarlo_using_2003" class="csl-entry">
Decarlo, Lawrence T. 2003. <span>‚ÄúUsing the <span>PLUM</span> Procedure of <span>SPSS</span> to Fit Unequal Variance and Generalized Signal Detection Models.‚Äù</span> <em>Behavior Research Methods, Instruments, &amp; Computers</em> 35 (1): 49‚Äì56. <a href="https://doi.org/10.3758/BF03195496">https://doi.org/10.3758/BF03195496</a>.
</div>
<div id="ref-decarlo_statistical_2010" class="csl-entry">
DeCarlo, Lawrence T. 2010. <span>‚ÄúOn the Statistical and Theoretical Basis of Signal Detection Theory and Extensions: <span>Unequal</span> Variance, Random Coefficient, and Mixture Models.‚Äù</span> <em>Journal of Mathematical Psychology</em> 54 (3): 304‚Äì13. <a href="https://doi.org/10.1016/j.jmp.2010.01.001">https://doi.org/10.1016/j.jmp.2010.01.001</a>.
</div>
<div id="ref-estes_problem_1956" class="csl-entry">
Estes, W. K. 1956. <span>‚ÄúThe Problem of Inference from Curves Based on Group Data.‚Äù</span> <em>Psychological Bulletin</em> 53 (2): 134‚Äì40. <a href="https://doi.org/10.1037/h0045156">https://doi.org/10.1037/h0045156</a>.
</div>
<div id="ref-gabry_bayesplot:_2017" class="csl-entry">
Gabry, Jonah. 2017. <em>Bayesplot: <span>Plotting</span> for <span>Bayesian</span> Models</em>. <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
<div id="ref-gelman_data_2007" class="csl-entry">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data <span>Analysis Using Regression</span> and <span>Multilevel</span>/<span>Hierarchical Models</span></em>. <span>Cambridge University Press</span>.
</div>
<div id="ref-koen_examining_2013" class="csl-entry">
Koen, Joshua D., Mariam Aly, Wei-Chun Wang, and Andrew P. Yonelinas. 2013. <span>‚ÄúExamining the Causes of Memory Strength Variability: <span>Recollection</span>, Attention Failure, or Encoding Variability?‚Äù</span> <em>Journal of Experimental Psychology: Learning, Memory, and Cognition</em> 39 (6): 1726‚Äì41. <a href="https://doi.org/10.1037/a0033671">https://doi.org/10.1037/a0033671</a>.
</div>
<div id="ref-kruschke_doing_2014" class="csl-entry">
Kruschke, John K. 2014. <em>Doing Bayesian Data Analysis: A Tutorial Introduction with r</em>. 2nd Edition. Burlington, <span>MA</span>: Academic Press.
</div>
<div id="ref-macmillan_detection_2005" class="csl-entry">
Macmillan, Neil A., and C. Douglas Creelman. 2005. <em>Detection Theory: A User‚Äôs Guide</em>. 2nd ed. <span>Mahwah, N.J</span>: <span>Lawrence Erlbaum Associates</span>.
</div>
<div id="ref-mcelreath_statistical_2016" class="csl-entry">
McElreath, Richard. 2016. <em>Statistical Rethinking: A Bayesian Course with Examples in r and Stan</em>. <span>CRC</span> Press.
</div>
<div id="ref-r_core_team_r:_2017" class="csl-entry">
R Core Team. 2017. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-rouder_introduction_2005" class="csl-entry">
Rouder, Jeffrey N., and Jun Lu. 2005. <span>‚ÄúAn Introduction to <span>Bayesian</span> Hierarchical Models with an Application in the Theory of Signal Detection.‚Äù</span> <em>Psychonomic Bulletin &amp; Review</em> 12 (4): 573‚Äì604. <a href="https://doi.org/10.3758/BF03196750">https://doi.org/10.3758/BF03196750</a>.
</div>
<div id="ref-rouder_signal_2007" class="csl-entry">
Rouder, Jeffrey N., Jun Lu, Dongchu Sun, Paul Speckman, Richard D. Morey, and Moshe Naveh-Benjamin. 2007. <span>‚ÄúSignal <span>Detection Models</span> with <span>Random Participant</span> and <span>Item Effects</span>.‚Äù</span> <em>Psychometrika</em> 72 (4): 621‚Äì42. <a href="https://doi.org/10.1007/s11336-005-1350-6">https://doi.org/10.1007/s11336-005-1350-6</a>.
</div>
<div id="ref-singmann_mptinr:_2013" class="csl-entry">
Singmann, Henrik, and David Kellen. 2013. <span>‚Äú<span>MPTinR</span>: <span>Analysis</span> of Multinomial Processing Tree Models in <span>R</span>.‚Äù</span> <em>Behavior Research Methods</em> 45 (2): 560‚Äì75. <a href="https://doi.org/10.3758/s13428-012-0259-0">https://doi.org/10.3758/s13428-012-0259-0</a>.
</div>
<div id="ref-skagerberg_manipulating_2008" class="csl-entry">
Skagerberg, Elin M., and Daniel B. Wright. 2008. <span>‚ÄúManipulating Power Can Affect Memory Conformity.‚Äù</span> <em>Applied Cognitive Psychology</em> 22 (2): 207‚Äì16. <a href="https://doi.org/10.1002/acp.1353">https://doi.org/10.1002/acp.1353</a>.
</div>
<div id="ref-stan_development_team_rstan:_2016" class="csl-entry">
Stan Development Team. 2016a. <em><span>RStan</span>: The r Interface to Stan</em>. <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
<div id="ref-stan_development_team_stan:_2016" class="csl-entry">
‚Äî‚Äî‚Äî. 2016b. <em>Stan: A c++ Library for Probability and Sampling, Version 2.15.0</em>. <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
<div id="ref-stanislaw_calculation_1999" class="csl-entry">
Stanislaw, Harold, and Natasha Todorov. 1999. <span>‚ÄúCalculation of Signal Detection Theory Measures.‚Äù</span> <em>Behavior Research Methods, Instruments, &amp; Computers</em> 31 (1): 137‚Äì49. <a href="http://link.springer.com/article/10.3758/BF03207704">http://link.springer.com/article/10.3758/BF03207704</a>.
</div>
<div id="ref-ravenzwaaij_simple_2016" class="csl-entry">
van Ravenzwaaij, Don, Pete Cassey, and Scott D. Brown. 2016. <span>‚ÄúA Simple Introduction to <span>Markov Chain Monte</span>‚Äì<span>Carlo</span> Sampling.‚Äù</span> <em>Psychonomic Bulletin &amp; Review</em>, March, 1‚Äì12. <a href="https://doi.org/10.3758/s13423-016-1015-8">https://doi.org/10.3758/s13423-016-1015-8</a>.
</div>
<div id="ref-wilke_ggridges:_2017" class="csl-entry">
Wilke, Claus O. 2017. <em>Ggridges: <span>Ridgeline Plots</span> in ‚ÄôGgplot2‚Äô</em>. <a href="https://CRAN.R-project.org/package=ggridges">https://CRAN.R-project.org/package=ggridges</a>.
</div>
<div id="ref-wright_sdtalt:_2011" class="csl-entry">
Wright, Daniel B. 2011. <em>Sdtalt: <span>Signal</span> Detection Theory and Alternatives</em>. <a href="https://CRAN.R-project.org/package=sdtalt">https://CRAN.R-project.org/package=sdtalt</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Hierarchical regression is sometimes used to mean the practice of adding predictors to a regression model based on the predictors‚Äô <em>p</em>-values. Whatever you do, don‚Äôt do that.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>The label ‚ÄúGroup-Level Effects‚Äù might be slightly confusing because the SD and correlation parameters describe the population of subject-specific effects. I have yet to find a 100% satisfactory terminology here, but think that brms‚Äô terminology is certainly less confusing than that of ‚Äúrandom‚Äù and ‚Äúfixed‚Äù effects, traditionally encountered in multilevel modeling literature.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Recall that intercepts are automatically included, but can be explicitly included by adding <code>1</code> to the formula‚Äôs right hand side.‚Ü©Ô∏é</p></li>
<li id="fn4"><p><code>0 + ...</code> removes the model‚Äôs intercept.‚Ü©Ô∏é</p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2017,
  author = {Matti Vuorre},
  title = {Bayesian {Estimation} of {Signal} {Detection} {Models}},
  date = {2017-10-09},
  url = {https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2017" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2017. <span>‚ÄúBayesian Estimation of Signal Detection
Models.‚Äù</span> October 9, 2017. <a href="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models">https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models</a>.
</div></div></section></div> ]]></description>
  <category>psychology</category>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>brms</category>
  <guid>https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index.html</guid>
  <pubDate>Sun, 08 Oct 2017 23:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2017-10-09-bayesian-estimation-of-signal-detection-theory-models/index_files/figure-html/densityplot-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Bayes Factors with brms</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index.html</link>
  <description><![CDATA[ 




<p>Here‚Äôs a short post on how to calculate Bayes Factors with the R package <a href="http://CRAN.R-project.org/package=brms">brms</a> using the Savage-Dickey density ratio method <span class="citation" data-cites="wagenmakers_bayesian_2010">(Wagenmakers et al. 2010)</span>.</p>
<p>To get up to speed with what the Savage-Dickey density ratio method is‚Äìor what Bayes Factors are‚Äìplease read the target article <span class="citation" data-cites="wagenmakers_bayesian_2010">(Wagenmakers et al. 2010)</span>. (The paper is available on the <a href="http://www.ejwagenmakers.com/2010/WagenmakersEtAlCogPsy2010.pdf">author‚Äôs webpage</a>.) Here, I‚Äôll only show the R &amp; brms code to do the calculations discussed in <span class="citation" data-cites="wagenmakers_bayesian_2010">Wagenmakers et al. (2010)</span>. In their paper, they used WinBUGS, which requires quite a bit of code to sample from even a relatively simple model. brms on the other hand uses the familiar R formula syntax, making it easy to use. brms also does the MCMC sampling with <a href="http://mc-stan.org/">Stan</a> <span class="citation" data-cites="stan_development_team_stan:_2016">(Stan Development Team 2016)</span>, or rather creates Stan code from a specified R model formula by what can only be described as string processing magic, making the sampling very fast. Let‚Äôs get straight to the examples. We will use these packages:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_50922088949ccc77b1646107a2c1b79c">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(kableExtra)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(patchwork)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<section id="example-0" class="level2">
<h2 class="anchored" data-anchor-id="example-0">Example 0</h2>
<p>Wagenmakers and colleagues begin with a simple example of 10 true/false questions: We observe a person answering 9 (s) out of 10 (k) questions correctly.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_cc51a5e32633ed7a27a3f660e91e1efd">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">s =</span> <span class="dv" style="color: #AD0000;">9</span>, <span class="at" style="color: #657422;">k =</span> <span class="dv" style="color: #AD0000;">10</span>)</span></code></pre></div>
</div>
<p>We are interested in the person‚Äôs latent ability to answer similar questions correctly. This ability is represented by <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> (theta), which for us will be the probability parameter (sometimes also called the rate parameter) in a binomial distribution. The maximum likelihood (point) estimate for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is the proportion n/k = .9.</p>
<p>The first thing we‚Äôll need to specify with respect to our statistical model is the prior probability distribution for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. As in Wagenmakers et al.&nbsp;2010, we specify a uniform prior, representing no prior information about the person‚Äôs ability to aswer the questions. For the binomial probability parameter, <img src="https://latex.codecogs.com/png.latex?Beta(%5Calpha%20=%201,%20%5Cbeta%20=%201)"> is a uniform prior.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_8bab6d1522df9f9ac544afd66105aa74">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">pd <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;">x =</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">by =</span> .<span class="dv" style="color: #AD0000;">01</span>),</span>
<span id="cb3-3">  <span class="at" style="color: #657422;">Prior =</span> <span class="fu" style="color: #4758AB;">dbeta</span>(x, <span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb3-4">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The solid line represents the probability density assigned to values of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> by this prior probability distribution. You can see that it is 1 for all possible parameter values: They are all equally likely a priori. For this simple illustration, we can easily calculate the posterior distribution by adding the number of correct and incorrect answers to the parameters of the prior Beta distribution.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/figure1_3dc4bd868858cf18fe8fa3481b566395">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">pd<span class="sc" style="color: #5E5E5E;">$</span>Posterior <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">dbeta</span>(pd<span class="sc" style="color: #5E5E5E;">$</span>x, <span class="dv" style="color: #AD0000;">9</span><span class="sc" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">+</span><span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/figure1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Savage-Dickey density ratio is calculated by dividing the posterior density by the prior density at a specific parameter value. Here, we are interested in .5, a ‚Äúnull hypothesis‚Äù value indicating that the person‚Äôs latent ability is .5, i.e.&nbsp;that they are simply guessing.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_fb1e118b34bd94a7e42c6bdde6483200">
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Bayes Factors for first example.</caption>
 <thead>
  <tr>
   <th style="text-align:right;"> x </th>
   <th style="text-align:right;"> Prior </th>
   <th style="text-align:right;"> Posterior </th>
   <th style="text-align:right;"> BF01 </th>
   <th style="text-align:right;"> BF10 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.5 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.107 </td>
   <td style="text-align:right;"> 0.107 </td>
   <td style="text-align:right;"> 9.309 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>OK, so in this example we are able to get to the posterior with simply adding values into the parameters of the Beta distribution, but let‚Äôs now see how to get to this problem using brms. First, here‚Äôs the brms formula of the model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_f71290f001916c2673434922a43172c7">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">m0 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb5-2">  s <span class="sc" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;">trials</span>(k) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> Intercept,</span>
<span id="cb5-3">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">binomial</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"identity"</span>)</span>
<span id="cb5-4">)</span></code></pre></div>
</div>
<p>Read the first line as ‚Äús successes from k trials regressed on intercept‚Äù. That‚Äôs a little clunky, but bear with it. If you are familiar with R‚Äôs modeling syntax, you‚Äôll be wondering why we didn‚Äôt simply specify <code>~ 1</code> (R‚Äôs default notation for an intercept). The reason is that brms by default uses a little trick in parameterizing the intercept which speeds up the MCMC sampling. In order to specify a prior for the intercept, you‚Äôll have to take the default intercept out (<code>0 +</code>), and use the reserved string <code>intercept</code> to say that you mean the regular intercept. See <code>?brmsformula</code> for details. (For this model, with only one parameter, this complication doesn‚Äôt matter, but I wanted to introduce it early on so that you‚Äôd be aware of it when estimating multi-parameter models.)</p>
<p>The next line specifies that the data model is binomial, and that we want to model it‚Äôs parameter through an identity link. Usually when you model proportions or binary data, you‚Äôd use a logistic (logistic regression!), probit or other similar link function. In fact this is what we‚Äôll do for later examples. Finally, we‚Äôll use the data frame <code>d</code>.</p>
<p>OK, then we‚Äôll want to specify our priors. Priors are extremo important for Bayes Factors‚Äìand probabilistic inference in general. To help set priors, we‚Äôll first call <code>get_priors()</code> with the model information, which is basically like asking brms to tell what are the possible priors, and how to specify then, given this model.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_c86354cd23443caadb4f8ed21559cfb9">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">get_prior</span>(m0, <span class="at" style="color: #657422;">data =</span> d)</span>
<span id="cb6-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   prior class      coef group resp dpar nlpar lb ub       source</span></span>
<span id="cb6-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  (flat)     b                                            default</span></span>
<span id="cb6-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  (flat)     b Intercept                             (vectorized)</span></span></code></pre></div>
</div>
<p>The first line says that there is only one class of parameters <code>b</code>, think of class <code>b</code> as ‚Äúbetas‚Äù or ‚Äúregression coefficients‚Äù. The second line says that the <code>b</code> class has only one parameter, the intercept. So we can set a prior for the intercept, and this prior can be any probability distribution in Stan language. We‚Äôll create this prior using brms‚Äô <code>set_prior()</code>, give it a text string representing the Beta(1, 1) prior for all parameters of class <code>b</code> (shortcut, could also specify that we want it for the intercept specifically), and then say the upper and lower bounds (<img src="https://latex.codecogs.com/png.latex?%5Ctheta"> must be between 0 and 1).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_3fb335effddea5621cb4e2f1865d045c">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">Prior <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">set_prior</span>(<span class="st" style="color: #20794D;">"beta(1, 1)"</span>, <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">lb =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">ub =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
</div>
<p>Almost there. Now we‚Äôll actually sample from the model using <code>brm()</code>, give it the model, priors, data, ask it to sample from priors (for the density ratio), and set a few extra MCMC parameters.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-7_284135aafe8234ebf5596ac8a6a2e6d3">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">m <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb8-2">  <span class="at" style="color: #657422;">formula =</span> m0,</span>
<span id="cb8-3">  <span class="at" style="color: #657422;">prior =</span> Prior,</span>
<span id="cb8-4">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb8-5">  <span class="at" style="color: #657422;">sample_prior =</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span id="cb8-6">  <span class="at" style="color: #657422;">iter =</span> <span class="fl" style="color: #AD0000;">1e4</span>,</span>
<span id="cb8-7">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb8-8">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"bayesfactormodel"</span></span>
<span id="cb8-9">)</span></code></pre></div>
</div>
<p>We can get the estimated parameter by asking the model summary:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-8_6c850acdbbc4945d8d9f15801f02e895">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;">summary</span>(m)</span>
<span id="cb9-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb9-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb9-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: s | trials(k) ~ 0 + Intercept </span></span>
<span id="cb9-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 1) </span></span>
<span id="cb9-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;</span></span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 20000</span></span>
<span id="cb9-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb9-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb9-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb9-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept     0.83      0.10     0.59     0.98 1.00     6331     6217</span></span>
<span id="cb9-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb9-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb9-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb9-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>The Credible Interval matches exactly what‚Äôs reported in the paper. The point estimate differs slightly because here we see the posterior mean, whereas in the paper, Wagenmakers et al.&nbsp;report the posterior mode. I‚Äôll draw a line at their posterior mode, below, to show that it matches.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-9_0579405a8f362975d9015e6982268847">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">samples <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">posterior_samples</span>(m, <span class="st" style="color: #20794D;">"b"</span>)</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Six first rows of posterior samples.</caption>
 <thead>
  <tr>
   <th style="text-align:right;"> b_Intercept </th>
   <th style="text-align:right;"> prior_b </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.85 </td>
   <td style="text-align:right;"> 0.41 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.68 </td>
   <td style="text-align:right;"> 0.23 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.73 </td>
   <td style="text-align:right;"> 0.95 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.78 </td>
   <td style="text-align:right;"> 0.60 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.78 </td>
   <td style="text-align:right;"> 0.25 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.81 </td>
   <td style="text-align:right;"> 0.88 </td>
  </tr>
</tbody>
</table>

</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can already see the densities, so all that‚Äôs left is to obtain the exact values at the value of interest (.5) and take the <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bposterior%7D%7Bprior%7D"> ratio. Instead of doing any of this by hand, we‚Äôll use brms‚Äô function <code>hypothesis()</code> that allows us to test point hypotheses using the Dickey Savage density ratio. For this function we‚Äôll need to specify the point of interest, .5, as the point hypothesis to be tested.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-10_e7d6d29f2b2925eb91836ac3b9071797">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">h <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(m, <span class="st" style="color: #20794D;">"Intercept = 0.5"</span>)</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;">print</span>(h, <span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Hypothesis Tests for class b:</span></span>
<span id="cb11-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star</span></span>
<span id="cb11-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1 (Intercept)-(0.5) = 0    0.335    0.1037   0.0892   0.4781     0.1119    0.1006    *</span></span>
<span id="cb11-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## '*': For one-sided hypotheses, the posterior probability exceeds 95%;</span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## for two-sided hypotheses, the value tested against lies outside the 95%-CI.</span></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Posterior probabilities of point hypotheses assume equal prior probabilities.</span></span></code></pre></div>
</div>
<p>The <code>Evid.Ratio</code> is our Bayes Factor BF01. Notice that it matches the value 0.107 pretty well. You can also plot this hypothesis object easily with the <code>plot()</code> method:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-11_03064fc0db1b62e777eec8594f967597">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">plot</span>(h)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>OK, so that was a lot of work for such a simple problem, but the real beauty of brms (and Stan) is the scalability: We can easily solve a problem with one row of data and one parameter, and it won‚Äôt take much more to solve a problem with tens of thousands of rows of data, and hundreds of parameters. Let‚Äôs move on to the next example from <span class="citation" data-cites="wagenmakers_bayesian_2010">Wagenmakers et al. (2010)</span>.</p>
</section>
<section id="example-1-equality-of-proportions" class="level2">
<h2 class="anchored" data-anchor-id="example-1-equality-of-proportions">Example 1: Equality of Proportions</h2>
<p>These are the data from the paper</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-12_2bbf7d86300289ec68bc33f532937fbf">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(</span>
<span id="cb13-2">  <span class="at" style="color: #657422;">pledge =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"yes"</span>, <span class="st" style="color: #20794D;">"no"</span>),</span>
<span id="cb13-3">  <span class="at" style="color: #657422;">s =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">424</span>, <span class="dv" style="color: #AD0000;">5416</span>),</span>
<span id="cb13-4">  <span class="at" style="color: #657422;">n =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">777</span>, <span class="dv" style="color: #AD0000;">9072</span>)</span>
<span id="cb13-5">)</span>
<span id="cb13-6">d</span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   pledge    s    n</span></span>
<span id="cb13-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1    yes  424  777</span></span>
<span id="cb13-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 2     no 5416 9072</span></span></code></pre></div>
</div>
<p>They use Beta(1, 1) priors for both rate parameters, which we‚Äôll do as well. Notice that usually a regression formula has an intercept and a coefficient (e.g.&nbsp;effect of group.) By taking the intercept out (<code>0 +</code>) we can define two pledger-group proportions instead, and set priors on these. If we used an intercept + effect formula, we could set a prior on the effect itself.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-13_90d12253ac90d1f3b47323ad5fa115c0">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">m1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb14-2">  s <span class="sc" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;">trials</span>(n) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> pledge,</span>
<span id="cb14-3">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">binomial</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"identity"</span>)</span>
<span id="cb14-4">)</span>
<span id="cb14-5"><span class="fu" style="color: #4758AB;">get_prior</span>(</span>
<span id="cb14-6">  m1,</span>
<span id="cb14-7">  <span class="at" style="color: #657422;">data =</span> d</span>
<span id="cb14-8">)</span>
<span id="cb14-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   prior class      coef group resp dpar nlpar lb ub       source</span></span>
<span id="cb14-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  (flat)     b                                            default</span></span>
<span id="cb14-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  (flat)     b  pledgeno                             (vectorized)</span></span>
<span id="cb14-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  (flat)     b pledgeyes                             (vectorized)</span></span></code></pre></div>
</div>
<p>We can set the Beta prior for both groups‚Äô rate with one line of code by setting the prior on the <code>b</code> class without specifying the <code>coef</code>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-14_85decd0258db5c981f4bf36b61c6d999">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">Prior <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">set_prior</span>(<span class="st" style="color: #20794D;">"beta(1, 1)"</span>, <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">lb =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">ub =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
</div>
<p>Like above, let‚Äôs estimate.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-15_939f9fe59972232a3315322c9bc988d0">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">m1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb16-2">  m1,</span>
<span id="cb16-3">  <span class="at" style="color: #657422;">prior =</span> Prior,</span>
<span id="cb16-4">  <span class="at" style="color: #657422;">sample_prior =</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span id="cb16-5">  <span class="at" style="color: #657422;">iter =</span> <span class="fl" style="color: #AD0000;">1e4</span>,</span>
<span id="cb16-6">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb16-7">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb16-8">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"bayesfactormodel2"</span></span>
<span id="cb16-9">)</span></code></pre></div>
</div>
<p>Our estimates match the MLEs reported in the paper:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-16_1fda04a0f242dafa295451c3f39be1a4">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;">summary</span>(m1)</span>
<span id="cb17-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb17-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = identity </span></span>
<span id="cb17-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: s | trials(n) ~ 0 + pledge </span></span>
<span id="cb17-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 2) </span></span>
<span id="cb17-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;</span></span>
<span id="cb17-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 20000</span></span>
<span id="cb17-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb17-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb17-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb17-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## pledgeno      0.60      0.01     0.59     0.61 1.00    17582    12872</span></span>
<span id="cb17-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## pledgeyes     0.55      0.02     0.51     0.58 1.00    19471    13744</span></span>
<span id="cb17-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb17-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb17-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb17-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>To get the density ratio Bayes Factor, we‚Äôll need to specify a text string as our hypothesis. Our hypothesis is that the rate parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> and <img src="https://latex.codecogs.com/png.latex?%5Ctheta_2"> are not different: <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> = <img src="https://latex.codecogs.com/png.latex?%5Ctheta_2">. The alternative, then, is the notion that the parameter values differ.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-17_f3941cb242db1c037d29915016d4e7ad">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">h1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(m1, <span class="st" style="color: #20794D;">"pledgeyes = pledgeno"</span>)</span>
<span id="cb18-2">h1</span>
<span id="cb18-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Hypothesis Tests for class b:</span></span>
<span id="cb18-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                 Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star</span></span>
<span id="cb18-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1 (pledgeyes)-(pled... = 0    -0.05      0.02    -0.09    -0.02       0.55      0.36    *</span></span>
<span id="cb18-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb18-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.</span></span>
<span id="cb18-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## '*': For one-sided hypotheses, the posterior probability exceeds 95%;</span></span>
<span id="cb18-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## for two-sided hypotheses, the value tested against lies outside the 95%-CI.</span></span>
<span id="cb18-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Posterior probabilities of point hypotheses assume equal prior probabilities.</span></span></code></pre></div>
</div>
<p>As noted in the paper, a difference value of 0 is about twice as well supported before seeing the data, i.e.&nbsp;the null hypothesis of no difference is twice less likely after seeing the data:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-18_ead8dac40605294695c217abdc41dba0">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">/</span> h1<span class="sc" style="color: #5E5E5E;">$</span>hypothesis<span class="sc" style="color: #5E5E5E;">$</span>Evid.Ratio <span class="co" style="color: #5E5E5E;"># BF10</span></span>
<span id="cb19-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## [1] 1.808643</span></span></code></pre></div>
</div>
<p>The paper reports BF01 = 0.47, so we‚Äôre getting the same results (as we should.) You can also compare this figure to what‚Äôs reported in the paper.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-19_fe9d6c85bf18b295d23dd39713de79c2">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">h1p1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">plot</span>(h1, <span class="at" style="color: #657422;">plot =</span> F)[[<span class="dv" style="color: #AD0000;">1</span>]]</span>
<span id="cb20-2">h1p2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">plot</span>(h1, <span class="at" style="color: #657422;">plot =</span> F)[[<span class="dv" style="color: #AD0000;">1</span>]] <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-3">  <span class="fu" style="color: #4758AB;">coord_cartesian</span>(<span class="at" style="color: #657422;">xlim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="sc" style="color: #5E5E5E;">-</span>.<span class="dv" style="color: #AD0000;">05</span>, .<span class="dv" style="color: #AD0000;">05</span>), <span class="at" style="color: #657422;">ylim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">5</span>))</span>
<span id="cb20-4">  </span>
<span id="cb20-5">(h1p1 <span class="sc" style="color: #5E5E5E;">|</span> h1p2) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb20-6">  <span class="fu" style="color: #4758AB;">plot_layout</span>(<span class="at" style="color: #657422;">guides =</span> <span class="st" style="color: #20794D;">"collect"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Moving right on to Example 2, skipping the section on ‚Äúorder restricted analysis‚Äù.</p>
</section>
<section id="example-2-hierarchical-bayesian-one-sample-proportion-test" class="level2">
<h2 class="anchored" data-anchor-id="example-2-hierarchical-bayesian-one-sample-proportion-test">Example 2: Hierarchical Bayesian one-sample proportion test</h2>
<p>The data for example 2 is not available, but we‚Äôll simulate similar data. The simulation assumes that the neither-primed condition average correct probability is 50%, and that the both-primed condition benefit is 5%. Obviously, the numbers here won‚Äôt match anymore, but the data reported in the paper has an average difference in proportions of about 4%.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-20_f3fee0a30f209fdea026ce047ba0e748">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">5</span>)</span>
<span id="cb21-2">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb21-3">  <span class="at" style="color: #657422;">id =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="fu" style="color: #4758AB;">rep</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">74</span>, <span class="at" style="color: #657422;">each =</span> <span class="dv" style="color: #AD0000;">2</span>)),</span>
<span id="cb21-4">  <span class="at" style="color: #657422;">primed =</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"neither"</span>, <span class="st" style="color: #20794D;">"both"</span>), <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">74</span>),</span>
<span id="cb21-5">  <span class="at" style="color: #657422;">prime =</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>), <span class="at" style="color: #657422;">times =</span> <span class="dv" style="color: #AD0000;">74</span>), <span class="co" style="color: #5E5E5E;"># Dummy coded</span></span>
<span id="cb21-6">  <span class="at" style="color: #657422;">n =</span> <span class="dv" style="color: #AD0000;">21</span>,</span>
<span id="cb21-7">  <span class="at" style="color: #657422;">correct =</span> <span class="fu" style="color: #4758AB;">rbinom</span>(<span class="dv" style="color: #AD0000;">74</span> <span class="sc" style="color: #5E5E5E;">*</span> <span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">21</span>, .<span class="dv" style="color: #AD0000;">5</span> <span class="sc" style="color: #5E5E5E;">+</span> prime <span class="sc" style="color: #5E5E5E;">*</span> .<span class="dv" style="color: #AD0000;">05</span>)</span>
<span id="cb21-8">)</span>
<span id="cb21-9"><span class="fu" style="color: #4758AB;">group_by</span>(d, primed) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">summarize</span>(<span class="at" style="color: #657422;">p =</span> <span class="fu" style="color: #4758AB;">sum</span>(correct) <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">sum</span>(n))</span>
<span id="cb21-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## # A tibble: 2 √ó 2</span></span>
<span id="cb21-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   primed      p</span></span>
<span id="cb21-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span id="cb21-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1 both    0.542</span></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 2 neither 0.499</span></span></code></pre></div>
</div>
<p>This data yields a similar t-value as in the paper.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-21_7cbf84f49d65b19f5829d7e24b4ed4a3">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;">t.test</span>(correct <span class="sc" style="color: #5E5E5E;">/</span> n <span class="sc" style="color: #5E5E5E;">~</span> primed, <span class="at" style="color: #657422;">paired =</span> T, <span class="at" style="color: #657422;">data =</span> d)</span>
<span id="cb22-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb22-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Paired t-test</span></span>
<span id="cb22-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb22-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## data:  correct/n by primed</span></span>
<span id="cb22-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## t = 2.3045, df = 73, p-value = 0.02404</span></span>
<span id="cb22-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## alternative hypothesis: true difference in means is not equal to 0</span></span>
<span id="cb22-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 95 percent confidence interval:</span></span>
<span id="cb22-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  0.005741069 0.079201016</span></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sample estimates:</span></span>
<span id="cb22-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## mean of the differences </span></span>
<span id="cb22-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              0.04247104</span></span></code></pre></div>
</div>
<p>Instead of doing a probit regression, I‚Äôm going to do logistic regression. Therefore we define the prior on the log-odds scale. The log odds for the expected probability of .5 is 0. I prefer log-odds because‚Äìalthough complicated‚Äìthey make sense, unlike standardized effect sizes. Note that the probit scale would also be fine as they are very similar.</p>
<p>Let‚Äôs just get a quick intuition about effects in log-odds: The change in log odds from p = .5 to .55 is about 0.2.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-22_4334c2ea6cc77cc282384accbf85d0ea">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb23-2">  <span class="at" style="color: #657422;">rate =</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">by =</span> .<span class="dv" style="color: #AD0000;">01</span>),</span>
<span id="cb23-3">  <span class="at" style="color: #657422;">logit =</span> arm<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">logit</span>(rate)</span>
<span id="cb23-4">) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb23-5">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(rate, logit)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-6">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;">geom_segment</span>(<span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">xend =</span> <span class="fl" style="color: #AD0000;">0.55</span>, <span class="at" style="color: #657422;">y =</span> .<span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">yend =</span> .<span class="dv" style="color: #AD0000;">2</span>, <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">4</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-8">  <span class="fu" style="color: #4758AB;">geom_segment</span>(<span class="at" style="color: #657422;">x =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">xend =</span> <span class="fl" style="color: #AD0000;">0.5</span>, <span class="at" style="color: #657422;">y =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">yend =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">4</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb23-9">  <span class="fu" style="color: #4758AB;">coord_cartesian</span>(<span class="at" style="color: #657422;">ylim =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>, <span class="dv" style="color: #AD0000;">2</span>), <span class="at" style="color: #657422;">expand =</span> <span class="dv" style="color: #AD0000;">0</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We are cheating a little because we know these values, having simulated the data. However, log-odds are not straightforward (!), and this knowledge will allow us to specify better priors in this example. Let‚Äôs get the possible priors for this model by calling <code>get_prior()</code>. Notice that the model now includes id-varying ‚Äúrandom‚Äù effects, and we model them from independent Gaussians by specifying <code>||</code> instead of <code>|</code> which would give a multivariate Gaussian on the varying effects.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-23_9b08ef9a3926e03c3b96fbc107b7f821">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">m2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(</span>
<span id="cb24-2">  correct <span class="sc" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;">trials</span>(n) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> Intercept <span class="sc" style="color: #5E5E5E;">+</span> prime <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb24-3">    (<span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">+</span> Intercept <span class="sc" style="color: #5E5E5E;">+</span> prime <span class="sc" style="color: #5E5E5E;">||</span> id),</span>
<span id="cb24-4">  <span class="at" style="color: #657422;">family =</span> <span class="fu" style="color: #4758AB;">binomial</span>(<span class="at" style="color: #657422;">link =</span> <span class="st" style="color: #20794D;">"logit"</span>)</span>
<span id="cb24-5">)</span>
<span id="cb24-6"><span class="fu" style="color: #4758AB;">get_prior</span>(</span>
<span id="cb24-7">  m2,</span>
<span id="cb24-8">  <span class="at" style="color: #657422;">data =</span> d</span>
<span id="cb24-9">)</span>
<span id="cb24-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                 prior class      coef group resp dpar nlpar lb ub       source</span></span>
<span id="cb24-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                (flat)     b                                            default</span></span>
<span id="cb24-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                (flat)     b Intercept                             (vectorized)</span></span>
<span id="cb24-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                (flat)     b     prime                             (vectorized)</span></span>
<span id="cb24-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  student_t(3, 0, 2.5)    sd                                  0         default</span></span>
<span id="cb24-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  student_t(3, 0, 2.5)    sd              id                  0    (vectorized)</span></span>
<span id="cb24-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  student_t(3, 0, 2.5)    sd Intercept    id                  0    (vectorized)</span></span>
<span id="cb24-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  student_t(3, 0, 2.5)    sd     prime    id                  0    (vectorized)</span></span></code></pre></div>
</div>
<p>The leftmost column gives the pre-specified defaults used by brms. Here are the priors we‚Äôll specify. The most important pertains to <code>prime</code>, which is going to be the effect size in log-odds. Our prior for the log odds of the prime effect is going to be a Gaussian distribution centered on 0, with a standard deviation of .2, which is rather diffuse.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-24_30f40e13ceb271f8eeebda753a8e58c4">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">Prior <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb25-2">  <span class="fu" style="color: #4758AB;">set_prior</span>(<span class="st" style="color: #20794D;">"normal(0, 10)"</span>, <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">coef =</span> <span class="st" style="color: #20794D;">"Intercept"</span>),</span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;">set_prior</span>(<span class="st" style="color: #20794D;">"cauchy(0, 10)"</span>, <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"sd"</span>),</span>
<span id="cb25-4">  <span class="fu" style="color: #4758AB;">set_prior</span>(<span class="st" style="color: #20794D;">"normal(0, .2)"</span>, <span class="at" style="color: #657422;">class =</span> <span class="st" style="color: #20794D;">"b"</span>, <span class="at" style="color: #657422;">coef =</span> <span class="st" style="color: #20794D;">"prime"</span>)</span>
<span id="cb25-5">)</span></code></pre></div>
</div>
<p>Then we estimate the model using the specified priors.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-25_100bf6f068f10b1720bd39145f877cd9">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">m2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb26-2">  m2,</span>
<span id="cb26-3">  <span class="at" style="color: #657422;">prior =</span> Prior,</span>
<span id="cb26-4">  <span class="at" style="color: #657422;">sample_prior =</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span id="cb26-5">  <span class="at" style="color: #657422;">iter =</span> <span class="fl" style="color: #AD0000;">1e4</span>,</span>
<span id="cb26-6">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb26-7">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb26-8">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"bayesfactormodel3"</span></span>
<span id="cb26-9">)</span></code></pre></div>
</div>
<p>OK, so our results here will be different because we didn‚Äôt parameterize the prior on a standardized effect size because <strong>a</strong>) I don‚Äôt like standardized effect sizes, and <strong>b</strong>) I would have to play around with the Stan code, and this post is about brms. Anyway, here are the estimated parameters:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-26_2121e3c1317d461ed846d6376ac78d19">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;">summary</span>(m2)</span>
<span id="cb27-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: binomial </span></span>
<span id="cb27-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = logit </span></span>
<span id="cb27-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: correct | trials(n) ~ 0 + Intercept + prime + (0 + Intercept + prime || id) </span></span>
<span id="cb27-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 148) </span></span>
<span id="cb27-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;</span></span>
<span id="cb27-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 20000</span></span>
<span id="cb27-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb27-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Group-Level Effects: </span></span>
<span id="cb27-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ~id (Number of levels: 74) </span></span>
<span id="cb27-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb27-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(Intercept)     0.07      0.05     0.00     0.18 1.00     6289     7595</span></span>
<span id="cb27-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sd(prime)         0.12      0.08     0.01     0.30 1.00     5325     7048</span></span>
<span id="cb27-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb27-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb27-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb27-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept     0.01      0.05    -0.09     0.11 1.00    15752    13860</span></span>
<span id="cb27-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## prime         0.15      0.07     0.01     0.29 1.00    14810    14424</span></span>
<span id="cb27-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb27-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb27-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb27-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>And our null-hypothesis density ratio:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-27_caf739a0b00834b17c2c7fef7deb118d">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">h2 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">hypothesis</span>(m2, <span class="st" style="color: #20794D;">"prime = 0"</span>)</span>
<span id="cb28-2">h2</span>
<span id="cb28-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Hypothesis Tests for class b:</span></span>
<span id="cb28-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star</span></span>
<span id="cb28-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1 (prime) = 0     0.15      0.07     0.01     0.29       0.31      0.23    *</span></span>
<span id="cb28-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb28-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.</span></span>
<span id="cb28-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## '*': For one-sided hypotheses, the posterior probability exceeds 95%;</span></span>
<span id="cb28-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## for two-sided hypotheses, the value tested against lies outside the 95%-CI.</span></span>
<span id="cb28-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Posterior probabilities of point hypotheses assume equal prior probabilities.</span></span></code></pre></div>
</div>
<p>Priming effect of zero log-odds is 4 times less likely after seeing the data:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-28_10dd8c444e34a93c2734fec2400567cd">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">/</span> h2<span class="sc" style="color: #5E5E5E;">$</span>hypothesis<span class="sc" style="color: #5E5E5E;">$</span>Evid.Ratio</span>
<span id="cb29-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## [1] 3.267158</span></span></code></pre></div>
</div>
<p>This is best illustrated by plotting the densities:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-29_8bdb9fb111bdedf9ec600ab4a1bb4fc3">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;">plot</span>(h2)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Read the paper! Hopefully you‚Äôll be able to use brms‚Äô <code>hypothesis()</code> function to calculate bayes factors when needed.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-stan_development_team_stan:_2016" class="csl-entry">
Stan Development Team. 2016. <em>Stan: A c++ Library for Probability and Sampling, Version 2.15.0</em>. <a href="http://mc-stan.org/">http://mc-stan.org/</a>.
</div>
<div id="ref-wagenmakers_bayesian_2010" class="csl-entry">
Wagenmakers, Eric-Jan, Tom Lodewyckx, Himanshu Kuriyal, and Raoul Grasman. 2010. <span>‚ÄúBayesian Hypothesis Testing for Psychologists: A Tutorial on the Savage‚ÄìDickey Method.‚Äù</span> <em>Cognitive Psychology</em> 60 (3): 158‚Äì89. <a href="https://doi.org/10.1016/j.cogpsych.2009.12.001">https://doi.org/10.1016/j.cogpsych.2009.12.001</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2017,
  author = {Matti Vuorre},
  title = {Bayes {Factors} with Brms},
  date = {2017-03-21},
  url = {https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2017" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2017. <span>‚ÄúBayes Factors with Brms.‚Äù</span> March 21,
2017. <a href="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms">https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>brms</category>
  <guid>https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index.html</guid>
  <pubDate>Tue, 21 Mar 2017 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2017-03-21-bayes-factors-with-brms/index_files/figure-html/figure1-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>How to create within-subject scatter plots in R with ggplot2</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter/index.html</link>
  <description><![CDATA[ 




<p>Today, we‚Äôll take a look at creating a specific type of visualization for data from a within-subjects experiment (also known as repeated measures, but that can sometimes be a misleading label). You‚Äôll often see within-subject data visualized as bar graphs (condition means, and maybe mean difference if you‚Äôre lucky.) But alternatives exist, and today we‚Äôll take a look at <strong>within-subjects scatterplots</strong>.</p>
<p>For example, <span class="citation" data-cites="ganis_new_2015">Ganis and Kievit (2015)</span> asked 54 people to observe, on each trial, two 3-D shapes with various rotations and judge whether the two shapes were the same or not.</p>
<p>There were 4 angles (0, 50, 100, and 150 degree rotations), but for simplicity, today we‚Äôll only look at items that were not rotated with respect to each other, and items rotated 50 degrees. The data are freely available (thanks!) in Excel format, and the below snippet loads the data and cleans into a useable format:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_ab58bb399171b1182c1049b5e8e1357e">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="cf" style="color: #003B4F;">if</span> (<span class="sc" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;">file.exists</span>(<span class="st" style="color: #20794D;">"data.zip"</span>)) {</span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;">download.file</span>(<span class="st" style="color: #20794D;">"https://ndownloader.figshare.com/files/1878093"</span>, <span class="st" style="color: #20794D;">"data.zip"</span>)</span>
<span id="cb1-3">}</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">unzip</span>(<span class="st" style="color: #20794D;">"data.zip"</span>)</span>
<span id="cb1-5">files <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">list.files</span>(</span>
<span id="cb1-6">  <span class="st" style="color: #20794D;">"Behavioural_data/"</span>,</span>
<span id="cb1-7">  <span class="at" style="color: #657422;">pattern =</span> <span class="st" style="color: #20794D;">"sub[0-9]+.xlsx"</span>, <span class="at" style="color: #657422;">full.names =</span> T</span>
<span id="cb1-8">)</span>
<span id="cb1-9">dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">map</span>(</span>
<span id="cb1-10">  files,</span>
<span id="cb1-11">  <span class="sc" style="color: #5E5E5E;">~</span> <span class="fu" style="color: #4758AB;">read_xlsx</span>(.x, <span class="at" style="color: #657422;">range =</span> <span class="st" style="color: #20794D;">"A4:G100"</span>, <span class="at" style="color: #657422;">col_types =</span> <span class="fu" style="color: #4758AB;">rep</span>(<span class="st" style="color: #20794D;">"text"</span>, <span class="dv" style="color: #AD0000;">7</span>))</span>
<span id="cb1-12">) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;">bind_rows</span>(<span class="at" style="color: #657422;">.id =</span> <span class="st" style="color: #20794D;">"id"</span>)</span>
<span id="cb1-14">dat <span class="ot" style="color: #003B4F;">&lt;-</span> dat <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;">filter</span>(angle <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"0"</span>, <span class="st" style="color: #20794D;">"50"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;">transmute</span>(</span>
<span id="cb1-17">    <span class="at" style="color: #657422;">id =</span> <span class="fu" style="color: #4758AB;">factor</span>(id),</span>
<span id="cb1-18">    <span class="at" style="color: #657422;">angle =</span> <span class="fu" style="color: #4758AB;">factor</span>(angle),</span>
<span id="cb1-19">    <span class="at" style="color: #657422;">rt =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(Time),</span>
<span id="cb1-20">    <span class="at" style="color: #657422;">accuracy =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="st" style="color: #20794D;">`</span><span class="at" style="color: #657422;">correct/incorrect</span><span class="st" style="color: #20794D;">`</span>)</span>
<span id="cb1-21">  )</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_cf960b938fe4dd8cb90a2ff17cd1ee33">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Example data.</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> id </th>
   <th style="text-align:left;"> angle </th>
   <th style="text-align:right;"> rt </th>
   <th style="text-align:right;"> accuracy </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 1355 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 1685 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 1237 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 1275 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 2238 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 1524 </td>
   <td style="text-align:right;"> 1 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>We‚Äôll focus on comparing the reaction times between the 0 degree and 50 degree rotation trials.</p>
<section id="subject-means" class="level2">
<h2 class="anchored" data-anchor-id="subject-means">Subject means</h2>
<p>We‚Äôll be graphing subjects‚Äô means and standard errors, so we compute both first</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_d02120b959f0a4efa22aaaaa7e78b0ab">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dat_sum <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">group_by</span>(dat, id, angle) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;">summarize</span>(</span>
<span id="cb2-3">    <span class="at" style="color: #657422;">m =</span> <span class="fu" style="color: #4758AB;">mean</span>(rt, <span class="at" style="color: #657422;">na.rm =</span> T),</span>
<span id="cb2-4">    <span class="at" style="color: #657422;">se =</span> <span class="fu" style="color: #4758AB;">sd</span>(rt, <span class="at" style="color: #657422;">na.rm =</span> <span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">/</span> <span class="fu" style="color: #4758AB;">sqrt</span>(<span class="fu" style="color: #4758AB;">n</span>())</span>
<span id="cb2-5">  )</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Summary data</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> id </th>
   <th style="text-align:left;"> angle </th>
   <th style="text-align:right;"> m </th>
   <th style="text-align:right;"> se </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 1512.12 </td>
   <td style="text-align:right;"> 146.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 2039.42 </td>
   <td style="text-align:right;"> 133.74 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 2784.39 </td>
   <td style="text-align:right;"> 301.94 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 3766.58 </td>
   <td style="text-align:right;"> 337.51 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:right;"> 3546.30 </td>
   <td style="text-align:right;"> 388.03 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 </td>
   <td style="text-align:left;"> 50 </td>
   <td style="text-align:right;"> 4639.84 </td>
   <td style="text-align:right;"> 281.78 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_798a05dcc1edb14e03a961884b9e19e3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">dat_sum <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> angle, <span class="at" style="color: #657422;">y =</span> m)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;">stat_summary</span>(</span>
<span id="cb3-4">    <span class="at" style="color: #657422;">fun.data =</span> mean_cl_normal, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb3-5">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;">geom_quasirandom</span>(<span class="at" style="color: #657422;">width =</span> .<span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">shape =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="st" style="color: #20794D;">"Mean RT"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This figure shows quite clearly that the mean reaction time in the 50 degree angle condition was higher than in the 0 degree angle condition, and the spread across individuals in each condition. However, we often are specifically interested in the <em>within-subject effect</em> of condition, which would be difficult to visually display in this image. We could draw lines to connect each point, and the effect would then be visible as a ‚Äúspaghetti plot‚Äù, but while useful, these plots may sometimes be a little overwhelming especially if there‚Äôs too many people (spaghetti is great but nobody likes too much of it!)</p>
</section>
<section id="within-subject-scatterplots" class="level2">
<h2 class="anchored" data-anchor-id="within-subject-scatterplots">Within-subject scatterplots</h2>
<p>To draw within-subjects scatterplots, we‚Äôll need a slight reorganization of the data, such that it is in wide format with respect to the conditions.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_f90c24d93f3eb5ff5485264bd83b433a">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">dat_sum_wide <span class="ot" style="color: #003B4F;">&lt;-</span> dat_sum <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">pivot_wider</span>(<span class="at" style="color: #657422;">names_from =</span> angle, <span class="at" style="color: #657422;">values_from =</span> <span class="fu" style="color: #4758AB;">c</span>(m, se))</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Summary data in wide format.</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> id </th>
   <th style="text-align:right;"> m_0 </th>
   <th style="text-align:right;"> m_50 </th>
   <th style="text-align:right;"> se_0 </th>
   <th style="text-align:right;"> se_50 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 1 </td>
   <td style="text-align:right;"> 1512.12 </td>
   <td style="text-align:right;"> 2039.42 </td>
   <td style="text-align:right;"> 146.50 </td>
   <td style="text-align:right;"> 133.74 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 </td>
   <td style="text-align:right;"> 2784.39 </td>
   <td style="text-align:right;"> 3766.58 </td>
   <td style="text-align:right;"> 301.94 </td>
   <td style="text-align:right;"> 337.51 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 </td>
   <td style="text-align:right;"> 3546.30 </td>
   <td style="text-align:right;"> 4639.84 </td>
   <td style="text-align:right;"> 388.03 </td>
   <td style="text-align:right;"> 281.78 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 12 </td>
   <td style="text-align:right;"> 1251.04 </td>
   <td style="text-align:right;"> 1767.54 </td>
   <td style="text-align:right;"> 125.10 </td>
   <td style="text-align:right;"> 211.44 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 13 </td>
   <td style="text-align:right;"> 1372.54 </td>
   <td style="text-align:right;"> 2037.67 </td>
   <td style="text-align:right;"> 86.25 </td>
   <td style="text-align:right;"> 167.52 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 14 </td>
   <td style="text-align:right;"> 1231.92 </td>
   <td style="text-align:right;"> 1666.25 </td>
   <td style="text-align:right;"> 84.09 </td>
   <td style="text-align:right;"> 126.10 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Then we can simply map the per-subject angle-means and standard errors to the X and Y axes. I think it‚Äôs important for these graphs to usually have a 1:1 aspect ratio, an identity line, and identical axes, which we add below.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/scatter_dcb3da38b671bb131b25381bd7d2b20d">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">ggplot</span>(dat_sum_wide, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> m_0, <span class="at" style="color: #657422;">y =</span> m_50)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-2">  <span class="co" style="color: #5E5E5E;"># Equalize axes</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;">scale_x_continuous</span>(<span class="st" style="color: #20794D;">"RT (0 degrees)"</span>, <span class="at" style="color: #657422;">limits =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">500</span>, <span class="dv" style="color: #AD0000;">5000</span>)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="st" style="color: #20794D;">"RT (50 degrees)"</span>, <span class="at" style="color: #657422;">limits =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">500</span>, <span class="dv" style="color: #AD0000;">5000</span>)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-5">  <span class="co" style="color: #5E5E5E;"># Identity line</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;">geom_abline</span>(<span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">25</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-7">  <span class="co" style="color: #5E5E5E;"># 1:1 aspect ratio</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">aspect.ratio =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-9">  <span class="co" style="color: #5E5E5E;"># Points and errorbars</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;">geom_point</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;">geom_linerange</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">ymin =</span> m_50<span class="sc" style="color: #5E5E5E;">-</span>se_50, <span class="at" style="color: #657422;">ymax =</span> m_50<span class="sc" style="color: #5E5E5E;">+</span>se_50), <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">25</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-12">  <span class="fu" style="color: #4758AB;">geom_linerange</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">xmin =</span> m_0<span class="sc" style="color: #5E5E5E;">-</span>se_0, <span class="at" style="color: #657422;">xmax =</span> m_0<span class="sc" style="color: #5E5E5E;">+</span>se_0), <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">25</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter/index_files/figure-html/scatter-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows each person (mean) as a point and their SEs as thin lines. The difference between conditions can be directly seen by how far from the diagonal line the points are. Were we to use CIs, we could also see subject-specific significant differences. Points above the diagonal indicate that the person‚Äôs (mean) RT was greater in the 50 degrees condition. <em>All</em> of the points lie below the identity line, indicating that the effect was as we predicted, and robust across individuals.</p>
<p>This is a very useful diagnostic plot that simultaneously shows the population- (or group-) level trend (are the points, on average, below or above the identity line?) and the expectation (mean) for every person (roughly, how far apart the points are from each other?). The points are naturally connected by their location, unlike in a bar graph where they would be connected by lines. Maybe you think it‚Äôs an informative graph; it‚Äôs certainly very easy to do in R with ggplot2. Also, I think it is visually very convincing, and doesn‚Äôt necessarily lead one to focus unjustly just on the group means: I am both convinced and informed by the graph.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Within-subject scatter plots are pretty common in some fields (psychophysics), but underutilized in many fields where they might have a positive impact on statistical inference. Why not try them out on your own data, especially when they‚Äôre this easy to do with R and ggplot2?</p>
<p>Recall that for real applications, it‚Äôs better to transform or model reaction times with a skewed distribution. Here we used normal distributions just for convenience.</p>
<p>Finally, this post was made possible by the <span class="citation" data-cites="ganis_new_2015">Ganis and Kievit (2015)</span> who generously have shared their data online.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ganis_new_2015" class="csl-entry">
Ganis, Giorgio, and Rogier Kievit. 2015. <span>‚ÄúA New Set of Three-Dimensional Shapes for Investigating Mental Rotation Processes: Validation Data and Stimulus Set.‚Äù</span> <em>Journal of Open Psychology Data</em> 3 (1). <a href="https://doi.org/10.5334/jopd.ai">https://doi.org/10.5334/jopd.ai</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2017,
  author = {Matti Vuorre},
  title = {How to Create Within-Subject Scatter Plots in {R} with
    Ggplot2},
  date = {2017-01-04},
  url = {https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2017" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2017. <span>‚ÄúHow to Create Within-Subject Scatter Plots in
R with Ggplot2.‚Äù</span> January 4, 2017. <a href="https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter">https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>visualization</category>
  <category>ggplot2</category>
  <guid>https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter/index.html</guid>
  <pubDate>Wed, 04 Jan 2017 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2017-01-04-within-subject-scatter/index_files/figure-html/scatter-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>How to Compare Two Groups with Robust Bayesian Estimation in R</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Happy New Year 2017 everybody! 2017 will be the year when social scientists finally decided to diversify their applied statistics toolbox, and stop relying 100% on null hypothesis significance testing (NHST). We now recognize that different scientific questions may require different statistical tools, and are ready to adopt new and innovative methods. A very appealing alternative to NHST is Bayesian statistics, which in itself contains many approaches to statistical inference. In this post, I provide an introductory and practical tutorial to Bayesian parameter estimation in the context of comparing two independent groups‚Äô data.</p>
<p>More specifically, we‚Äôll focus on the t-test. Everyone knows it, everyone uses it. Yet, there are (arguably) better methods for drawing inferences from two independent groups‚Äô metric data <span class="citation" data-cites="kruschkeBayesianEstimationSupersedes2013">(Kruschke 2013)</span>:</p>
<blockquote class="blockquote">
<p>‚ÄúWhen data are interpreted in terms of meaningful parameters in a mathematical description, such as the difference of mean parameters in two groups, it is Bayesian analysis that provides complete information about the credible parameter values. Bayesian analysis is also more intuitive than traditional methods of null hypothesis significance testing (e.g., Dienes, 2011).‚Äù <span class="citation" data-cites="kruschkeBayesianEstimationSupersedes2013">(Kruschke 2013)</span></p>
</blockquote>
<p>In that article (<em>‚ÄúBayesian estimation supersedes the t-test‚Äù</em>) <span class="citation" data-cites="kruschkeBayesianEstimationSupersedes2013">Kruschke (2013)</span> provided clear and well-reasoned arguments favoring Bayesian parameter estimation over null hypothesis significance testing in the context of comparing two groups, a situation which is usually dealt with a t-test. It also introduced a ‚Äúrobust‚Äù model for comparing two groups, which modeled the data as t-distributed, instead of normal. The article provided R code for running the estimation procedures, which could be downloaded from the <a href="http://www.indiana.edu/~kruschke/BEST/">author‚Äôs website</a> or <a href="https://cran.r-project.org/package=BEST">as an R package</a>.</p>
<p>The R code and programs work well for this specific application (estimating the robust model for one or two groups‚Äô metric data). However, modifying the code to handle more complicated situations is not easy, and the underlying estimation algorithms don‚Äôt necessarily scale up to handle more complicated situations. Therefore, in this blog post I‚Äôll introduce easy to use, free, open-source, state-of-the-art computer programs for Bayesian estimation, in the context of comparing two groups‚Äô metric (continuous) data. The programs are available for the R programming language‚Äîso make sure you are familiar with R basics (e.g.&nbsp;<a href="http://blog.efpsa.org/2016/12/05/introduction-to-data-analysis-using-r/">here</a>). I provide R code for t-tests and Bayesian estimation in R using the R package <a href="https://cran.r-project.org/package=brms">brms</a>, which provides a concise front-end layer to <a href="http://mc-stan.org/">Stan</a>.</p>
<p>These programs supersede many older Bayesian inference programs because they are easy to use, fast, and are able to handle models with thousands of parameters. Learning to implement basic analyses such as t-tests, and Kruschke‚Äôs robust model, with these programs is very useful because you‚Äôll then be able to do Bayesian statistics in practice, and will be prepared to understand and implement more complex models.</p>
<p>Understanding the results of Bayesian estimation requires some knowledge of Bayesian statistics, of course, but since I cannot cover everything in this one post, I refer readers to excellent books on the topic: <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">McElreath (2020)</span>, <span class="citation" data-cites="kruschkeDoingBayesianData2014">Kruschke (2014)</span>, <span class="citation" data-cites="gelmanBayesianDataAnalysis2013">Gelman et al. (2013)</span>.</p>
<p>First, I‚Äôll introduce the basic t-test in some detail, and then focus on understanding them as specific instantiations of <em>linear models</em>. If that sounds familiar, skip ahead to Bayesian Estimation of the t-test, where I introduce the <strong>brms</strong> package for estimating models using Bayesian methods. Following that, we‚Äôll use ‚Äúdistributional regression‚Äù to obtain Bayesian estimates of the unequal variances t-test model. Finally, we‚Äôll learn how to estimate the robust unequal variances model using brms.</p>
<p>We will use the following R packages:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_c20f80666b7b32871dd0303a15a4e119">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(kableExtra)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(broom)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
</section>
<section id="the-t-in-a-t-test" class="level2">
<h2 class="anchored" data-anchor-id="the-t-in-a-t-test">The t in a t-test</h2>
<p>We‚Äôll begin with t-tests, using example data from Kruschke‚Äôs paper (p.&nbsp;577):</p>
<blockquote class="blockquote">
<p>‚ÄúConsider data from two groups of people who take an IQ test. Group 1 (N1=47) consumes a ‚Äúsmart drug,‚Äù and Group 2 (N2=42) is a control group that consumes a placebo.‚Äù</p>
</blockquote>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_f2646d19bedbc7dbb647207aea8aa0d2">

</div>
<p>These data are visualized as histograms, below:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/dataplot1_010c4453c00c39f3c08cce9b1954f2e0">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/index_files/figure-html/dataplot1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Histograms of the two groups‚Äô IQ scores.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<section id="equal-variances-t-test" class="level3">
<h3 class="anchored" data-anchor-id="equal-variances-t-test">Equal variances t-test</h3>
<p>These two groups‚Äô IQ scores could be compared with a simple <strong>equal variances t-test</strong> (which you shouldn‚Äôt use; <a href="https://daniellakens.blogspot.com/2015/01/always-use-welchs-t-test-instead-of.html">Lakens, 2015</a>), also known as Student‚Äôs t-test.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_f469487ee80746cfc327c61d952599f2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">t.test</span>(IQ <span class="sc" style="color: #5E5E5E;">~</span> Group, <span class="at" style="color: #657422;">data =</span> d, <span class="at" style="color: #657422;">var.equal =</span> T)</span>
<span id="cb2-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Two Sample t-test</span></span>
<span id="cb2-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## data:  IQ by Group</span></span>
<span id="cb2-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## t = -1.5587, df = 87, p-value = 0.1227</span></span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## alternative hypothesis: true difference in means between group Control and group Treatment is not equal to 0</span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 95 percent confidence interval:</span></span>
<span id="cb2-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  -3.544155  0.428653</span></span>
<span id="cb2-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sample estimates:</span></span>
<span id="cb2-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   mean in group Control mean in group Treatment </span></span>
<span id="cb2-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                100.3571                101.9149</span></span></code></pre></div>
</div>
<p>We interpret the t-test in terms of the observed t-value, and whether it exceeds the critical t-value. The critical t-value, in turn, is defined as the extreme <img src="https://latex.codecogs.com/png.latex?%5Calpha%20/%202"> percentiles of a t-distribution with the given degrees of freedom.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_ba309069df0008514dc5ea2c31794b57">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="384"></p>
<p></p><figcaption class="figure-caption">t distribution with 87 degrees of freedom, and observed t-value. The dashed vertical lines indicate the extreme 2.5 percentiles. We would reject the null hypothesis of no difference if the observed t-value exceeded these percentiles.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The test results in an observed t-value of 1.56, which is not far enough in the tails of a t-distribution with 87 degrees of freedom to warrant rejecting the null hypothesis (given that we are using <img src="https://latex.codecogs.com/png.latex?%5Calpha"> = .05, which may or may not be an entirely brilliant idea).</p>
</section>
<section id="unequal-variances-t-test" class="level3">
<h3 class="anchored" data-anchor-id="unequal-variances-t-test">Unequal variances t-test</h3>
<p>Next, we‚Äôll run the more appropriate, <strong>unequal variances t-test</strong> (also known as Welch‚Äôs t-test), which R gives by default:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_fd71ebf594333d99a0dbfd178e16dbe6">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">t.test</span>(IQ <span class="sc" style="color: #5E5E5E;">~</span> Group, <span class="at" style="color: #657422;">data =</span> d, <span class="at" style="color: #657422;">var.equal =</span> F)</span>
<span id="cb3-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb3-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Welch Two Sample t-test</span></span>
<span id="cb3-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb3-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## data:  IQ by Group</span></span>
<span id="cb3-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## t = -1.6222, df = 63.039, p-value = 0.1098</span></span>
<span id="cb3-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## alternative hypothesis: true difference in means between group Control and group Treatment is not equal to 0</span></span>
<span id="cb3-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 95 percent confidence interval:</span></span>
<span id="cb3-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  -3.4766863  0.3611848</span></span>
<span id="cb3-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sample estimates:</span></span>
<span id="cb3-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   mean in group Control mean in group Treatment </span></span>
<span id="cb3-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                100.3571                101.9149</span></span></code></pre></div>
</div>
<p>Note that while R gives Welch‚Äôs t-test by default, SPSS gives both. If you‚Äôre using SPSS, make sure to report the Welch‚Äôs test results, instead of the equal variances test. Here, the conclusion with respect to rejecting the null hypothesis of equal means is the same. However, notice that the results are numerically different, as they should, because these two t-tests refer to different models.</p>
<p>It is of course up to you, as a researcher, to decide whether you assume equal variances or not. But note that we almost always allow the means to be different (that‚Äôs the whole point of the test, really), while many treatments may just as well have an effect on the variances.</p>
<p>The first take-home message from today is that there are actually two t-tests, each associated with a different statistical model. And to make clear what the difference is, we must acquaint ourselves with the models.</p>
</section>
<section id="describing-the-models-underlying-the-t-tests" class="level3">
<h3 class="anchored" data-anchor-id="describing-the-models-underlying-the-t-tests">Describing the model(s) underlying the t-test(s)</h3>
<p>We don‚Äôt often think of t-<em>tests</em> (and ANOVAs) as <em>models</em>, but it turns out that they are just linear models disguised as ‚Äútests‚Äù (see <a href="http://www.sbirc.ed.ac.uk/cyril/SPM-course/Talks/2013/1-GLM-CP.pdf">here</a>, <a href="https://lindeloev.github.io/tests-as-linear/">here</a>, and <a href="https://stats.stackexchange.com/questions/59047/how-are-regression-the-t-test-and-the-anova-all-versions-of-the-general-linear">here</a>). Recently, there has been a tremendous push for model/parameter estimation, instead of null hypothesis significance testing <span class="citation" data-cites="gigerenzerMindlessStatistics2004 cummingNewStatisticsWhy2014 kruschkeDoingBayesianData2014">(Gigerenzer 2004; Cumming 2014; Kruschke 2014)</span>, so we will benefit from thinking about t-tests as linear models. Doing so will facilitate seamlessly expanding our models to handle more complicated situations.</p>
<p>The equal variances t-test models metric data with three parameters: Mean for group A, mean for group B, and one shared standard deviation (i.e.&nbsp;the assumption that the standard deviations are equal between the two groups.)</p>
<p>We call the metric outcome variable (IQ scores in our example) <img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D">, where <img src="https://latex.codecogs.com/png.latex?i"> is a subscript indicating the <img src="https://latex.codecogs.com/png.latex?i%5E%7Bth%7D"> datum, and <img src="https://latex.codecogs.com/png.latex?k"> indicates the <img src="https://latex.codecogs.com/png.latex?k%5E%7Bth%7D"> group. So <img src="https://latex.codecogs.com/png.latex?y_%7B19,%201%7D"> would be the 19th datum, belonging to group 1. Then we specify that <img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D"> are normally distributed, <img src="https://latex.codecogs.com/png.latex?N(%5Cmu_%7Bk%7D,%20%5Csigma)">, where <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bk%7D"> indicates the mean of group <img src="https://latex.codecogs.com/png.latex?k">, and <img src="https://latex.codecogs.com/png.latex?%5Csigma"> the common standard deviation.</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D%20%5Csim%20N(%5Cmu_%7Bk%7D,%20%5Csigma%5E2)"></p>
<p>Read the formula as ‚ÄúY is normally distributed with mean <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bk%7D"> (mu), and standard deviation <img src="https://latex.codecogs.com/png.latex?%5Csigma"> (sigma)‚Äù. Note that the standard deviation <img src="https://latex.codecogs.com/png.latex?%5Csigma"> doesn‚Äôt have any subscripts: we assume it is the same for the groups.</p>
<p>The means for groups 0 and 1 are simply <img src="https://latex.codecogs.com/png.latex?%5Cmu_0"> and <img src="https://latex.codecogs.com/png.latex?%5Cmu_1">, respectively, and their difference (let‚Äôs call it <img src="https://latex.codecogs.com/png.latex?d">) is <img src="https://latex.codecogs.com/png.latex?d%20=%20%5Cmu_0%20-%20%5Cmu_1">. The 95% CI for <img src="https://latex.codecogs.com/png.latex?d"> is given in the t-test output, and we can tell that it differs from the one given by Welch‚Äôs t-test.</p>
<p>It is unsurprising, then, that if we use a different model (the <a href="https://daniellakens.blogspot.com/2015/01/always-use-welchs-t-test-instead-of.html">more appropriate unequal variances model</a>), our inferences may be different. Welch‚Äôs t-test is the same as Student‚Äôs, except that now we assume (and subsequently estimate) a unique standard deviation <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7Bk%7D"> for both groups.</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D%20%5Csim%20N(%5Cmu_%7Bk%7D,%20%5Csigma_%7Bk%7D%5E2)"></p>
<p>This model makes a lot of sense, because rarely are we in a situation to <em>a priori</em> decide that the variance of scores in Group A is equal to the variance of scores in Group B. If you use the equal variances t-test, you should be prepared to justify and defend this assumption. (Deciding between models‚Äîsuch as between these two t-tests‚Äîis one way in which our prior information enters and influences data analysis.)</p>
<p>Armed with this knowledge, we can now see that ‚Äúconducting a t-test‚Äù can be understood as estimating one of these two models. By estimating the model, we obtain t-values, degrees of freedom, and consequently, <a href="http://fivethirtyeight.com/features/not-even-scientists-can-easily-explain-p-values/">p-values</a>.</p>
<p>However, for the models described here, it can be easier to think of the t-test as a specific type of the <strong>general linear model</strong>. We can re-write the t-test in an equivalent way, but instead have a specific parameter for the difference in means by writing it as a linear model. The equal variance model can be written as</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D%20%5Csim%20N(%5Cmu_%7Bk%7D,%20%5Csigma%5E2)"> <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bk%7D%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20Group_%7Bik%7D"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is just as before, but we now model the mean with an intercept (control group‚Äôs mean, <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">) and the effect of the treatment (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_1">). With this model, <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> directly tells us the estimated difference in the two groups. And because it is a parameter in the model, it has an associated standard error, t-value, degrees of freedom, and a p-value. The model can be estimated in R with the following line of code:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_18e542bb89dbd51bb24090b76bb1aede">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">olsmod <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(IQ <span class="sc" style="color: #5E5E5E;">~</span> Group, <span class="at" style="color: #657422;">data =</span> d)</span></code></pre></div>
</div>
<p>The key input here is a model formula, which in R is specified as <code>outcome ~ predictor</code> (<code>DV ~ IV</code>). Using the <code>lm()</code> function, we estimated a linear model predicting <code>IQ</code> from an intercept (automatically included) and a Group parameter. I called this object <code>olsmod</code> for Ordinary Least Squares Model.</p>
<p>R has it‚Äôs own model formula syntax, which is well worth learning. The formula in the previous model, <code>IQ ~ Group</code> means that we want to regress IQ on an intercept (which is implicitly included), and group (<code>Group</code>). Besides the formula, we only need to provide the data, which is contained in <code>d</code>.</p>
<p>You can verify that the results are identical to the equal variances t-test above.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_56682d283cd045c5f2d8eb7777380994">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">summary</span>(olsmod)</span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Call:</span></span>
<span id="cb5-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## lm(formula = IQ ~ Group, data = d)</span></span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb5-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Residuals:</span></span>
<span id="cb5-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##      Min       1Q   Median       3Q      Max </span></span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## -19.9149  -0.9149   0.0851   1.0851  22.0851 </span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb5-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Coefficients:</span></span>
<span id="cb5-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span id="cb5-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## (Intercept)    100.3571     0.7263 138.184   &lt;2e-16 ***</span></span>
<span id="cb5-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## GroupTreatment   1.5578     0.9994   1.559    0.123    </span></span>
<span id="cb5-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb5-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span id="cb5-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb5-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Residual standard error: 4.707 on 87 degrees of freedom</span></span>
<span id="cb5-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Multiple R-squared:  0.02717,    Adjusted R-squared:  0.01599 </span></span>
<span id="cb5-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## F-statistic:  2.43 on 1 and 87 DF,  p-value: 0.1227</span></span></code></pre></div>
</div>
<p>Focus on the <code>GroupTreatment</code> row in the estimated coefficients. <code>Estimate</code> is the point estimate (best guess) of the difference in means. <code>t value</code> is the observed t-value (identical to what <code>t.test()</code> reported), and the p-value (<code>Pr(&gt;|t|)</code>) matches as well. The <code>(Intercept)</code> row refers to <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">, which is the control group‚Äôs mean.</p>
<p>This way of thinking about the model, where we have parameters for one group‚Äôs mean, and the effect of the other group, facilitates focusing on the important parameter, the difference, instead of individual means. However, you can of course compute the difference from the means, or the means from one mean and a difference.</p>
</section>
</section>
<section id="bayesian-estimation-of-the-t-test" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-estimation-of-the-t-test">Bayesian estimation of the t-test</h2>
<section id="equal-variances-model" class="level3">
<h3 class="anchored" data-anchor-id="equal-variances-model">Equal variances model</h3>
<p>Next, I‚Äôll illustrate how to estimate the equal variances t-test using Bayesian methods.</p>
<p>Estimating this model with R, thanks to the Stan and brms teams, is as easy as the linear regression model we ran above. The most important function in the brms package is <code>brm()</code>, for Bayesian Regression Model(ing). The user needs only to input a model formula, just as above, and a data frame that contains the variables specified in the formula. <code>brm()</code> then translates the model into Stan language, and asks Stan to compile the model into C++ and draw samples from the posterior distribution. The result is an R object with the estimated results. We run the model and save the results to <code>mod_eqvar</code> for equal variances model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-7_a3c902108e9ee8bf6d8b363294a721b4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">mod_eqvar <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb6-2">  IQ <span class="sc" style="color: #5E5E5E;">~</span> Group,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,  <span class="co" style="color: #5E5E5E;"># Use 4 cores for parallel processing</span></span>
<span id="cb6-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"iqgroup"</span>  <span class="co" style="color: #5E5E5E;"># Save results into a file</span></span>
<span id="cb6-6">)</span></code></pre></div>
</div>
<p>The results can be viewed with <code>summary()</code>:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-8_c394c494672e0d2019bfadb8574d6c97">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">summary</span>(mod_eqvar)</span>
<span id="cb7-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">##  Family: gaussian </span></span>
<span id="cb7-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Links: mu = identity; sigma = identity </span></span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Formula: IQ ~ Group </span></span>
<span id="cb7-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">##    Data: d (Number of observations: 89) </span></span>
<span id="cb7-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb7-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##          total post-warmup draws = 4000</span></span>
<span id="cb7-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb7-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Population-Level Effects: </span></span>
<span id="cb7-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb7-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Intercept        100.36      0.73    98.93   101.75 1.00     3751     3056</span></span>
<span id="cb7-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## GroupTreatment     1.55      1.00    -0.38     3.58 1.00     3779     2943</span></span>
<span id="cb7-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb7-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Family Specific Parameters: </span></span>
<span id="cb7-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb7-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## sigma     4.72      0.36     4.09     5.48 1.00     3732     3046</span></span>
<span id="cb7-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb7-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb7-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb7-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<p>Notice that the model contains three parameters, one of which is the shared standard deviation <code>sigma</code>. Compare the output of the Bayesian model to the one estimated with <code>lm()</code> (OLS):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-9_3baba5f94d16532f646ec82efad7cd81">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Model results, left: OLS, right: brms.</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> term </th>
   <th style="text-align:right;"> estimate </th>
   <th style="text-align:right;"> std.error </th>
   <th style="text-align:left;"> brms </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Est.Error </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:right;"> 100.36 </td>
   <td style="text-align:right;"> 0.73 </td>
   <td style="text-align:left;"> Intercept </td>
   <td style="text-align:right;"> 100.36 </td>
   <td style="text-align:right;"> 0.73 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GroupTreatment </td>
   <td style="text-align:right;"> 1.56 </td>
   <td style="text-align:right;"> 1.00 </td>
   <td style="text-align:left;"> GroupTreatment </td>
   <td style="text-align:right;"> 1.55 </td>
   <td style="text-align:right;"> 1.00 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The point estimates (posterior means in the Bayesian model) and standard errors (SD of the respective posterior distribution) are pretty much identical.</p>
<p>We now know the models behind t-tests, and how to estimate the equal variances t-test using the <code>t.test()</code>, <code>lm()</code>, and <code>brm()</code> functions. We also know how to run Welch‚Äôs t-test using <code>t.test()</code>. However, estimating the general linear model version of the unequal variances t-test model is slightly more complicated, because it involves specifying predictors for <img src="https://latex.codecogs.com/png.latex?%5Csigma">, the standard deviation parameter.</p>
</section>
<section id="unequal-variances-model" class="level3">
<h3 class="anchored" data-anchor-id="unequal-variances-model">Unequal variances model</h3>
<p>We only need a small adjustment to the equal variances model to specify the unequal variances model:</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D%20%5Csim%20N(%5Cmu_%7Bk%7D,%20%5Csigma_%7Bk%7D)"> <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bk%7D%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20Group_%7Bik%7D"></p>
<p>Notice that we now have subscripts for <img src="https://latex.codecogs.com/png.latex?%5Csigma">, denoting that it varies between groups. In fact, we‚Äôll write out a linear model for the standard deviation parameter.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csigma_%7Bk%7D%20=%20%5Cgamma_0%20+%20%5Cgamma_1%20Group_%7Bik%7D"></p>
<p>The model now includes, instead of a common <img src="https://latex.codecogs.com/png.latex?%5Csigma">, one parameter for Group 0‚Äôs standard deviation <img src="https://latex.codecogs.com/png.latex?%5Cgamma_0"> (gamma), and one for the effect of Group 1 on the standard deviation <img src="https://latex.codecogs.com/png.latex?%5Cgamma_1">, such that group 1‚Äôs standard deviation is <img src="https://latex.codecogs.com/png.latex?%5Cgamma_0%20+%20%5Cgamma_1">. Therefore, we have 4 free parameters, two means and two standard deviations. (The full specification would include prior distributions for all the parameters, but that topic is outside of the scope of this post.) <code>brm()</code> takes more complicated models by wrapping them inside <code>bf()</code> (short for <code>brmsformula()</code>), which is subsequently entered as the first argument to <code>brm()</code>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-10_43b399d45de91eceaa16b14fbb3dfc9b">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">uneq_var_frm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bf</span>(IQ <span class="sc" style="color: #5E5E5E;">~</span> Group, sigma <span class="sc" style="color: #5E5E5E;">~</span> Group)</span></code></pre></div>
</div>
<p>You can see that the formula regresses IQ on Group, such that we‚Äôll have an intercept (implicitly included), and an effect of Group 1. We also model the standard deviation sigma on Group.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-11_1bc91816870236e5afe5de100e0191a9">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">mod_uneqvar <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb9-2">  uneq_var_frm,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb9-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"iqgroup-uv"</span></span>
<span id="cb9-6">)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-12_e22d832a0cddd7bf8395bc7a5d2afaa1">
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: IQ ~ Group 
##          sigma ~ Group
##    Data: d (Number of observations: 89) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept              100.36      0.40    99.59   101.13 1.00     5504     2987
## sigma_Intercept          0.93      0.11     0.72     1.17 1.00     3359     2430
## GroupTreatment           1.55      1.00    -0.38     3.57 1.00     3006     2714
## sigma_GroupTreatment     0.87      0.16     0.56     1.17 1.00     3605     2689
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<p>The model‚Äôs output contains our 4 parameters. <code>Intercept</code> is the mean for group 0, <code>Group 1</code> is the ‚Äúeffect of group 1‚Äù. The <code>sigma_Intercept</code> is the standard deviation of Group 0, <code>sigma_Group</code> is the effect of group 1 on the standard deviation (the SD of Group 1 is <code>sigma_Intercept</code> + <code>sigma_Group</code>). The sigmas are implicitly modeled through a log-link (because they must be positive). To convert them back to the scale of the data, they need to be exponentiated. After taking the exponents of the sigmas, the results look like this:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-13_91a06583cb8e972d7928824c94480c8a">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Posterior summary after transformation</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Parameter </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Est.Error </th>
   <th style="text-align:right;"> Q2.5 </th>
   <th style="text-align:right;"> Q97.5 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Intercept </td>
   <td style="text-align:right;"> 100.36 </td>
   <td style="text-align:right;"> 0.40 </td>
   <td style="text-align:right;"> 99.59 </td>
   <td style="text-align:right;"> 101.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sigma_Intercept </td>
   <td style="text-align:right;"> 2.56 </td>
   <td style="text-align:right;"> 0.29 </td>
   <td style="text-align:right;"> 2.06 </td>
   <td style="text-align:right;"> 3.21 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GroupTreatment </td>
   <td style="text-align:right;"> 1.55 </td>
   <td style="text-align:right;"> 1.00 </td>
   <td style="text-align:right;"> -0.38 </td>
   <td style="text-align:right;"> 3.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sigma_GroupTreatment </td>
   <td style="text-align:right;"> 2.41 </td>
   <td style="text-align:right;"> 0.38 </td>
   <td style="text-align:right;"> 1.76 </td>
   <td style="text-align:right;"> 3.23 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Keep in mind that the parameters refer to Group 0‚Äôs mean (Intercept) and SD (sigma), and the difference between groups in those values (Group) and (sigma_Group). We now have fully Bayesian estimates of the 4 parameters of the unequal variances t-test model. Finally, let‚Äôs move on to the ‚ÄúRobust Bayesian Estimation‚Äù model.</p>
</section>
</section>
<section id="robust-bayesian-estimation" class="level2">
<h2 class="anchored" data-anchor-id="robust-bayesian-estimation">Robust Bayesian Estimation</h2>
<p>Kruschke‚Äôs robust model is a comparison of two groups, using five parameters: One mean for each group, one standard deviation for each group, just as in the unequal variances model above. The fifth parameter is a ‚Äúnormality‚Äù parameter, <img src="https://latex.codecogs.com/png.latex?%5Cnu"> (nu), which means that we are now using a t-distribution to model the data. Using a t-distribution to model the data, instead of a Gaussian, means that the model is less sensitive to extreme values. Here‚Äôs what the model looks like:</p>
<p><img src="https://latex.codecogs.com/png.latex?y_%7Bik%7D%20%5Csim%20T(%5Cnu,%20%5Cmu_%7Bk%7D,%20%5Csigma_%7Bk%7D)"></p>
<p>Read the above formula as ‚ÄúY are random draws from a t-distribution with ‚Äònormality‚Äô parameter <img src="https://latex.codecogs.com/png.latex?%5Cnu">, mean <img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bk%7D">, and standard deviation <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7Bk%7D">‚Äù. We have linear models for the means and standard deviations, as above.</p>
<p>This model, as you can see, is almost identical to the unequal variances t-test, but instead uses a t distribution (we assume data are t-distributed), and includes the normality parameter. Using <code>brm()</code> we can still use the unequal variances model, but have to specify the t-distribution. We do this by specifying the <code>family</code> argument to be <code>student</code> (as in Student‚Äôs t)</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-14_500a9524a8e25806acf32563743df2c1">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">mod_robust <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;">bf</span>(IQ <span class="sc" style="color: #5E5E5E;">~</span> Group, sigma <span class="sc" style="color: #5E5E5E;">~</span> Group),</span>
<span id="cb11-3">  <span class="at" style="color: #657422;">family =</span> student,</span>
<span id="cb11-4">  <span class="at" style="color: #657422;">data =</span> d,</span>
<span id="cb11-5">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb11-6">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"iqgroup-robust"</span></span>
<span id="cb11-7">)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-15_46fb2a1eb497d5e24e38d966dfa06437">
<pre><code>##  Family: student 
##   Links: mu = identity; sigma = log; nu = identity 
## Formula: IQ ~ Group 
##          sigma ~ Group
##    Data: d (Number of observations: 89) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept              100.52      0.21   100.11   100.96 1.00     5221     2774
## sigma_Intercept          0.00      0.20    -0.38     0.39 1.00     3936     3069
## GroupTreatment           1.03      0.43     0.18     1.88 1.00     2918     2756
## sigma_GroupTreatment     0.67      0.25     0.20     1.16 1.00     4031     2919
## 
## Family Specific Parameters: 
##    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## nu     1.87      0.48     1.15     3.00 1.00     2987     2011
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<p>You can compare the results to those in Kruschke‚Äôs paper (2013, p.578) to verify that they are nearly identical. There are small discrepancies because of limited number of posterior samples, and because the paper reported posterior modes whereas we focused on means.</p>
<p>Finally, here is how to estimate the model using the original code (Kruschke &amp; Meredith, 2015):</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-16_596625b05c5126695e0a5854983c1d29">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;">library</span>(BEST)</span>
<span id="cb13-2">BEST <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">BESTmcmc</span>(group_0, group_1)</span></code></pre></div>
</div>
<p>I didn‚Äôt actually run that code because after numerous attempts, I was unable to install the rjags package that BEST depends on.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Well, that ended up much longer than what I intended. The aim was both to illustrate the ease of Bayesian modeling in R using brms, and highlight the fact that we can easily move from simple t-tests to more complex (and possibly better) models.</p>
<p>If you‚Äôve followed through, you should be able to conduct Student‚Äôs (equal variances) and Welch‚Äôs (unequal variances) t-tests in R, and to think about those tests as instantiations of general linear models. Further, you should be able to estimate these models using Bayesian methods.</p>
<p>You should now also be familiar with Kruschke‚Äôs robust model for comparing two groups‚Äô metric data, and be able to implement it a few lines of R code. This model found credible differences between two groups, although the frequentist t-tests and models reported p-values well above .05. That should be motivation enough to try robust (Bayesian) models on your own data.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-cummingNewStatisticsWhy2014" class="csl-entry">
Cumming, Geoff. 2014. <span>‚ÄúThe <span>New Statistics Why</span> and <span>How</span>.‚Äù</span> <em>Psychological Science</em> 25 (1): 7‚Äì29. <a href="https://doi.org/10.1177/0956797613504966">https://doi.org/10.1177/0956797613504966</a>.
</div>
<div id="ref-gelmanBayesianDataAnalysis2013" class="csl-entry">
Gelman, Andrew, John B. Carlin, Hal S. Stern, David B. Dunson, Aki Vehtari, and Donald B. Rubin. 2013. <em>Bayesian <span>Data Analysis</span>, <span>Third Edition</span></em>. <span>Boca Raton</span>: <span>Chapman and Hall/CRC</span>.
</div>
<div id="ref-gigerenzerMindlessStatistics2004" class="csl-entry">
Gigerenzer, Gerd. 2004. <span>‚ÄúMindless Statistics.‚Äù</span> <em>The Journal of Socio-Economics</em>, Statistical <span>Significance</span>, 33 (5): 587‚Äì606. <a href="https://doi.org/10.1016/j.socec.2004.09.033">https://doi.org/10.1016/j.socec.2004.09.033</a>.
</div>
<div id="ref-kruschkeBayesianEstimationSupersedes2013" class="csl-entry">
Kruschke, John K. 2013. <span>‚ÄúBayesian Estimation Supersedes the t Test.‚Äù</span> <em>Journal of Experimental Psychology: General</em> 142 (2): 573‚Äì603. <a href="https://doi.org/10.1037/a0029146">https://doi.org/10.1037/a0029146</a>.
</div>
<div id="ref-kruschkeDoingBayesianData2014" class="csl-entry">
‚Äî‚Äî‚Äî. 2014. <em>Doing <span>Bayesian Data Analysis</span>: <span>A Tutorial Introduction</span> with <span>R</span></em>. 2nd Edition. <span>Burlington, MA</span>: <span>Academic Press</span>.
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry">
McElreath, Richard. 2020. <em>Statistical Rethinking: A <span>Bayesian</span> Course with Examples in <span>R</span> and <span>Stan</span></em>. Second. <span>CRC</span> Texts in Statistical Science. <span>Boca Raton</span>: <span>Taylor and Francis, CRC Press</span>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2017,
  author = {Matti Vuorre},
  title = {How to {Compare} {Two} {Groups} with {Robust} {Bayesian}
    {Estimation} in {R}},
  date = {2017-01-02},
  url = {https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2017" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2017. <span>‚ÄúHow to Compare Two Groups with Robust
Bayesian Estimation in R.‚Äù</span> January 2, 2017. <a href="https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms">https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>tutorial</category>
  <category>R</category>
  <category>brms</category>
  <guid>https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/index.html</guid>
  <pubDate>Mon, 02 Jan 2017 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/index_files/figure-html/dataplot1-1.png" medium="image" type="image/png" height="66" width="144"/>
</item>
<item>
  <title>How to arrange ggplot2 panel plots</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index.html</link>
  <description><![CDATA[ 




<p>Panel plots are a common name for figures showing every person‚Äôs (or whatever your sampling unit is) data in their own panel. This plot is sometimes also known as ‚Äúsmall multiples‚Äù, although that more commonly refers to plots that illustrate interactions. Here, I‚Äôll illustrate how to add information to a panel plot by arranging the panels according to some meaningful value.</p>
<p>Here‚Äôs an example of a panel plot, using the <code>sleepstudy</code> data set from the <strong>lme4</strong> package.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_2802963cf0a15e6886e81041cbefff9f">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/image1_a95196f800632ee61020c211b0a6ca35">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">data</span>(sleepstudy, <span class="at" style="color: #657422;">package =</span> <span class="st" style="color: #20794D;">"lme4"</span>)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;">ggplot</span>(sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> Days, <span class="at" style="color: #657422;">y =</span> Reaction)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;">geom_point</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;">scale_x_continuous</span>(<span class="at" style="color: #657422;">breaks =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"Subject"</span>, <span class="at" style="color: #657422;">labeller =</span> label_both)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index_files/figure-html/image1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On the x-axis is days of sleep deprivation, and y-axis is an aggregate measure of reaction time across a number of cognitive tasks. Reaction time increases as a function of sleep deprivation. But the order of the panels is entirely uninformative, they are simply arranged in increasing order of subject ID number, from top left to bottom right. Subject ID numbers are rarely informative, and we would therefore like to order the panels according to some other fact about the individual participants.</p>
<section id="order-panels-on-mean-value" class="level1">
<h1>Order panels on mean value</h1>
<p>Let‚Äôs start by ordering the panels on the participants‚Äô mean reaction time, with the fastest participant in the upper-left panel.</p>
<p>Step 1 is to add the required information to the data frame used in plotting. For a simple mean, we can actually use a shortcut in step 2, so this isn‚Äôt required.</p>
<p>Step 2: Convert the variable used to separate the panels into a factor, and order it based on the mean reaction time.</p>
<p>The key here is to use the <code>reorder()</code> function. You‚Äôll first enter the variable that contains the groupings (i.e.&nbsp;the subject ID numbers), and then values that will be used to order the grouping variables. Finally, here you can use a shortcut to base the ordering on a function of the values, such as the mean, by entering it as the third argument.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_dd03fbb642cbaa682ab449fa00e28297">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sleepstudy <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb3-2">  sleepstudy,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;">Subject =</span> <span class="fu" style="color: #4758AB;">reorder</span>(Subject, Reaction, mean)</span>
<span id="cb3-4">)</span></code></pre></div>
</div>
<p>Now if we use <code>Subject</code> to create the subplots, they will be ordered on the mean reaction time. I‚Äôll make the illustration clear by also drawing the person-means with small arrows.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_3ea1d9452492798e34e9c1dd4e4e3f3c">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="order-panels-on-other-parameters" class="level1">
<h1>Order panels on other parameters</h1>
<p>It might also be useful to order the panels based on a value from a model, such as the slope of a linear regression. This is especially useful in making the heterogeneity in the sample easier to see. For this, you‚Äôll need to fit a model, grab the subject-specific slopes, order the paneling factor, and plot. I‚Äôll illustrate with a multilevel regression using <strong>lme4</strong>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_3459c861c71cdd06220088f192f6fffd">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;"># Step 1: Add values to order on into the data frame</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;">library</span>(lme4)</span>
<span id="cb4-3">mod <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lmer</span>(Reaction <span class="sc" style="color: #5E5E5E;">~</span> Days <span class="sc" style="color: #5E5E5E;">+</span> (Days <span class="sc" style="color: #5E5E5E;">|</span> Subject), <span class="at" style="color: #657422;">data =</span> sleepstudy)</span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;"># Create a data frame with subject IDs and coefficients</span></span>
<span id="cb4-5">coefs <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">coef</span>(mod)<span class="sc" style="color: #5E5E5E;">$</span>Subject <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;">rownames_to_column</span>(<span class="st" style="color: #20794D;">"Subject"</span>)</span>
<span id="cb4-7"><span class="fu" style="color: #4758AB;">names</span>(coefs) <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"Subject"</span>, <span class="st" style="color: #20794D;">"Intercept"</span>, <span class="st" style="color: #20794D;">"Slope"</span>)</span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;"># Join to main data frame by Subject ID</span></span>
<span id="cb4-9">sleepstudy <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">left_join</span>(sleepstudy, coefs, <span class="at" style="color: #657422;">by =</span> <span class="st" style="color: #20794D;">"Subject"</span>)</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;"># Step 2: Reorder the grouping factor</span></span>
<span id="cb4-12">sleepstudy <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">mutate</span>(</span>
<span id="cb4-13">  sleepstudy,</span>
<span id="cb4-14">  <span class="at" style="color: #657422;">Subject =</span> <span class="fu" style="color: #4758AB;">reorder</span>(Subject, Slope)</span>
<span id="cb4-15">)</span></code></pre></div>
</div>
<p>Then, I‚Äôll plot the data also showing the fitted lines from the multilevel model:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_253dea3c6adcfe0f1fc49531668cd936">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Hopefully you‚Äôll find this helpful.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2016,
  author = {Matti Vuorre},
  title = {How to Arrange Ggplot2 Panel Plots},
  date = {2016-12-06},
  url = {https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2016" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2016. <span>‚ÄúHow to Arrange Ggplot2 Panel Plots.‚Äù</span>
December 6, 2016. <a href="https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots">https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots</a>.
</div></div></section></div> ]]></description>
  <category>data science</category>
  <category>R</category>
  <category>visualization</category>
  <guid>https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index.html</guid>
  <pubDate>Tue, 06 Dec 2016 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2016-12-06-order-ggplot-panel-plots/index_files/figure-html/image1-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Bayesian Meta-Analysis with R, Stan, and brms</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Recently, there‚Äôs been a lot of talk about meta-analysis, and here I would just like to quickly show that Bayesian multilevel modeling nicely takes care of your meta-analysis needs, and that it is easy to do in R with the rstan and brms packages. As you‚Äôll see, meta-analysis is a special case of Bayesian multilevel modeling when you are unable or unwilling to put a prior distribution on the meta-analytic effect size estimate.</p>
<p>The idea for this post came from Wolfgang Viechtbauer‚Äôs <a href="http://www.metafor-project.org/doku.php/tips:rma_vs_lm_lme_lmer?s%5B%5D=lme4">website</a>, where he compared results for meta-analytic models fitted with his great (frequentist) package <a href="http://www.metafor-project.org/doku.php/metafor">metafor</a> and the swiss army knife of multilevel modeling, <a href="https://cran.r-project.org/web/packages/lme4/index.html">lme4</a>. It turns out that even though you can fit meta-analytic models with lme4, the results are slightly different from traditional meta-analytic models, because the experiment-wise variances are treated slightly differently.</p>
<p>Here are the packages we‚Äôll use:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_43e326fa66c64602900a71de6b7ef011">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(kableExtra)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(metafor)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(lme4)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>Here I‚Äôll only focus on a simple random effects meta-analysis of effect sizes, and will use the same example data as in the aforementioned <a href="http://www.metafor-project.org/doku.php/tips:rma_vs_lm_lme_lmer?s%5B%5D=lme4">website</a>. The data are included in the metafor package, and describe the relationship between conscientiousness and medication adherence. The effect sizes are r to z transformed correlations.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/obtain-data_9e42636206d53c6d8aeef44b86a913d1">

</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/display-fake-data_7319afe6b279a26ee1374c3d0f0fa4d8">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Example data (dat.molloy2014 in metafor package).</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> study </th>
   <th style="text-align:right;"> year </th>
   <th style="text-align:right;"> ni </th>
   <th style="text-align:right;"> ri </th>
   <th style="text-align:right;"> yi </th>
   <th style="text-align:right;"> vi </th>
   <th style="text-align:right;"> sei </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Axelsson et al. (2009) </td>
   <td style="text-align:right;"> 2009 </td>
   <td style="text-align:right;"> 109 </td>
   <td style="text-align:right;"> 0.19 </td>
   <td style="text-align:right;"> 0.19 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Axelsson et al. (2011) </td>
   <td style="text-align:right;"> 2011 </td>
   <td style="text-align:right;"> 749 </td>
   <td style="text-align:right;"> 0.16 </td>
   <td style="text-align:right;"> 0.16 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Bruce et al. (2010) </td>
   <td style="text-align:right;"> 2010 </td>
   <td style="text-align:right;"> 55 </td>
   <td style="text-align:right;"> 0.34 </td>
   <td style="text-align:right;"> 0.35 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.14 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Christensen et al. (1995) </td>
   <td style="text-align:right;"> 1995 </td>
   <td style="text-align:right;"> 72 </td>
   <td style="text-align:right;"> 0.27 </td>
   <td style="text-align:right;"> 0.28 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.12 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Christensen et al. (1999) </td>
   <td style="text-align:right;"> 1999 </td>
   <td style="text-align:right;"> 107 </td>
   <td style="text-align:right;"> 0.32 </td>
   <td style="text-align:right;"> 0.33 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Cohen et al. (2004) </td>
   <td style="text-align:right;"> 2004 </td>
   <td style="text-align:right;"> 65 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Dobbels et al. (2005) </td>
   <td style="text-align:right;"> 2005 </td>
   <td style="text-align:right;"> 174 </td>
   <td style="text-align:right;"> 0.17 </td>
   <td style="text-align:right;"> 0.18 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ediger et al. (2007) </td>
   <td style="text-align:right;"> 2007 </td>
   <td style="text-align:right;"> 326 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.06 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Insel et al. (2006) </td>
   <td style="text-align:right;"> 2006 </td>
   <td style="text-align:right;"> 58 </td>
   <td style="text-align:right;"> 0.26 </td>
   <td style="text-align:right;"> 0.27 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Jerant et al. (2011) </td>
   <td style="text-align:right;"> 2011 </td>
   <td style="text-align:right;"> 771 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Moran et al. (1997) </td>
   <td style="text-align:right;"> 1997 </td>
   <td style="text-align:right;"> 56 </td>
   <td style="text-align:right;"> -0.09 </td>
   <td style="text-align:right;"> -0.09 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.14 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> O'Cleirigh et al. (2007) </td>
   <td style="text-align:right;"> 2007 </td>
   <td style="text-align:right;"> 91 </td>
   <td style="text-align:right;"> 0.37 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Penedo et al. (2003) </td>
   <td style="text-align:right;"> 2003 </td>
   <td style="text-align:right;"> 116 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Quine et al. (2012) </td>
   <td style="text-align:right;"> 2012 </td>
   <td style="text-align:right;"> 537 </td>
   <td style="text-align:right;"> 0.15 </td>
   <td style="text-align:right;"> 0.15 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Stilley et al. (2004) </td>
   <td style="text-align:right;"> 2004 </td>
   <td style="text-align:right;"> 158 </td>
   <td style="text-align:right;"> 0.24 </td>
   <td style="text-align:right;"> 0.24 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.08 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wiebe &amp; Christensen (1997) </td>
   <td style="text-align:right;"> 1997 </td>
   <td style="text-align:right;"> 65 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.13 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>We are going to fit a random-effects meta-analysis model to these observed effect sizes and their standard errors. Here‚Äôs what this model looks like, loosely following notation from the R package Metafor‚Äôs manual (p.6):</p>
<p><img src="https://latex.codecogs.com/png.latex?y_i%20%5Csim%20N(%5Ctheta_i,%20%5Csigma_i%5E2)"></p>
<p>where each recorded effect size, <img src="https://latex.codecogs.com/png.latex?y_i"> is a draw from a normal distribution which is centered on that study‚Äôs ‚Äútrue‚Äù effect size <img src="https://latex.codecogs.com/png.latex?%5Ctheta_i"> and has standard deviation equal to the study‚Äôs observed standard error <img src="https://latex.codecogs.com/png.latex?%5Csigma_i">.</p>
<p>Our next set of assumptions is that the studies‚Äô true effect sizes approximate some underlying effect size in the (hypothetical) population of all studies. We call this underlying population effect size <img src="https://latex.codecogs.com/png.latex?%5Cmu">, and its standard deviation <img src="https://latex.codecogs.com/png.latex?%5Ctau">, such that the true effect sizes are thus distributed:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta_i%20%5Csim%20N(%5Cmu,%20%5Ctau%5E2)"></p>
<p>We now have two interesting parameters: <img src="https://latex.codecogs.com/png.latex?%5Cmu"> tells us, all else being equal, what I may expect the ‚Äútrue‚Äù effect to be, in the population of similar studies. <img src="https://latex.codecogs.com/png.latex?%5Ctau"> tells us how much individual studies of this effect vary.</p>
<p>I think it is most straightforward to write this model as yet another mixed-effects model (metafor manual p.6):</p>
<p><img src="https://latex.codecogs.com/png.latex?y_i%20%5Csim%20N(%5Cmu%20+%20%5Ctheta_i,%20%5Csigma%5E2_i)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Ctheta_i%20%5Csim%20N(0,%20%5Ctau%5E2)">, studies‚Äô true effects are normally distributed with between-study heterogeneity <img src="https://latex.codecogs.com/png.latex?%5Ctau%5E2">. The reason this is a little confusing (to me at least), is that we know the <img src="https://latex.codecogs.com/png.latex?%5Csigma_i">s (this being the fact that separates meta-analysis from other more common regression modeling).</p>
<section id="estimation-with-metafor" class="level3">
<h3 class="anchored" data-anchor-id="estimation-with-metafor">Estimation with metafor</h3>
<p>Super easy!</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_8de6250d974b12b734b525f2a7880a47">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;">library</span>(metafor)</span>
<span id="cb2-2">ma_out <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rma</span>(<span class="at" style="color: #657422;">data =</span> dat, <span class="at" style="color: #657422;">yi =</span> yi, <span class="at" style="color: #657422;">sei =</span> sei, <span class="at" style="color: #657422;">slab =</span> dat<span class="sc" style="color: #5E5E5E;">$</span>study)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;">summary</span>(ma_out)</span>
<span id="cb2-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Random-Effects Model (k = 16; tau^2 estimator: REML)</span></span>
<span id="cb2-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   logLik  deviance       AIC       BIC      AICc  ‚Äã </span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   8.6096  -17.2191  -13.2191  -11.8030  -12.2191   </span></span>
<span id="cb2-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-10"><span class="do" style="color: #5E5E5E;
font-style: italic;">## tau^2 (estimated amount of total heterogeneity): 0.0081 (SE = 0.0055)</span></span>
<span id="cb2-11"><span class="do" style="color: #5E5E5E;
font-style: italic;">## tau (square root of estimated tau^2 value):      0.0901</span></span>
<span id="cb2-12"><span class="do" style="color: #5E5E5E;
font-style: italic;">## I^2 (total heterogeneity / total variability):   61.73%</span></span>
<span id="cb2-13"><span class="do" style="color: #5E5E5E;
font-style: italic;">## H^2 (total variability / sampling variability):  2.61</span></span>
<span id="cb2-14"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-15"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Test for Heterogeneity:</span></span>
<span id="cb2-16"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Q(df = 15) = 38.1595, p-val = 0.0009</span></span>
<span id="cb2-17"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-18"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Model Results:</span></span>
<span id="cb2-19"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-20"><span class="do" style="color: #5E5E5E;
font-style: italic;">## estimate      se    zval    pval   ci.lb   ci.ub     ‚Äã </span></span>
<span id="cb2-21"><span class="do" style="color: #5E5E5E;
font-style: italic;">##   0.1499  0.0316  4.7501  &lt;.0001  0.0881  0.2118  *** </span></span>
<span id="cb2-22"><span class="do" style="color: #5E5E5E;
font-style: italic;">## </span></span>
<span id="cb2-23"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb2-24"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</div>
</section>
</section>
<section id="bayesian-estimation" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-estimation">Bayesian estimation</h2>
<p>So far so good, we‚Äôre strictly in the realm of standard meta-analysis. But I would like to propose that instead of using custom meta-analysis software, we simply consider the above model as just another regression model, and fit it like we would any other (multilevel) regression model. That is, using <a href="http://mc-stan.org/">Stan</a>, usually through the <a href="https://cran.r-project.org/package=brms">brms</a> interface. Going Bayesian allows us to assign prior distributions on the population-level parameters <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and <img src="https://latex.codecogs.com/png.latex?%5Ctau">, and we would usually want to use some very mildly regularizing priors. Here we proceed with brms‚Äô default priors (which I print below with the output)</p>
<section id="estimation-with-brms" class="level3">
<h3 class="anchored" data-anchor-id="estimation-with-brms">Estimation with brms</h3>
<p>Here‚Äôs how to fit this model with brms:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fit-ma-brms_a697bad10c015e4f6f661029504bf246">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">brm_out <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb3-2">  yi <span class="sc" style="color: #5E5E5E;">|</span> <span class="fu" style="color: #4758AB;">se</span>(sei) <span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">|</span> study), </span>
<span id="cb3-3">  <span class="at" style="color: #657422;">data =</span> dat, </span>
<span id="cb3-4">  <span class="at" style="color: #657422;">cores =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"metaanalysismodel"</span></span>
<span id="cb3-6">)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/results-disp_eba04825fdc1e5e076ce884587958839">
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: yi | se(sei) ~ 1 + (1 | study) 
##    Data: dat (Number of observations: 16) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Priors: 
## Intercept ~ student_t(3, 0.2, 2.5)
## &lt;lower=0&gt; sd ~ student_t(3, 0, 2.5)
## 
## Group-Level Effects: 
## ~study (Number of levels: 16) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.10      0.04     0.04     0.20 1.00     1256     1887
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.15      0.04     0.08     0.22 1.00     1957     1884
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.00      0.00     0.00     0.00   NA       NA       NA
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<p>These results are the same as the ones obtained with metafor. Note the Student‚Äôs <em>t</em> prior distributions, which are diffuse enough not to exert influence on the posterior distribution.</p>
</section>
</section>
<section id="comparing-results" class="level2">
<h2 class="anchored" data-anchor-id="comparing-results">Comparing results</h2>
<p>We can now compare the results of these two estimation methods. Of course, the Bayesian method has a tremendous advantage, because it results in a full distribution of plausible values.</p>
<div class="cell" data-layout-align="center" data-preview="true" data-hash="index_cache/html/unnamed-chunk-2_81877cd9b64032094068d926ebc097f9">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Histogram of samples from the posterior distribution of the average effect size (top left) and the variability (top right). Bottom left displays the multivariate posterior distribution of the average (x-axis) and the standard deviation (y-axis), light colors indicating increased plausibility of values. For each plot, the dashed lines display the maximum likelihood point estimate, and 95% confidence limits (only the point estimate is displayed for the multivariate figure.)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can see from the numeric output, and especially the figures, that these modes of inference yield the same numerical results. Keep in mind though, that the Bayesian estimates actually allow you to discuss probabilities, and generally the things that we‚Äôd like to discuss when talking about results.</p>
<p>For example, what is the probability that the average effect size is greater than 0.2? About eight percent:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_ea0fd8b7960792f1a1972b30dabad773">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">hypothesis</span>(brm_out, <span class="st" style="color: #20794D;">"Intercept &gt; 0.2"</span>)</span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Hypothesis Tests for class b:</span></span>
<span id="cb5-3"><span class="do" style="color: #5E5E5E;
font-style: italic;">##              Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star</span></span>
<span id="cb5-4"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 1 (Intercept)-(0.2) &gt; 0    -0.05      0.04    -0.11     0.01       0.08      0.08     </span></span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
font-style: italic;">## ---</span></span>
<span id="cb5-6"><span class="do" style="color: #5E5E5E;
font-style: italic;">## 'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.</span></span>
<span id="cb5-7"><span class="do" style="color: #5E5E5E;
font-style: italic;">## '*': For one-sided hypotheses, the posterior probability exceeds 95%;</span></span>
<span id="cb5-8"><span class="do" style="color: #5E5E5E;
font-style: italic;">## for two-sided hypotheses, the value tested against lies outside the 95%-CI.</span></span>
<span id="cb5-9"><span class="do" style="color: #5E5E5E;
font-style: italic;">## Posterior probabilities of point hypotheses assume equal prior probabilities.</span></span></code></pre></div>
</div>
<section id="forest-plot" class="level3">
<h3 class="anchored" data-anchor-id="forest-plot">Forest plot</h3>
<p>The forest plot displays the entire posterior distribution of each <img src="https://latex.codecogs.com/png.latex?%5Ctheta_i">. The meta-analytic effect size <img src="https://latex.codecogs.com/png.latex?%5Cmu"> is also displayed in the bottom row. I‚Äôll show a considerable amount of code here so that you can create your own forest plots from brms output:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/draw-forest-plot_c844276a86710c6650f9b1ff4e93672b">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">library</span>(tidybayes)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;">library</span>(ggdist)</span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;"># Study-specific effects are deviations + average</span></span>
<span id="cb6-4">out_r <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">spread_draws</span>(brm_out, r_study[study,term], b_Intercept) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">b_Intercept =</span> r_study <span class="sc" style="color: #5E5E5E;">+</span> b_Intercept) </span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;"># Average effect</span></span>
<span id="cb6-7">out_f <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">spread_draws</span>(brm_out, b_Intercept) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">study =</span> <span class="st" style="color: #20794D;">"Average"</span>)</span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;"># Combine average and study-specific effects' data frames</span></span>
<span id="cb6-10">out_all <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bind_rows</span>(out_r, out_f) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;">ungroup</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-12">  <span class="co" style="color: #5E5E5E;"># Ensure that Average effect is on the bottom of the forest plot</span></span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">study =</span> <span class="fu" style="color: #4758AB;">fct_relevel</span>(study, <span class="st" style="color: #20794D;">"Average"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-14">  <span class="co" style="color: #5E5E5E;"># tidybayes garbles names so fix here</span></span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">study =</span> <span class="fu" style="color: #4758AB;">str_replace_all</span>(study, <span class="st" style="color: #20794D;">"</span><span class="sc" style="color: #5E5E5E;">\\</span><span class="st" style="color: #20794D;">."</span>, <span class="st" style="color: #20794D;">" "</span>))</span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;"># Data frame of summary numbers</span></span>
<span id="cb6-17">out_all_sum <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">group_by</span>(out_all, study) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-18">  <span class="fu" style="color: #4758AB;">mean_qi</span>(b_Intercept)</span>
<span id="cb6-19"><span class="co" style="color: #5E5E5E;"># Draw plot</span></span>
<span id="cb6-20">out_all <span class="sc" style="color: #5E5E5E;">%&gt;%</span>   </span>
<span id="cb6-21">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(b_Intercept, study)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-22">  <span class="co" style="color: #5E5E5E;"># Zero!</span></span>
<span id="cb6-23">  <span class="fu" style="color: #4758AB;">geom_vline</span>(<span class="at" style="color: #657422;">xintercept =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">25</span>, <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-24">  <span class="fu" style="color: #4758AB;">stat_halfeye</span>(<span class="at" style="color: #657422;">.width =</span> <span class="fu" style="color: #4758AB;">c</span>(.<span class="dv" style="color: #AD0000;">8</span>, .<span class="dv" style="color: #AD0000;">95</span>), <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"dodgerblue"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-25">  <span class="co" style="color: #5E5E5E;"># Add text labels</span></span>
<span id="cb6-26">  <span class="fu" style="color: #4758AB;">geom_text</span>(</span>
<span id="cb6-27">    <span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">mutate_if</span>(out_all_sum, is.numeric, round, <span class="dv" style="color: #AD0000;">2</span>),</span>
<span id="cb6-28">    <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">label =</span> <span class="fu" style="color: #4758AB;">str_glue</span>(<span class="st" style="color: #20794D;">"{b_Intercept} [{.lower}, {.upper}]"</span>), <span class="at" style="color: #657422;">x =</span> <span class="fl" style="color: #AD0000;">0.75</span>),</span>
<span id="cb6-29">    <span class="at" style="color: #657422;">hjust =</span> <span class="st" style="color: #20794D;">"inward"</span></span>
<span id="cb6-30">  ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-31">  <span class="co" style="color: #5E5E5E;"># Observed as empty points</span></span>
<span id="cb6-32">  <span class="fu" style="color: #4758AB;">geom_point</span>(</span>
<span id="cb6-33">    <span class="at" style="color: #657422;">data =</span> dat <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">study =</span> <span class="fu" style="color: #4758AB;">str_replace_all</span>(study, <span class="st" style="color: #20794D;">"</span><span class="sc" style="color: #5E5E5E;">\\</span><span class="st" style="color: #20794D;">."</span>, <span class="st" style="color: #20794D;">" "</span>)), </span>
<span id="cb6-34">    <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x=</span>yi), <span class="at" style="color: #657422;">position =</span> <span class="fu" style="color: #4758AB;">position_nudge</span>(<span class="at" style="color: #657422;">y =</span> <span class="sc" style="color: #5E5E5E;">-</span>.<span class="dv" style="color: #AD0000;">2</span>), <span class="at" style="color: #657422;">shape =</span> <span class="dv" style="color: #AD0000;">1</span> </span>
<span id="cb6-35">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis/index_files/figure-html/draw-forest-plot-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Forest plot of the example model‚Äôs results. Filled points and intervals are posterior means and 80/95% Credible Intervals. Empty points are observed effect sizes.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Focus on Moran et al.&nbsp;(1997)‚Äôs observed effect size (the empty circle): This is an anomalous result compared to all other studies. One might describe it as <em>incredible</em>, and that is indeed what the bayesian estimation procedure has done, and the resulting posterior distribution is no longer equivalent to the observed effect size. Instead, it is shrunken toward the average effect size. Now look at the table above, this study only had 56 participants, so we should be more skeptical of this study‚Äôs observed ES, and perhaps we should then adjust our beliefs about this study in the context of other studies. Therefore, our best guess about this study‚Äôs effect size, given all the other studies is no longer the observed mean, but something closer to the average across the studies.</p>
<p>If this shrinkage business seems radical, consider Quine et al.&nbsp;(2012). This study had a much greater sample size (537), and therefore a smaller SE. It was also generally more in line with the average effect size estimate. Therefore, the observed mean ES and the mean of the posterior distribution are pretty much identical. This is also a fairly desirable feature.</p>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>The way these different methods are presented (regression, meta-analysis, ANOVA, ‚Ä¶), it is quite easy for a beginner, like me, to lose sight of the forest for the trees. I also feel that this is a general experience for students of applied statistics: Every experiment, situation, and question results in a different statistical method (or worse: ‚ÄúWhich test should I use?‚Äù), and the student doesn‚Äôt see how the methods relate to each other. So I think focusing on the (regression) model is key, but often overlooked in favor of this sort of decision tree model of choosing statistical methods <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">(McElreath 2020)</span>.</p>
<p>Accordingly, I think we‚Äôve ended up in a situation where meta-analysis, for example, is seen as somehow separate from all the other modeling we do, such as repeated measures t-tests. In fact I think applied statistics in Psychology may too often appear as an unconnected bunch of tricks and models, leading to confusion and inefficient implementation of appropriate methods.</p>
<section id="bayesian-multilevel-modeling" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-multilevel-modeling">Bayesian multilevel modeling</h3>
<p>As I‚Äôve been learning more about statistics, I‚Äôve often noticed that some technique, applied in a specific set of situations, turns out to be a special case of a more general modeling approach. I‚Äôll call this approach here <em>Bayesian multilevel modeling</em> <span class="citation" data-cites="mcelreathStatisticalRethinkingBayesian2020">(McElreath 2020)</span>. If you are forced to choose one statistical method to learn, it should be Bayesian multilevel modeling, because it allows you to do and understand most things, and allows you to see how similar all these methods are, under the hood.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-mcelreathStatisticalRethinkingBayesian2020" class="csl-entry">
McElreath, Richard. 2020. <em>Statistical Rethinking: A <span>Bayesian</span> Course with Examples in <span>R</span> and <span>Stan</span></em>. Second. <span>CRC</span> Texts in Statistical Science. <span>Boca Raton</span>: <span>Taylor and Francis, CRC Press</span>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2016,
  author = {Matti Vuorre},
  title = {Bayesian {Meta-Analysis} with {R,} {Stan,} and Brms},
  date = {2016-09-29},
  url = {https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2016" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2016. <span>‚ÄúBayesian Meta-Analysis with R, Stan, and
Brms.‚Äù</span> September 29, 2016. <a href="https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis">https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>R</category>
  <category>brms</category>
  <category>tutorial</category>
  <guid>https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis/index.html</guid>
  <pubDate>Wed, 28 Sep 2016 23:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2016-09-29-bayesian-meta-analysis/index_files/figure-html/unnamed-chunk-2-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>GitHub-style waffle plots in R</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot/index.html</link>
  <description><![CDATA[ 




<p>In this post, I‚Äôll show how to create GitHub style ‚Äúwaffle‚Äù plot in <a href="https://cran.r-project.org/">R</a> with the <a href="http://had.co.nz/ggplot2/book">ggplot2</a> plotting package. We‚Äôll use these packages</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_452551d482c384dfdff76b9a6c31664b">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<section id="simulate-activity-data" class="level2">
<h2 class="anchored" data-anchor-id="simulate-activity-data">Simulate activity data</h2>
<p>First, I‚Äôll create a data frame for the simulated data, initializing the data types:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/gen_dataframe_bfdb6d241430e7debad4272af38d6405">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;">date =</span> <span class="fu" style="color: #4758AB;">as.Date</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">813</span>, <span class="at" style="color: #657422;">origin =</span> <span class="st" style="color: #20794D;">"2014-01-01"</span>),</span>
<span id="cb2-3">  <span class="at" style="color: #657422;">year =</span> <span class="fu" style="color: #4758AB;">format</span>(date, <span class="st" style="color: #20794D;">"%Y"</span>),</span>
<span id="cb2-4">  <span class="at" style="color: #657422;">week =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(<span class="fu" style="color: #4758AB;">format</span>(date, <span class="st" style="color: #20794D;">"%W"</span>)) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="co" style="color: #5E5E5E;"># Week starts at 1</span></span>
<span id="cb2-5">  <span class="at" style="color: #657422;">day =</span> <span class="fu" style="color: #4758AB;">factor</span>(<span class="fu" style="color: #4758AB;">weekdays</span>(date, T),</span>
<span id="cb2-6">    <span class="at" style="color: #657422;">levels =</span> <span class="fu" style="color: #4758AB;">rev</span>(<span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb2-7">      <span class="st" style="color: #20794D;">"Mon"</span>, <span class="st" style="color: #20794D;">"Tue"</span>, <span class="st" style="color: #20794D;">"Wed"</span>, <span class="st" style="color: #20794D;">"Thu"</span>,</span>
<span id="cb2-8">      <span class="st" style="color: #20794D;">"Fri"</span>, <span class="st" style="color: #20794D;">"Sat"</span>, <span class="st" style="color: #20794D;">"Sun"</span></span>
<span id="cb2-9">    ))</span>
<span id="cb2-10">  ),</span>
<span id="cb2-11">  <span class="at" style="color: #657422;">hours =</span> <span class="dv" style="color: #AD0000;">0</span></span>
<span id="cb2-12">)</span></code></pre></div>
</div>
<p>And then simulate hours worked for each date. I‚Äôll simulate hours worked separately for weekends and weekdays to make the resulting data a little more realistic, and also simulate missing values to data (that is, days when no work occurred).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_437e0fa30cf8862bebf8f26bdb6b133a">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;"># Simulate weekends</span></span>
<span id="cb3-3">weekends <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">filter</span>(d, <span class="fu" style="color: #4758AB;">grepl</span>(<span class="st" style="color: #20794D;">"S(at|un)"</span>, day))</span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;"># Hours worked are (might be) poisson distributed</span></span>
<span id="cb3-5">weekends<span class="sc" style="color: #5E5E5E;">$</span>hours <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rpois</span>(<span class="fu" style="color: #4758AB;">nrow</span>(weekends), <span class="at" style="color: #657422;">lambda =</span> <span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;"># Simulate missing days with probability .7</span></span>
<span id="cb3-7">weekends<span class="sc" style="color: #5E5E5E;">$</span>na <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rbinom</span>(<span class="fu" style="color: #4758AB;">nrow</span>(weekends), <span class="dv" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0.7</span>)</span>
<span id="cb3-8">weekends<span class="sc" style="color: #5E5E5E;">$</span>hours <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ifelse</span>(weekends<span class="sc" style="color: #5E5E5E;">$</span>na, <span class="cn" style="color: #8f5902;">NA</span>, weekends<span class="sc" style="color: #5E5E5E;">$</span>hours)</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;"># Simulate weekdays</span></span>
<span id="cb3-11">weekdays <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">filter</span>(d, <span class="sc" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;">grepl</span>(<span class="st" style="color: #20794D;">"S(at|un)"</span>, day))</span>
<span id="cb3-12">weekdays<span class="sc" style="color: #5E5E5E;">$</span>hours <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rpois</span>(<span class="fu" style="color: #4758AB;">nrow</span>(weekdays), <span class="at" style="color: #657422;">lambda =</span> <span class="dv" style="color: #AD0000;">8</span>) <span class="co" style="color: #5E5E5E;"># Greater lambda</span></span>
<span id="cb3-13">weekdays<span class="sc" style="color: #5E5E5E;">$</span>na <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rbinom</span>(<span class="fu" style="color: #4758AB;">nrow</span>(weekdays), <span class="dv" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">0.1</span>) <span class="co" style="color: #5E5E5E;"># Smaller p(missing)</span></span>
<span id="cb3-14">weekdays<span class="sc" style="color: #5E5E5E;">$</span>hours <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ifelse</span>(weekdays<span class="sc" style="color: #5E5E5E;">$</span>na, <span class="cn" style="color: #8f5902;">NA</span>, weekdays<span class="sc" style="color: #5E5E5E;">$</span>hours)</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;"># Concatenate weekends and weekdays and arrange by date</span></span>
<span id="cb3-17">d <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">bind_rows</span>(weekends, weekdays) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb3-18">  <span class="fu" style="color: #4758AB;">arrange</span>(date) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Arrange by date</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>na) <span class="co" style="color: #5E5E5E;"># Remove na column</span></span></code></pre></div>
</div>
</section>
<section id="waffle-plot-function" class="level2">
<h2 class="anchored" data-anchor-id="waffle-plot-function">Waffle-plot function</h2>
<p>Then I‚Äôll create a function that draws the waffle plot. If you have similarly structured data, you can copy-paste the function and use it on your data.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/viz_func_c3c56ab5a6098105a731ca89cb454830">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">gh_waffle <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(data, <span class="at" style="color: #657422;">pal =</span> <span class="st" style="color: #20794D;">"D"</span>, <span class="at" style="color: #657422;">dir =</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>) {</span>
<span id="cb4-2">  p <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggplot</span>(data, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> week, <span class="at" style="color: #657422;">y =</span> day, <span class="at" style="color: #657422;">fill =</span> hours)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-3">    <span class="fu" style="color: #4758AB;">scale_fill_viridis_c</span>(</span>
<span id="cb4-4">      <span class="at" style="color: #657422;">name =</span> <span class="st" style="color: #20794D;">"Hours"</span>,</span>
<span id="cb4-5">      <span class="at" style="color: #657422;">option =</span> pal, <span class="co" style="color: #5E5E5E;"># Variable color palette</span></span>
<span id="cb4-6">      <span class="at" style="color: #657422;">direction =</span> dir, <span class="co" style="color: #5E5E5E;"># Variable color direction</span></span>
<span id="cb4-7">      <span class="at" style="color: #657422;">na.value =</span> <span class="st" style="color: #20794D;">"grey90"</span>,</span>
<span id="cb4-8">      <span class="at" style="color: #657422;">limits =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fu" style="color: #4758AB;">max</span>(data<span class="sc" style="color: #5E5E5E;">$</span>hours))</span>
<span id="cb4-9">    ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-10">    <span class="fu" style="color: #4758AB;">geom_tile</span>(<span class="at" style="color: #657422;">color =</span> <span class="st" style="color: #20794D;">"white"</span>, <span class="at" style="color: #657422;">size =</span> <span class="fl" style="color: #AD0000;">0.7</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-11">    <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"year"</span>, <span class="at" style="color: #657422;">ncol =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-12">    <span class="fu" style="color: #4758AB;">scale_x_continuous</span>(</span>
<span id="cb4-13">      <span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">0</span>),</span>
<span id="cb4-14">      <span class="at" style="color: #657422;">breaks =</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="dv" style="color: #AD0000;">52</span>, <span class="at" style="color: #657422;">length =</span> <span class="dv" style="color: #AD0000;">12</span>),</span>
<span id="cb4-15">      <span class="at" style="color: #657422;">labels =</span> <span class="fu" style="color: #4758AB;">c</span>(</span>
<span id="cb4-16">        <span class="st" style="color: #20794D;">"Jan"</span>, <span class="st" style="color: #20794D;">"Feb"</span>, <span class="st" style="color: #20794D;">"Mar"</span>, <span class="st" style="color: #20794D;">"Apr"</span>, <span class="st" style="color: #20794D;">"May"</span>, <span class="st" style="color: #20794D;">"Jun"</span>,</span>
<span id="cb4-17">        <span class="st" style="color: #20794D;">"Jul"</span>, <span class="st" style="color: #20794D;">"Aug"</span>, <span class="st" style="color: #20794D;">"Sep"</span>, <span class="st" style="color: #20794D;">"Oct"</span>, <span class="st" style="color: #20794D;">"Nov"</span>, <span class="st" style="color: #20794D;">"Dec"</span></span>
<span id="cb4-18">      )</span>
<span id="cb4-19">    ) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-20">    <span class="fu" style="color: #4758AB;">theme_linedraw</span>(<span class="at" style="color: #657422;">base_family =</span> <span class="st" style="color: #20794D;">"Helvetica"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb4-21">    <span class="fu" style="color: #4758AB;">theme</span>(</span>
<span id="cb4-22">      <span class="at" style="color: #657422;">axis.title =</span> <span class="fu" style="color: #4758AB;">element_blank</span>(),</span>
<span id="cb4-23">      <span class="at" style="color: #657422;">axis.ticks =</span> <span class="fu" style="color: #4758AB;">element_blank</span>(), </span>
<span id="cb4-24">      <span class="at" style="color: #657422;">axis.text.y =</span> <span class="fu" style="color: #4758AB;">element_text</span>(<span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">7</span>),</span>
<span id="cb4-25">      <span class="at" style="color: #657422;">panel.grid =</span> <span class="fu" style="color: #4758AB;">element_blank</span>(),</span>
<span id="cb4-26">      <span class="at" style="color: #657422;">legend.position =</span> <span class="st" style="color: #20794D;">"bottom"</span>,</span>
<span id="cb4-27">      <span class="at" style="color: #657422;">aspect.ratio =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">/</span><span class="dv" style="color: #AD0000;">7</span>,</span>
<span id="cb4-28">      <span class="at" style="color: #657422;">legend.key.width =</span> <span class="fu" style="color: #4758AB;">unit</span>(<span class="dv" style="color: #AD0000;">1</span>, <span class="st" style="color: #20794D;">"cm"</span>),</span>
<span id="cb4-29">      <span class="at" style="color: #657422;">strip.text =</span> <span class="fu" style="color: #4758AB;">element_text</span>(<span class="at" style="color: #657422;">hjust =</span> <span class="fl" style="color: #AD0000;">0.00</span>, <span class="at" style="color: #657422;">face =</span> <span class="st" style="color: #20794D;">"bold"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">12</span>)</span>
<span id="cb4-30">    )</span>
<span id="cb4-31"></span>
<span id="cb4-32">  <span class="fu" style="color: #4758AB;">print</span>(p)</span>
<span id="cb4-33">}</span></code></pre></div>
</div>
<section id="using-the-waffle-plot-function" class="level3">
<h3 class="anchored" data-anchor-id="using-the-waffle-plot-function">Using the waffle plot function</h3>
<p><code>gh_waffle()</code> takes three arguments, the first, <code>data</code> is a data frame with columns <code>date</code> (type: Date), <code>year</code> (number or character), <code>week</code> (number), <code>day</code> (an ordered factor to make days run from top to bottom on the graph), and <code>hours</code> (number). The second option to <code>gh_waffle()</code>, <code>pal</code> specifies one of four color palettes used by the <code>viridis</code> color scale, and can be <code>"A"</code>, <code>"B"</code>, <code>"C"</code>, or <code>"D"</code>. The default is ‚ÄúD‚Äù, which is also what GitHub uses (or something similar at least). The last option, <code>dir</code> specifies the direction of the color scale, and can be either <code>-1</code> or <code>1</code>. The GitHub default is -1.</p>
<p>Using <code>gh_waffle()</code> with the default settings, only providing the data frame <code>d</code>, gives the following result:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/viz_59bce1585f450aed6c952d85aebe89ba">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">gh_waffle</span>(d)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot/index_files/figure-html/viz-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<ul>
<li><a href="http://rud.is/b/2016/02/14/making-faceted-heatmaps-with-ggplot2/">Faceted heatmaps with ggplot2</a> (Inspiration for this post.)</li>
<li><a href="https://CRAN.R-project.org/package=dplyr">dplyr</a></li>
<li><a href="http://had.co.nz/ggplot2/book">ggplot2</a></li>
<li><a href="https://github.com/sjmgarnier/viridis">viridis</a></li>
<li><a href="https://github.com/jrnold/ggthemes">ggthemes</a></li>
</ul>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2016,
  author = {Matti Vuorre},
  title = {GitHub-Style Waffle Plots in {R}},
  date = {2016-03-24},
  url = {https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2016" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2016. <span>‚ÄúGitHub-Style Waffle Plots in R.‚Äù</span> March
24, 2016. <a href="https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot">https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>visualization</category>
  <category>data science</category>
  <category>tutorial</category>
  <guid>https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot/index.html</guid>
  <pubDate>Thu, 24 Mar 2016 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2016-03-24-github-waffle-plot/index_files/figure-html/viz-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>How to create plots with subplots in R</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index.html</link>
  <description><![CDATA[ 




<p>Visualizations are great for learning from data and communicating the results of a statistical investigation. In this post, I illustrate how to create <a href="https://en.wikipedia.org/wiki/Small_multiple"><strong>small multiples</strong></a> from data using <strong>R</strong> and <strong>ggplot2</strong>.</p>
<p>Small multiples display the same basic plot for many different groups simultaneously. For example, a data set might consist of a X ~ Y correlation measured simultaneously in many countries; small multiples display each country‚Äôs correlation in its own panel. Similarly, you might have conducted a within-individuals experiment, and would like to display the effects of the repeated-measures factors simultaneously at the average level, and at the individual level‚Äîthus showing each individual‚Äôs results in a separate panel. Whenever you would like to show the same figure, but separately for many subsets of the data, the appropriate google term is <a href="http://lmgtfy.com/?q=small+multiples">‚Äúsmall multiples‚Äù</a>.</p>
<p>We‚Äôll use the following R packages:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_b1831f9f2003a74f49738ff6c72abb36">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(scales)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(psych)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example Data</h2>
<p>The data I‚Äôll use here consist of responses to the Big 5 personality questionnaire from various demographic groups, and is from the psych R package. I‚Äôve computed a mean for each subscale:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/readdata_847cf9e55720c2dee98f92f04dd7d330">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as_tibble</span>(bfi)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example data (from psych package)</caption>
<colgroup>
<col style="width: 7%">
<col style="width: 17%">
<col style="width: 4%">
<col style="width: 13%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">gender</th>
<th style="text-align: left;">education</th>
<th style="text-align: right;">age</th>
<th style="text-align: right;">Extraversion</th>
<th style="text-align: right;">Openness</th>
<th style="text-align: right;">Agreeableness</th>
<th style="text-align: right;">Neuroticism</th>
<th style="text-align: right;">Conscientiousness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">3.8</td>
<td style="text-align: right;">5.6</td>
<td style="text-align: right;">3.0</td>
<td style="text-align: right;">4.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">HS</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">3.20</td>
<td style="text-align: right;">3.4</td>
<td style="text-align: right;">2.8</td>
<td style="text-align: right;">4.2</td>
<td style="text-align: right;">3.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">some HS</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">3.75</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">3.8</td>
<td style="text-align: right;">3.6</td>
<td style="text-align: right;">4.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">some HS</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">4.4</td>
<td style="text-align: right;">4.8</td>
<td style="text-align: right;">3.0</td>
<td style="text-align: right;">3.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">some HS</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">4.20</td>
<td style="text-align: right;">4.4</td>
<td style="text-align: right;">2.8</td>
<td style="text-align: right;">2.6</td>
<td style="text-align: right;">3.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">graduate degree</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">2.40</td>
<td style="text-align: right;">3.8</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">3.6</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="univariate-plots" class="level2">
<h2 class="anchored" data-anchor-id="univariate-plots">Univariate plots</h2>
<p>I‚Äôll start with displaying histograms of the outcome variables (the individual-specific Big 5 category means). Picking up a variable to plot in <strong>ggplot2</strong> is done by specifying the column to plot, so to select a specific Big 5 category, I just tell <strong>ggplot2</strong> to plot it on the x axis.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/first_plot_8a1e58b3dc8136a92d89b3112fdb96df">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">ggplot</span>(dat, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> Openness)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">geom_histogram</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-3">  <span class="co" style="color: #5E5E5E;"># Fix bars to y=0</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.05</span>)))</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/first_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="long-format-data" class="level2">
<h2 class="anchored" data-anchor-id="long-format-data">Long format data</h2>
<p>Next, we‚Äôll be drawing the same figure, but display all Big 5 categories using small multiples. ggplot2 calls small multiples ‚Äúfacets‚Äù, and the operation is conceptually to subset the input data frame by values found in one of the data frame‚Äôs columns.</p>
<p>The key to using facets in ggplot2 is to make sure that the data is in long format; I would like to display histograms of each category in separate facets, so I‚Äôll need to reshape the data from wide (each category in its own column) to long form (a column with category labels, and another with the value).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_04666cd1173c15d691a1e37d503c859f">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">dat_long <span class="ot" style="color: #003B4F;">&lt;-</span> dat <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;">pivot_longer</span>(Extraversion<span class="sc" style="color: #5E5E5E;">:</span>Conscientiousness, <span class="at" style="color: #657422;">names_to =</span> <span class="st" style="color: #20794D;">"Scale"</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>Example data in long format.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">gender</th>
<th style="text-align: left;">education</th>
<th style="text-align: right;">age</th>
<th style="text-align: left;">Scale</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Extraversion</td>
<td style="text-align: right;">4.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Openness</td>
<td style="text-align: right;">3.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Agreeableness</td>
<td style="text-align: right;">5.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Neuroticism</td>
<td style="text-align: right;">3.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">some college</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Conscientiousness</td>
<td style="text-align: right;">4.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">HS</td>
<td style="text-align: right;">19</td>
<td style="text-align: left;">Extraversion</td>
<td style="text-align: right;">3.2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The values for each Big 5 categories are now in the same column, called <code>value</code>. Each observation, or row in the data, contains all variables associated with that observation. This is the essence of long form data. We can now use the <code>Scale</code> variable to subset the data to subplots for each category.</p>
</section>
<section id="basic-facets" class="level2">
<h2 class="anchored" data-anchor-id="basic-facets">Basic facets</h2>
<section id="display-all-scales-in-small-multiples" class="level3">
<h3 class="anchored" data-anchor-id="display-all-scales-in-small-multiples">Display all scales in small multiples</h3>
<p>Now that <code>value</code> holds all mean Big 5 category values, asking <code>ggplot()</code> to plot it on the x-axis is not too meaningful. However, because we have another column identifying each observations‚Äô (row) category, we can pass it to <code>facet_wrap()</code> to split the histograms by category. Making use of the long data form with facets is easy:</p>
<div class="cell" data-layout-align="center" data-preview="true" data-hash="index_cache/html/unnamed-chunk-2_6f514a4c50f750f46189ec4337bb1a2e">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">ggplot</span>(dat_long, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> value)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;">geom_histogram</span>(<span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"grey20"</span>, <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"white"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"Scale"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.05</span>)))</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Perfect! The same works for any arbitrary variable that we can think of as a meaningful grouping factor.</p>
</section>
<section id="display-different-education-levels-openness-in-small-multiples" class="level3">
<h3 class="anchored" data-anchor-id="display-different-education-levels-openness-in-small-multiples">Display different education levels‚Äô openness in small multiples</h3>
<p>Because the <code>value</code> column contains values of all scales, I need to specify which scale to display by subsetting the data. I use data wrangling verbs from the <strong>dplyr</strong> package to subset the data on the fly, and pass the resulting objects to further functions using the pipe operator <code>%&gt;%</code>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_66242d2e2e0a7ff6a7cd13a9c5e63a53">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;"># Filter out all rows where category is "openness", and pass forward</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;">filter</span>(dat_long, Scale <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Openness"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-3">  <span class="co" style="color: #5E5E5E;"># Place value on x-axis</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> value)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.05</span>))) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-6">  <span class="co" style="color: #5E5E5E;"># Histogram</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;">geom_histogram</span>(<span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"grey20"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb6-8">  <span class="co" style="color: #5E5E5E;"># Facet</span></span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"education"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That didn‚Äôt quite work, because in an observational study such as this one, the design is far from balanced; each education category has a different number of observations and thus the y-axis scales are different.</p>
</section>
<section id="adjusting-facet-scales" class="level3">
<h3 class="anchored" data-anchor-id="adjusting-facet-scales">Adjusting facet scales</h3>
<p>I can ask <code>facet_wrap()</code> to use different axis scales for each subplot. Note also that we can access the last plot using a shortcut:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_e81597c68503b34ca272fd9d48ab323a">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;">last_plot</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"education"</span>, <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free_y"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Brilliant.</p>
</section>
</section>
<section id="grid-of-facets" class="level2">
<h2 class="anchored" data-anchor-id="grid-of-facets">Grid of facets</h2>
<p>We repeatedly called <code>facet_wrap("variable")</code> to separate the plot to several facets, based on <code>variable</code>. However, we‚Äôre not restricted to one facetting variable, and can enter multiple variables simultaneously. To illustrate, I‚Äôll plot all categories separately for each gender, using <code>facet_grid()</code></p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_977f9e29453c0b9e6bde1b14b6d31af2">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;">last_plot</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;">facet_grid</span>(gender <span class="sc" style="color: #5E5E5E;">~</span> education, <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free_y"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The argument to the left of the tilde in <code>facet_grid()</code> specifies the rows (here <code>gender</code>), the one after the tilde specifies the columns.</p>
</section>
<section id="ordering-facets" class="level2">
<h2 class="anchored" data-anchor-id="ordering-facets">Ordering facets</h2>
<p>Sometimes it is helpful to convey information through structure. One way to do this with subplots is to arrange the subplots in a meaningful manner, such as a data summary, or even a summary statistic. Ordering subplots allows the observer to quickly learn more from the figure, even though it still presents the same information, only differently arranged.</p>
<section id="order-facets-by-number-of-observations" class="level3">
<h3 class="anchored" data-anchor-id="order-facets-by-number-of-observations">Order facets by number of observations</h3>
<p>To order subplots, we need to add the variable that we would like to order by to the data frame. Here we add a ‚Äúnumber of observations‚Äù column to the data frame, then order the facetting variable on that variable. The following code snippet takes all openness-rows, calculates the number of observations for each education level, and reorders the education factor based on the number. The result is visible in a figure where the number of observations in each facet increases from top left to bottom right.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_e655a74415b6397ba5421b5df9d5605c">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">dat_long <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;">filter</span>(Scale <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"Openness"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;">add_count</span>(education) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">education =</span> <span class="fu" style="color: #4758AB;">reorder</span>(education, n)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># The important bit</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> value)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;">scale_y_continuous</span>(<span class="at" style="color: #657422;">expand =</span> <span class="fu" style="color: #4758AB;">expansion</span>(<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="fl" style="color: #AD0000;">0.05</span>))) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;">geom_histogram</span>(<span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"grey20"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="st" style="color: #20794D;">"education"</span>, <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free_y"</span>, <span class="at" style="color: #657422;">nrow =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2016,
  author = {Matti Vuorre},
  title = {How to Create Plots with Subplots in {R}},
  date = {2016-03-15},
  url = {https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2016" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2016. <span>‚ÄúHow to Create Plots with Subplots in
R.‚Äù</span> March 15, 2016. <a href="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots">https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots</a>.
</div></div></section></div> ]]></description>
  <category>data science</category>
  <category>R</category>
  <category>visualization</category>
  <category>tutorial</category>
  <guid>https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index.html</guid>
  <pubDate>Tue, 15 Mar 2016 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2016-03-15-ggplot-plots-subplots/index_files/figure-html/unnamed-chunk-4-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Confidence intervals in multilevel models</title>
  <dc:creator>Matti Vuorre</dc:creator>
  <link>https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index.html</link>
  <description><![CDATA[ 




<p>In this post, I address the following problem: How to obtain regression lines and their associated confidence intervals at the average and individual-specific levels, in a two-level multilevel linear regression.</p>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Visualization is perhaps the most effective way of communicating the results of a statistical model. For regression models, two figures are commonly used: The coefficient plot shows the coefficients of a model graphically, and can be used to replace or augment a model summary table. The advantage over tables is that it is usually faster to understand the estimated parameters by looking at them in graphical form, but the downside is losing the numerical accuracy of the table. However, both of these model summaries become increasingly difficult to interpret as the number of coefficients increases, and especially when interaction terms are included.</p>
<p>An alternative visualization is the line plot, which shows what the model implies in terms of the data, such as the relationship between X and Y, and perhaps how that relationship is moderated by other variables. For a linear regression, this plot displays the regression line and its confidence interval. If a confidence interval is not shown, the plot is not complete because the viewer can‚Äôt visually assess the uncertainty in the regression line, and therefore a simple line without a confidence interval is of little inferential value. Obtaining the line and confidence interval for simple linear regression is very easy, but is not straightforward in a multilevel context, the topic of this post.</p>
<p>Most of my statistical analyses utilize multilevel modeling, where parameters (means, slopes) are treated as varying between individuals. Because common procedures for estimating these models return point estimates for the regression coefficients at all levels, drawing expected regression lines is easy. However, displaying the confidence limits for the regression lines is not as easily done. Various options exist, and some software packages provide these limits automatically, but in this post I want to highlight a completely general approach to obtaining and drawing confidence limits for regression lines at multiple levels of analysis, and where applicable, show how various packages deliver them automatically. This general approach is inference based on probability, or bayesian statistics. In practice, obtaining random samples from the posterior distribution makes it easy to compute values such as confidence limits for any quantity of interest. Importantly, we can summarize the samples with an interval at each level of the predictor values, yielding the confidence interval for the regression line.</p>
<p>I will illustrate the procedure first with a maximum likelihood model fitting procedure, using the lme4 package. This procedure requires an additional step where plausible parameter values are simulated from the estimated model, using the arm package. Then, I‚Äôll show how to obtain the limits from models estimated with Bayesian methods, using the brms R package.</p>
<p>We‚Äôll use the following R packages:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/packages_fabda9916eb57c579547e866e603c024">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;">library</span>(lme4)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;">library</span>(here)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;">library</span>(arm)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;">library</span>(broom.mixed)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;">library</span>(kableExtra)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;">library</span>(patchwork)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;">library</span>(brms)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
</div>
</section>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example Data</h2>
<p>I will use the <code>sleepstudy</code> data set from the <code>lme4</code> package as an example:</p>
<blockquote class="blockquote">
<p>‚ÄúThe average reaction time per day for subjects in a sleep deprivation study. On day 0 the subjects had their normal amount of sleep. Starting that night they were restricted to 3 hours of sleep per night. The observations represent the average reaction time on a series of tests given each day to each subject.‚Äù</p>
</blockquote>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/exdata_4ac3e4078eecfe60c01d65f62b357aac">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">sleepstudy <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as_tibble</span>(sleepstudy)</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Example data</caption>
 <thead>
  <tr>
   <th style="text-align:right;"> Reaction </th>
   <th style="text-align:right;"> Days </th>
   <th style="text-align:left;"> Subject </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 249.56 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 258.70 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 250.80 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 321.44 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 356.85 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 414.69 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> 308 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The data is structured in a long format, where each row contains all variables at a single measurement instance.</p>
</section>
<section id="fixed-effects-models-and-cis" class="level2">
<h2 class="anchored" data-anchor-id="fixed-effects-models-and-cis">Fixed Effects Models and CIs</h2>
<p>Below, I show two kinds of scatterplots from the data. The left one represents a fixed effects regression, where information about individuals is discarded, and all that is left is a lonely band of inference in a sea of scattered observations. The right panel shows fixed effects regressions separately for each individual.</p>
<div class="cell" data-layout-align="center" data-preview="true" data-hash="index_cache/html/fig1and2_56d6fbe2e508b6ebfd368d1c8ce937ce">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">p1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggplot</span>(sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> Days, <span class="at" style="color: #657422;">y =</span> Reaction)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="at" style="color: #657422;">shape =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;">scale_x_continuous</span>(<span class="at" style="color: #657422;">breaks =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">0</span>, <span class="dv" style="color: #AD0000;">3</span>, <span class="dv" style="color: #AD0000;">6</span>, <span class="dv" style="color: #AD0000;">9</span>)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;">geom_smooth</span>(<span class="at" style="color: #657422;">method =</span> <span class="st" style="color: #20794D;">"lm"</span>, <span class="at" style="color: #657422;">fill =</span> <span class="st" style="color: #20794D;">"dodgerblue"</span>, <span class="at" style="color: #657422;">level =</span> .<span class="dv" style="color: #AD0000;">95</span>)</span>
<span id="cb3-5">p2 <span class="ot" style="color: #003B4F;">&lt;-</span> p1 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;">~</span>Subject, <span class="at" style="color: #657422;">nrow =</span> <span class="dv" style="color: #AD0000;">4</span>)</span>
<span id="cb3-6">p1 <span class="sc" style="color: #5E5E5E;">|</span> p2</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/fig1and2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Scatterplots with a completely pooled model (left), and individual specific models (right).</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Obtaining confidence intervals for regression lines using ggplot2 is easy (<code>geom_smooth()</code> gives them by default), but an alternative way is to explicitly use the <code>predict()</code> function (which ggplot2 uses under the hood). For more complicated or esoteric models, explicit prediction becomes necessary, either using <code>predict()</code> or custom code.</p>
</section>
<section id="multilevel-model" class="level2">
<h2 class="anchored" data-anchor-id="multilevel-model">Multilevel model</h2>
<p>The multilevel model I‚Äôll fit to these data treats the intercept and effect of days as varying between individuals</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathsf%7Breaction%7D_%7Bij%7D%20%5Csim%20%5Cmathcal%7BN%7D(%5Cmu_%7Bij%7D,%20%5Csigma)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmu_%7Bij%7D%20=%20%5Cbeta_%7B0j%7D%20+%20%5Cbeta_%7B1j%7D%20%5C%20%20%5Cmathsf%7Bdays%7D_%7Bij%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bpmatrix%7D%7B%5Cbeta_%7B0j%7D%7D%5C%5C%7B%5Cbeta_%7B1j%7D%7D%5Cend%7Bpmatrix%7D%20%5Csim%0A%5Cmathcal%7BN%7D%20%5Cbegin%7Bpmatrix%7D%7B%5Cgamma_%7B00%7D%7D,%5C%20%7B%5Ctau_%7B00%7D%7D%5C%20%7B%5Crho_%7B01%7D%7D%5C%5C%0A%7B%5Cgamma_%7B10%7D%7D,%5C%20%7B%5Crho_%7B01%7D%7D%5C%20%7B%5Ctau_%7B10%7D%7D%20%5Cend%7Bpmatrix%7D"></p>
<p>In this post, and the above equations, I‚Äôll omit the discussion of hyperpriors (priors on <img src="https://latex.codecogs.com/png.latex?%5Cgamma">, <img src="https://latex.codecogs.com/png.latex?%5Ctau"> and <img src="https://latex.codecogs.com/png.latex?%5Crho"> parameters.)</p>
<p>If the above equations baffle the mind, or multilevel models are mysterious to you, <span class="citation" data-cites="bolgerIntensiveLongitudinalMethods2013">Bolger and Laurenceau (2013)</span> and <span class="citation" data-cites="gelmanDataAnalysisUsing2007">Gelman and Hill (2007)</span> are great introductions to the topic.</p>
</section>
<section id="maximum-likelihood-estimation" class="level2">
<h2 class="anchored" data-anchor-id="maximum-likelihood-estimation">Maximum likelihood estimation</h2>
<p>I‚Äôll estimate the multilevel model using the lme4 package.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fitlmer_2b785618fc12cf8cdda49c8e3fec4e58">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">lmerfit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lmer</span>(Reaction <span class="sc" style="color: #5E5E5E;">~</span> Days <span class="sc" style="color: #5E5E5E;">+</span> (Days <span class="sc" style="color: #5E5E5E;">|</span> Subject), <span class="at" style="color: #657422;">data =</span> sleepstudy)</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Multilevel model summary</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> effect </th>
   <th style="text-align:left;"> term </th>
   <th style="text-align:right;"> estimate </th>
   <th style="text-align:right;"> statistic </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> fixed </td>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:right;"> 251.41 </td>
   <td style="text-align:right;"> 36.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> fixed </td>
   <td style="text-align:left;"> Days </td>
   <td style="text-align:right;"> 10.47 </td>
   <td style="text-align:right;"> 6.77 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The key points here are the estimates and their associated standard errors, the latter of which are missing for the varying effects‚Äô correlations and standard deviations.</p>
<section id="working-with-point-estimates" class="level3">
<h3 class="anchored" data-anchor-id="working-with-point-estimates">Working with point estimates</h3>
<p>Using the model output, we can generate regression lines using the <code>predict()</code> function. Using this method, we can simply add a new column to the existing <code>sleepstudy</code> data frame, giving the fitted value for each row in the data. However, for visualization, it is very useful to generate the fitted values for specific combinations of predictor values, instead of generating a fitted value for every observation. To do this, I simply create dataframes with the relevant predictors, and feed these data frames as data to <code>predict()</code>.</p>
<p>To get fitted values at the average level, when there is only one predictor, the data frame is simply a column with rows for each level of <code>Days</code>. For the varying effects, I create a data frame where each individual has all levels of <code>Days</code>, using the <code>expand.grid()</code> function.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/pred_lmer_8da706581dfa545b79ad6d470769cc6e">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;"># Data frame to evaluate average effects predictions on</span></span>
<span id="cb5-2">newavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">Days =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>)</span>
<span id="cb5-3">newavg<span class="sc" style="color: #5E5E5E;">$</span>Reaction <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">predict</span>(lmerfit, <span class="at" style="color: #657422;">re.form =</span> <span class="cn" style="color: #8f5902;">NA</span>, newavg)</span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;"># Predictors for the varying effect's predictions</span></span>
<span id="cb5-5">newvary <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">expand.grid</span>(<span class="at" style="color: #657422;">Days =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>, <span class="at" style="color: #657422;">Subject =</span> <span class="fu" style="color: #4758AB;">unique</span>(sleepstudy<span class="sc" style="color: #5E5E5E;">$</span>Subject))</span>
<span id="cb5-6">newvary<span class="sc" style="color: #5E5E5E;">$</span>Reaction <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">predict</span>(lmerfit, newvary)</span></code></pre></div>
</div>
<p>I‚Äôll show these predictions within the previous figures: On the left, a single fixed effects model versus the average regression line from the new multilevel model, and on the right the separate fixed effects models versus the varying regression lines from the multilevel model. Below, I use blue colors to indicate the fixed effects models‚Äô predictions, and black for the multilevel model‚Äôs predictions.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plotlmer_85b7c90bd39cb953a81173759eeb874f">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">p1 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> newavg, <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">|</span></span>
<span id="cb6-2">  p2 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> newvary, <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plotlmer-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As you can probably tell, the fixed effects regression line (blue), and the multilevel model‚Äôs average regression line (black; left panel) are identical, because of the completely balanced design. However, interesting differences are apparent in the right panel: The varying effects‚Äô regression lines are different from the separate fixed effects models‚Äô regression lines. How? They are ‚Äúshrunk‚Äù toward the average-level estimate. Focus on subject 335, an individual whose reaction times got faster with increased sleep deprivation:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plotlmerid9_1d4c8fb4df70af98247367e04bc39647">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">p2 <span class="sc" style="color: #5E5E5E;">%+%</span> <span class="fu" style="color: #4758AB;">filter</span>(sleepstudy, Subject <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">335</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> <span class="fu" style="color: #4758AB;">filter</span>(newvary, Subject <span class="sc" style="color: #5E5E5E;">==</span> <span class="dv" style="color: #AD0000;">335</span>), <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plotlmerid9-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Estimating each participant‚Äôs data in their very own model (separate fixed effects models) resulted in a predicted line suggesting to us that this person‚Äôs cognitive performance is enhanced following sleep deprivation (blue line with negative slope).</p>
<p>However, if we used a model where this individual was treated as a random draw from a population of individuals (the multilevel model; black line in the above figure), the story is different. The point estimate for the slope parameter, for this specific individual, from this model (-0.28) tells us that the estimated decrease in reaction times is quite a bit smaller. But this is just a point estimate, and in order to draw inference, we‚Äôll need standard errors, or some representation of the uncertainty, in the estimated parameters. The appropriate uncertainty representations will also allow us to draw the black lines with their associated confidence intervals. I‚Äôll begin by obtaining a confidence interval for the average regression line.</p>
</section>
<section id="cis-using-arm-average-level" class="level3">
<h3 class="anchored" data-anchor-id="cis-using-arm-average-level">CIs using arm: Average level</h3>
<p>The method I will illustrate in this post relies on random samples of plausible parameter values, from which we can then generate regression lines‚Äìor draw inferences about the parameters themselves. These regression lines can then be used as their own distribution with their own respective summaries, such as an X% interval. First, I‚Äôll show a quick way for obtaining these samples for the lme4 model, using the arm package to generate simulated parameter values.</p>
<p>The important parts of this code are:</p>
<ol type="1">
<li>Simulating plausible parameter values</li>
<li>Saving the simulated samples (a faux posterior distribution) in a data frame</li>
<li>Creating a predictor matrix</li>
<li>Creating a matrix for the fitted values</li>
<li>Calculating fitted values for each combination of the predictor values, for each plausible combination of the parameter values</li>
<li>Calculating the desired quantiles of the fitted values</li>
</ol>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/sim_lmer_0798af5b7cdbb03f041114941331f993">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">sims <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">sim</span>(lmerfit, <span class="at" style="color: #657422;">n.sims =</span> <span class="dv" style="color: #AD0000;">1000</span>) <span class="co" style="color: #5E5E5E;"># 1</span></span>
<span id="cb8-2">fs <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">fixef</span>(sims) <span class="co" style="color: #5E5E5E;"># 2</span></span>
<span id="cb8-3">newavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">Days =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>)</span>
<span id="cb8-4">Xmat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">model.matrix</span>(<span class="sc" style="color: #5E5E5E;">~</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">+</span> Days, <span class="at" style="color: #657422;">data =</span> newavg) <span class="co" style="color: #5E5E5E;"># 3</span></span>
<span id="cb8-5">fitmat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">matrix</span>(<span class="at" style="color: #657422;">ncol =</span> <span class="fu" style="color: #4758AB;">nrow</span>(fs), <span class="at" style="color: #657422;">nrow =</span> <span class="fu" style="color: #4758AB;">nrow</span>(newavg)) <span class="co" style="color: #5E5E5E;"># 4</span></span>
<span id="cb8-6"><span class="cf" style="color: #003B4F;">for</span> (i <span class="cf" style="color: #003B4F;">in</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="fu" style="color: #4758AB;">nrow</span>(fs)) {</span>
<span id="cb8-7">  fitmat[, i] <span class="ot" style="color: #003B4F;">&lt;-</span> Xmat <span class="sc" style="color: #5E5E5E;">%*%</span> <span class="fu" style="color: #4758AB;">as.matrix</span>(fs)[i, ]</span>
<span id="cb8-8">} <span class="co" style="color: #5E5E5E;"># 5</span></span>
<span id="cb8-9">newavg<span class="sc" style="color: #5E5E5E;">$</span>lower <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(fitmat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.05</span>) <span class="co" style="color: #5E5E5E;"># 6</span></span>
<span id="cb8-10">newavg<span class="sc" style="color: #5E5E5E;">$</span>median <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(fitmat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.5</span>) <span class="co" style="color: #5E5E5E;"># 6</span></span>
<span id="cb8-11">newavg<span class="sc" style="color: #5E5E5E;">$</span>upper <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(fitmat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.95</span>) <span class="co" style="color: #5E5E5E;"># 6</span></span>
<span id="cb8-12">p1 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> newavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> median), <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> newavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> lower), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> newavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> upper), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/sim_lmer-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Again, the multilevel model‚Äôs average regression line and the fixed effect model‚Äôs regression line are identical, but the former has a wider confidence interval (black dashed lines.)</p>
<p>The code snippet generalizes well to be used with any two matrices where one contains predictor values (the combinations of predictor values on which you want to predict) and the other samples of parameter values, such as a posterior distribution from a Bayesian model, as we‚Äôll see below. This procedure is described in <span class="citation" data-cites="korner-nievergeltBayesianDataAnalysis2015">Korner-Nievergelt et al. (2015)</span>, who give a detailed explanation of the code and on drawing inference from the results.</p>
</section>
<section id="cis-using-arm-individual-level" class="level3">
<h3 class="anchored" data-anchor-id="cis-using-arm-individual-level">CIs using arm: Individual level</h3>
<p>The <code>fitted()</code> function in arm returns fitted values at the varying effects level automatically, so we can skip a few lines of code from above to obtain confidence intervals at the individual-level:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plot_lmer_vary_c47d0020b85ec8172db56c531485a5a2">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">yhat <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">fitted</span>(sims, lmerfit)</span>
<span id="cb9-2">sleepstudy<span class="sc" style="color: #5E5E5E;">$</span>lower <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(yhat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.025</span>)</span>
<span id="cb9-3">sleepstudy<span class="sc" style="color: #5E5E5E;">$</span>median <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(yhat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.5</span>)</span>
<span id="cb9-4">sleepstudy<span class="sc" style="color: #5E5E5E;">$</span>upper <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">apply</span>(yhat, <span class="dv" style="color: #AD0000;">1</span>, quantile, <span class="at" style="color: #657422;">prob =</span> <span class="fl" style="color: #AD0000;">0.975</span>)</span>
<span id="cb9-5">p2 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> median), <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> lower), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> upper), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plot_lmer_vary-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A subset of individuals highlights the most interesting differences between the models:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plot_lmer_vary_id9_3236d149fa262c4f31664b8d2e135b23">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">tmp <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">filter</span>(sleepstudy, Subject <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="fu" style="color: #4758AB;">unique</span>(sleepstudy<span class="sc" style="color: #5E5E5E;">$</span>Subject)[<span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">6</span>, <span class="dv" style="color: #AD0000;">9</span>)])</span>
<span id="cb10-2">p2 <span class="sc" style="color: #5E5E5E;">%+%</span> tmp <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> tmp, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> median), <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> tmp, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> lower), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> tmp, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> upper), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plot_lmer_vary_id9-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>In the top panel, the unique fixed effects model‚Äôs confidence band is much wider than the confidence band from the multilevel model, highlighting the pooling of information in the latter model. Similarly, the bottom panel (individual 9 discussed above) shows that 95% plausible regression lines for that individual now include lines that increase as a function of days of sleep deprivation, and indeed the expected regression line for this individual is nearly a flat line.</p>
<p>In the next sections, we‚Äôll apply this method of obtaining regression line confidence intervals for multilevel models estimated with Bayesian methods.</p>
</section>
</section>
<section id="intervals-from-bayesian-models" class="level2">
<h2 class="anchored" data-anchor-id="intervals-from-bayesian-models">Intervals from Bayesian models</h2>
<p>Confidence intervals are commonly called credible intervals in the Bayesian context, but I‚Äôll use these terms interchangeably. The reader should be aware that, unlike traditional confidence intervals, credible intervals actually allow statements about credibility. In fact, being allowed to say the things we usually mean when discussing confidence intervals is one of many good reasons for applying bayesian statistics.</p>
<p>I use brms to specify the model and sample from the posterior distribution.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/fit_brms_ce72a9721a15de316778223bafa3e38d">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">brmfit <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">brm</span>(</span>
<span id="cb11-2">  <span class="at" style="color: #657422;">data =</span> sleepstudy,</span>
<span id="cb11-3">  Reaction <span class="sc" style="color: #5E5E5E;">~</span> Days <span class="sc" style="color: #5E5E5E;">+</span> (Days <span class="sc" style="color: #5E5E5E;">|</span> Subject),</span>
<span id="cb11-4">  <span class="at" style="color: #657422;">family =</span> gaussian,</span>
<span id="cb11-5">  <span class="at" style="color: #657422;">iter =</span> <span class="dv" style="color: #AD0000;">2000</span>,</span>
<span id="cb11-6">  <span class="at" style="color: #657422;">chains =</span> <span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb11-7">  <span class="at" style="color: #657422;">file =</span> <span class="st" style="color: #20794D;">"sleepstudy"</span></span>
<span id="cb11-8">)</span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/printbrmfit_545a213d0e691b63d585a7677a1ed8dd">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Bayesian model estimates (brms)</caption>
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Est.Error </th>
   <th style="text-align:right;"> l-95% CI </th>
   <th style="text-align:right;"> u-95% CI </th>
   <th style="text-align:right;"> Tail_ESS </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Intercept </td>
   <td style="text-align:right;"> 250.96 </td>
   <td style="text-align:right;"> 7.64 </td>
   <td style="text-align:right;"> 235.59 </td>
   <td style="text-align:right;"> 265.13 </td>
   <td style="text-align:right;"> 1558.74 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Days </td>
   <td style="text-align:right;"> 10.46 </td>
   <td style="text-align:right;"> 1.86 </td>
   <td style="text-align:right;"> 7.07 </td>
   <td style="text-align:right;"> 13.95 </td>
   <td style="text-align:right;"> 1391.49 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sd(Intercept) </td>
   <td style="text-align:right;"> 26.82 </td>
   <td style="text-align:right;"> 7.16 </td>
   <td style="text-align:right;"> 15.29 </td>
   <td style="text-align:right;"> 42.38 </td>
   <td style="text-align:right;"> 1715.64 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sd(Days) </td>
   <td style="text-align:right;"> 6.61 </td>
   <td style="text-align:right;"> 1.57 </td>
   <td style="text-align:right;"> 4.19 </td>
   <td style="text-align:right;"> 10.16 </td>
   <td style="text-align:right;"> 1609.65 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> cor(Intercept,Days) </td>
   <td style="text-align:right;"> 0.10 </td>
   <td style="text-align:right;"> 0.30 </td>
   <td style="text-align:right;"> -0.46 </td>
   <td style="text-align:right;"> 0.70 </td>
   <td style="text-align:right;"> 1674.70 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Note that now we also have values for the uncertainties associated with the varying effect parameters, without additional code.</p>
<section id="average-regression-line-ci" class="level4">
<h4 class="anchored" data-anchor-id="average-regression-line-ci">Average regression line &amp; CI</h4>
<p>brms has a function for obtaining fitted values (<code>fitted()</code>) and their associated upper and lower bounds, which together constitute the regression line and its confidence interval.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plot_brm_avg_84f4a41bc5a44ff1852d725af2df4164">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">newavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">Days =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>)</span>
<span id="cb12-2">fitavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">cbind</span>(</span>
<span id="cb12-3">  newavg, </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;">fitted</span>(brmfit, <span class="at" style="color: #657422;">newdata =</span> newavg, <span class="at" style="color: #657422;">re_formula =</span> <span class="cn" style="color: #8f5902;">NA</span>)[, <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>]</span>
<span id="cb12-5">  )</span>
<span id="cb12-6">p3 <span class="ot" style="color: #003B4F;">&lt;-</span> p1 <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb12-7">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> fitavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Estimate), <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb12-8">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> fitavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Q2<span class="fl" style="color: #AD0000;">.5</span>), <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb12-9">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> fitavg, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Q97<span class="fl" style="color: #AD0000;">.5</span>), <span class="at" style="color: #657422;">col =</span> <span class="st" style="color: #20794D;">"black"</span>, <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>)</span>
<span id="cb12-10">p3</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plot_brm_avg-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The average effects‚Äô estimates in this model have higher uncertainty than in the <code>lmerfit</code> model above, explaining why the average regression line‚Äôs CI is also wider.</p>
</section>
<section id="alternative-to-cis" class="level4">
<h4 class="anchored" data-anchor-id="alternative-to-cis">Alternative to CIs</h4>
<p>Instead of showing summaries of the samples from the posterior distribution, one could also plot the entire distribution‚Äìat the risk of overplotting. Overplotting can be avoided by adjusting each regression line‚Äôs transparency with the <code>alpha</code> parameter, resulting in a visually attractive‚Äìmaybe?‚Äìdisplay of the uncertainty in the regression line:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_fd71379dca8887cc23ba29c07cc664ec">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">pst <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">posterior_samples</span>(brmfit, <span class="st" style="color: #20794D;">"b"</span>)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;">ggplot</span>(sleepstudy, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> Days, <span class="at" style="color: #657422;">y =</span> Reaction)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;">geom_point</span>(<span class="at" style="color: #657422;">shape =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;">geom_abline</span>(</span>
<span id="cb13-5">    <span class="at" style="color: #657422;">data =</span> pst, <span class="at" style="color: #657422;">alpha =</span> .<span class="dv" style="color: #AD0000;">01</span>, <span class="at" style="color: #657422;">size =</span> .<span class="dv" style="color: #AD0000;">4</span>,</span>
<span id="cb13-6">    <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">intercept =</span> b_Intercept, <span class="at" style="color: #657422;">slope =</span> b_Days)</span>
<span id="cb13-7">  )</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="varying-regression-lines-cis" class="level4">
<h4 class="anchored" data-anchor-id="varying-regression-lines-cis">Varying regression lines &amp; CIs</h4>
<p>The best part is, brms‚Äô <code>fitted()</code> also gives regression lines with CIs at the individual level.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/plot_brm_vary_eb6ff23721ab439beb9e0fa6a059b3e5">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">X <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">cbind</span>(sleepstudy[, <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">3</span>], <span class="fu" style="color: #4758AB;">fitted</span>(brmfit)[, <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>]) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">as_tibble</span>()</span>
<span id="cb14-2">p2 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> X, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Estimate), <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> X, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Q2<span class="fl" style="color: #AD0000;">.5</span>), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> X, <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">y =</span> Q97<span class="fl" style="color: #AD0000;">.5</span>), <span class="at" style="color: #657422;">lty =</span> <span class="dv" style="color: #AD0000;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/plot_brm_vary-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Working with brms makes it very easy to obtain CIs for regression lines at both levels of analysis.</p>
</section>
<section id="an-alternative-visualization" class="level3">
<h3 class="anchored" data-anchor-id="an-alternative-visualization">An alternative visualization</h3>
<p>It might be useful, especially for model checking purposes, to display not only the fitted values, but also what the model predicts. To display the 95% prediction interval, I use the same procedure, but replace <code>fitted()</code> with <code>predict()</code>:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_1abd26b1524d35921cf63bc6d8858e52">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">newavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">Days =</span> <span class="dv" style="color: #AD0000;">0</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">9</span>)</span>
<span id="cb15-2">predavg <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">cbind</span>(</span>
<span id="cb15-3">  newavg, </span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;">predict</span>(brmfit, <span class="at" style="color: #657422;">newdata =</span> newavg, <span class="at" style="color: #657422;">re_formula =</span> <span class="cn" style="color: #8f5902;">NA</span>)[, <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">2</span>]</span>
<span id="cb15-5">  )</span>
<span id="cb15-6"><span class="fu" style="color: #4758AB;">names</span>(predavg) <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"Days"</span>, <span class="st" style="color: #20794D;">"Reaction"</span>, <span class="st" style="color: #20794D;">"lower"</span>, <span class="st" style="color: #20794D;">"upper"</span>)</span>
<span id="cb15-7">p3 <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">geom_ribbon</span>(</span>
<span id="cb15-8">  <span class="at" style="color: #657422;">data =</span> predavg, </span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">ymin =</span> lower, <span class="at" style="color: #657422;">ymax =</span> upper),</span>
<span id="cb15-10">  <span class="at" style="color: #657422;">col =</span> <span class="cn" style="color: #8f5902;">NA</span>, <span class="at" style="color: #657422;">alpha =</span> .<span class="dv" style="color: #AD0000;">2</span></span>
<span id="cb15-11">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="one-liners" class="level3">
<h3 class="anchored" data-anchor-id="one-liners">One-liners</h3>
<p>brms also has a function <code>conditional_effects()</code> that makes drawing these plots easy. Here is how to draw the average effect (first), and subject-specific effects (latter).</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_a9762d5baf5fcb0084d4494d9ecdc556">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;">conditional_effects</span>(brmfit)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;">conditional_effects</span>(</span>
<span id="cb17-2">  brmfit, </span>
<span id="cb17-3">  <span class="at" style="color: #657422;">conditions =</span> <span class="fu" style="color: #4758AB;">distinct</span>(sleepstudy, Subject), </span>
<span id="cb17-4">  <span class="at" style="color: #657422;">re_formula =</span> <span class="cn" style="color: #8f5902;">NULL</span></span>
<span id="cb17-5">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Working with a matrix of plausible parameter values makes it easier to draw regression lines with confidence intervals. Specifically, the brms package provides easy access to CIs in a multilevel modeling context.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bolgerIntensiveLongitudinalMethods2013" class="csl-entry">
Bolger, Niall, and Jean-Philippe Laurenceau. 2013. <em>Intensive <span>Longitudinal Methods</span>: <span>An Introduction</span> to <span>Diary</span> and <span>Experience Sampling Research</span></em>. <span>New York, NY</span>: <span>Guilford Press</span>. <a href="https://www.intensivelongitudinal.com">https://www.intensivelongitudinal.com</a>.
</div>
<div id="ref-gelmanDataAnalysisUsing2007" class="csl-entry">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data <span>Analysis Using Regression</span> and <span>Multilevel</span>/<span>Hierarchical Models</span></em>. <span>New York, NY</span>: <span>Cambridge University Press</span>. <a href="http://www.stat.columbia.edu/~gelman/arm/">http://www.stat.columbia.edu/~gelman/arm/</a>.
</div>
<div id="ref-korner-nievergeltBayesianDataAnalysis2015" class="csl-entry">
Korner-Nievergelt, Franzi, Tobias Roth, Stefanie von Felten, J√©r√¥me Gu√©lat, Bettina Almasi, and Pius Korner-Nievergelt. 2015. <em>Bayesian <span>Data Analysis</span> in <span>Ecology Using Linear Models</span> with <span>R</span>, <span>BUGS</span>, and <span>Stan</span></em>. <span>Elsevier Science</span>. <a href="https://www.elsevier.com/books/bayesian-data-analysis-in-ecology-using-linear-models-with-r-bugs-and-stan/korner-nievergelt/978-0-12-801370-0">https://www.elsevier.com/books/bayesian-data-analysis-in-ecology-using-linear-models-with-r-bugs-and-stan/korner-nievergelt/978-0-12-801370-0</a>.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{vuorre2016,
  author = {Matti Vuorre},
  title = {Confidence Intervals in Multilevel Models},
  date = {2016-03-06},
  url = {https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vuorre2016" class="csl-entry quarto-appendix-citeas">
Matti Vuorre. 2016. <span>‚ÄúConfidence Intervals in Multilevel
Models.‚Äù</span> March 6, 2016. <a href="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions">https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions</a>.
</div></div></section></div> ]]></description>
  <category>statistics</category>
  <category>R</category>
  <category>brms</category>
  <category>tutorial</category>
  <guid>https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index.html</guid>
  <pubDate>Sun, 06 Mar 2016 00:00:00 GMT</pubDate>
  <media:content url="https://vuorre.netlify.app/posts/2016-03-06-multilevel-predictions/index_files/figure-html/fig1and2-1.png" medium="image" type="image/png" height="103" width="144"/>
</item>
</channel>
</rss>
